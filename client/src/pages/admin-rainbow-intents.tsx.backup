import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { Loader2, RefreshCw, MessageSquare, CheckCircle2, XCircle } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

interface IntentCategory {
  category: string;
  patterns: string[];
  flags: string;
  enabled: boolean;
}

interface IntentsConfig {
  categories: IntentCategory[];
}

export default function AdminRainbowIntents() {
  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Fetch intents configuration
  const { data: intentsConfig, isLoading, error } = useQuery<IntentsConfig>({
    queryKey: ['/api/admin/rainbow/intents'],
  });

  // Toggle intent enabled/disabled
  const toggleIntentMutation = useMutation({
    mutationFn: async ({ category, enabled }: { category: string; enabled: boolean }) => {
      const response = await fetch('/api/admin/rainbow/intents/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ category, enabled }),
      });

      if (!response.ok) {
        throw new Error('Failed to toggle intent');
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/admin/rainbow/intents'] });
      toast({
        title: "Intent Updated",
        description: "Intent status has been updated successfully.",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Get category display name
  const getCategoryDisplayName = (category: string) => {
    return category
      .split('_')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  };

  // Get category color based on type
  const getCategoryColor = (category: string) => {
    const colorMap: Record<string, string> = {
      greeting: "bg-blue-100 text-blue-800 border-blue-200",
      thanks: "bg-green-100 text-green-800 border-green-200",
      wifi: "bg-purple-100 text-purple-800 border-purple-200",
      directions: "bg-yellow-100 text-yellow-800 border-yellow-200",
      checkin_info: "bg-indigo-100 text-indigo-800 border-indigo-200",
      checkout_info: "bg-pink-100 text-pink-800 border-pink-200",
      pricing: "bg-orange-100 text-orange-800 border-orange-200",
      availability: "bg-teal-100 text-teal-800 border-teal-200",
      booking: "bg-cyan-100 text-cyan-800 border-cyan-200",
      complaint: "bg-red-100 text-red-800 border-red-200",
      contact_staff: "bg-violet-100 text-violet-800 border-violet-200",
      facilities: "bg-emerald-100 text-emerald-800 border-emerald-200",
      rules: "bg-amber-100 text-amber-800 border-amber-200",
      payment: "bg-lime-100 text-lime-800 border-lime-200",
    };
    return colorMap[category] || "bg-gray-100 text-gray-800 border-gray-200";
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[400px] space-y-4">
        <XCircle className="h-12 w-12 text-destructive" />
        <p className="text-lg font-medium">Failed to load intents configuration</p>
        <Button onClick={() => queryClient.invalidateQueries({ queryKey: ['/api/admin/rainbow/intents'] })}>
          <RefreshCw className="mr-2 h-4 w-4" />
          Retry
        </Button>
      </div>
    );
  }

  const enabledCount = intentsConfig?.categories.filter(cat => cat.enabled).length || 0;
  const totalCount = intentsConfig?.categories.length || 0;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
            <MessageSquare className="h-8 w-8" />
            Rainbow Intents Manager
          </h1>
          <p className="text-muted-foreground mt-1">
            Configure and manage AI assistant intent recognition patterns
          </p>
        </div>
        <Button
          variant="outline"
          onClick={() => queryClient.invalidateQueries({ queryKey: ['/api/admin/rainbow/intents'] })}
        >
          <RefreshCw className="mr-2 h-4 w-4" />
          Refresh
        </Button>
      </div>

      {/* Stats Card */}
      <Card>
        <CardHeader>
          <CardTitle>Intent Statistics</CardTitle>
          <CardDescription>Overview of configured intent categories</CardDescription>
        </CardHeader>
        <CardContent className="flex items-center gap-6">
          <div className="flex items-center gap-2">
            <CheckCircle2 className="h-5 w-5 text-green-600" />
            <span className="text-2xl font-bold">{enabledCount}</span>
            <span className="text-muted-foreground">Enabled</span>
          </div>
          <div className="flex items-center gap-2">
            <XCircle className="h-5 w-5 text-gray-400" />
            <span className="text-2xl font-bold">{totalCount - enabledCount}</span>
            <span className="text-muted-foreground">Disabled</span>
          </div>
          <div className="flex items-center gap-2">
            <MessageSquare className="h-5 w-5 text-blue-600" />
            <span className="text-2xl font-bold">{totalCount}</span>
            <span className="text-muted-foreground">Total</span>
          </div>
        </CardContent>
      </Card>

      {/* Intent Categories Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {intentsConfig?.categories.map((intent) => (
          <Card key={intent.category} className="hover:shadow-md transition-shadow">
            <CardHeader className="pb-3">
              <div className="flex items-start justify-between">
                <div className="space-y-1 flex-1">
                  <CardTitle className="text-lg">
                    {getCategoryDisplayName(intent.category)}
                  </CardTitle>
                  <Badge className={getCategoryColor(intent.category)} variant="outline">
                    {intent.category}
                  </Badge>
                </div>
                <div className="flex items-center space-x-2">
                  <Switch
                    id={`intent-${intent.category}`}
                    checked={intent.enabled}
                    onCheckedChange={(checked) => {
                      toggleIntentMutation.mutate({
                        category: intent.category,
                        enabled: checked,
                      });
                    }}
                  />
                  <Label
                    htmlFor={`intent-${intent.category}`}
                    className="text-xs text-muted-foreground cursor-pointer"
                  >
                    {intent.enabled ? 'On' : 'Off'}
                  </Label>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                <p className="text-xs text-muted-foreground font-medium">Patterns:</p>
                <div className="space-y-1 max-h-32 overflow-y-auto">
                  {intent.patterns.map((pattern, idx) => (
                    <code
                      key={idx}
                      className="block text-xs bg-muted p-2 rounded font-mono truncate"
                      title={pattern}
                    >
                      {pattern}
                    </code>
                  ))}
                </div>
                <div className="flex items-center gap-2 pt-2">
                  <Badge variant="secondary" className="text-xs">
                    {intent.patterns.length} pattern{intent.patterns.length !== 1 ? 's' : ''}
                  </Badge>
                  {intent.flags && (
                    <Badge variant="secondary" className="text-xs">
                      flags: {intent.flags}
                    </Badge>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* Info Card */}
      <Card className="bg-blue-50 border-blue-200">
        <CardHeader>
          <CardTitle className="text-blue-900">About Intent Recognition</CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-blue-800">
          <p>
            Intent categories help the AI assistant understand and categorize user messages.
            Each category contains regex patterns that match common phrases and keywords.
            Disable categories that are not relevant to your use case.
          </p>
        </CardContent>
      </Card>
    </div>
  );
}
