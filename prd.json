{
  "productName": "Rainbow AI Test Fixes v2",
  "branchName": "fix/rainbow-test-171-failures",
  "overview": "Fix all 9 failing Rainbow AI test scenarios from the 171-scenario test suite. Root causes: intent keyword gaps, KB content gaps, validation rules too narrow, workflow context loss. Target: 0 failures.",
  "goals": [
    "Fix all 9 failing test scenarios to achieve 0 failures",
    "Improve intent classification for transport, local services, and accessibility queries",
    "Enrich KB and static reply content for directions and check-in info",
    "Harden multi-turn workflow context for corrections and emergency continuation",
    "Maintain all 162 currently passing tests (no regressions)"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix directions response to include transport info",
      "priority": 1,
      "description": "When guests ask how to get to the hostel from the airport (in any language), the response gives a generic address/Google Maps link but no transport info. The KB file .rainbow-kb/location.md already has transport details but they are not surfaced in the static reply. Fix the directions response template AND ensure KB content is loaded. This fixes tests ml-malay-directions and transport-from-airport.",
      "acceptanceCriteria": [
        "The directions static reply response includes transport options (Grab, taxi, driving time from Senai airport)",
        "Response contains at least one of: Grab, taxi, airport, drive, minute, direction",
        "Test ml-malay-directions passes (Macam mana nak sampai dari airport?)",
        "Test transport-from-airport passes (How do I get to the hostel from Senai airport?)",
        "Existing directions tests still pass"
      ],
      "technicalNotes": [
        "Check RainbowAI/src/assistant/data/routing.json \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d the directions intent response template. Update the static reply text to include transport options.",
        "Check .rainbow-kb/location.md \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d it already has transport details (Grab, taxi, shuttle). Ensure the static reply includes key transport info.",
        "Add airport-related keywords to directions intent in intent-keywords.json if missing.",
        "The response is likely generated by LLM+KB \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d make sure guessTopicFiles() loads location.md for transport queries."
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Fix check-in info to mention passport/IC requirements",
      "priority": 2,
      "description": "When a guest asks 'Do I need to show my passport or IC to check in?', the system classifies it as checkin_info but the static reply only mentions times, WiFi, and address \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d no document requirements. Update the checkin_info response and KB to include passport/IC info. Fixes test ci-suite-passport-request.",
      "acceptanceCriteria": [
        "The checkin_info static reply mentions passport, IC, or identification documents",
        "Response contains at least one of: passport, IC, identity, document, identification",
        "Test ci-suite-passport-request passes",
        "Existing checkin_info tests still pass"
      ],
      "technicalNotes": [
        "Check RainbowAI/src/assistant/data/routing.json \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d find the checkin_info response template and add document requirement info.",
        "The current response includes: check-in time (2PM), check-out time (12PM), door password, WiFi, address. Add: 'Please prepare your passport or IC for identity verification.'",
        "Also check .rainbow-kb/ for any check-in related KB file and update it."
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Handle extend stay separately from new booking",
      "priority": 3,
      "description": "When a guest says 'I want to extend my stay for 2 more nights', the system classifies it as booking and starts a new booking workflow asking 'How many guests?' \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d which is wrong. The system should recognize extend/extension requests and respond with availability check + staff contact. Fixes test booking-extend-stay.",
      "acceptanceCriteria": [
        "Add keywords for extend/extension to intent-keywords.json",
        "Route extend_stay intent to static_reply or llm_reply (not workflow)",
        "Response contains at least one of: extend, availability, staff, night, check, extra",
        "Test booking-extend-stay passes (I want to extend my stay for 2 more nights)",
        "Existing booking tests still pass"
      ],
      "technicalNotes": [
        "Option A (recommended): Add new intent extend_stay in intent-keywords.json with keywords: extend, extend stay, extra night, extra nights, stay longer, prolong, tambah malam, lanjutkan. Route to static_reply in routing.json with response directing to staff.",
        "Option B: Add extend keywords to booking intent but use mapLLMIntentToSpecific in intents.ts to detect extend context and reroute.",
        "Make sure the Fuse.js matcher can match \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d add long-form variants (4+ words, 18+ chars) for substring matching.",
        "Update routing.json to add routing for the new intent."
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Add local services intent for ATM/money changer queries",
      "priority": 4,
      "description": "When a guest asks 'Where is the nearest ATM or money changer?', the system misclassifies it as directions and gives the hostel address. Add a new local_services intent to handle nearby amenity queries (ATM, money changer, bank, etc.). Fixes test local-atm-money.",
      "acceptanceCriteria": [
        "New intent local_services exists in intent-keywords.json with keywords: ATM, money changer, bank nearby, convenience store, laundry nearby, pharmacy, kedai, tukar wang",
        "Routing entry in routing.json maps local_services to static_reply or llm_reply",
        "mapLLMIntentToSpecific in intents.ts handles local_services mapping from LLM responses",
        "Response contains at least one of: ATM, bank, money, nearby, changer, cash",
        "Test local-atm-money passes",
        "Existing tests still pass"
      ],
      "technicalNotes": [
        "Add local_services intent to intent-keywords.json with multi-language keywords (en/ms/zh).",
        "Add routing in routing.json \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d use llm_reply action so LLM can generate helpful local info from KB.",
        "Update .rainbow-kb/location.md nearby services section if it exists, or add one.",
        "Update mapLLMIntentToSpecific in intents.ts to map generic 'local' or 'nearby' LLM intents to local_services."
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Handle accessibility queries specifically",
      "priority": 5,
      "description": "When a guest asks 'Is the hostel wheelchair accessible?', the system classifies it as facilities_info and gives a generic facilities list without addressing accessibility. Add accessibility handling so the system gives a specific, helpful response. Fixes test access-wheelchair.",
      "acceptanceCriteria": [
        "Add accessibility-related keywords to intent-keywords.json",
        "Response contains at least one of: wheelchair, access, staff, contact, accommodate, help",
        "mapLLMIntentToSpecific detects accessibility context in facilities queries",
        "Test access-wheelchair passes",
        "Existing facilities tests still pass"
      ],
      "technicalNotes": [
        "Option A: Add new accessibility intent with keywords: wheelchair, accessible, disability, mobility, OKU, kerusi roda. Route to llm_reply so LLM can generate helpful response.",
        "Option B: Add keywords to facilities_info but use mapLLMIntentToSpecific to detect wheelchair/accessibility context and override the response.",
        "Add accessibility info to .rainbow-kb/facilities.md \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d honest info about capsule hostel accessibility limitations (stairs, capsule entry, etc.) and staff assistance.",
        "Use long-form keyword variants for Fuse.js substring matching."
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-006",
      "title": "Fix noise complaint follow-up validation and response",
      "priority": 6,
      "description": "The mt-noise-followup test turn 2 response correctly escalates to management (+60127088789) but the validation keywords [staff, send, address, quiet, sorry] are too narrow. Fix BOTH: widen validation keywords AND improve escalation response to include 'staff'. Fixes test mt-noise-followup.",
      "acceptanceCriteria": [
        "Widen validation for mt-noise-followup turn 2 to accept: staff, send, address, quiet, sorry, management, escalat, priority, team",
        "Update escalation response template in templates.json to include 'staff' or 'sorry' in the wording",
        "Test mt-noise-followup passes (3-turn noise complaint)",
        "Existing noise and escalation tests still pass"
      ],
      "technicalNotes": [
        "Edit RainbowAI/src/public/js/modules/autotest-scenarios-workflow.js \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d find mt-noise-followup scenario, turn 2 validation. Add management, escalat, priority, team to the contains_any values array.",
        "Edit RainbowAI/src/assistant/data/templates.json \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d find the escalating template. Current text likely says 'management team at +phone'. Add 'staff' or 'Our staff' to the template.",
        "Be careful to test both the validation fix AND the template change."
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-007",
      "title": "Fix booking workflow to handle mid-flow corrections",
      "priority": 7,
      "description": "When a guest corrects information mid-booking-workflow (e.g., 'Actually 3 guests not 2'), the workflow jumps to payment step without acknowledging the correction. Fix both the router (detect correction language) and the executor (update collected data). Fixes test mt-correction-mid-flow.",
      "acceptanceCriteria": [
        "message-router.ts detects correction language (actually, sorry I meant, not X but Y) during active booking workflow",
        "workflow-executor.ts updates collected data when correction is detected and acknowledges it",
        "Response at turn 2 contains at least one of: 3, guest, update, note, correct",
        "Test mt-correction-mid-flow passes (3-turn booking with correction at turn 2)",
        "Existing booking workflow tests still pass"
      ],
      "technicalNotes": [
        "In message-router.ts: before re-classifying intent during active workflow, check if the message contains correction patterns: /actually|sorry.*meant|not \\d+.*but \\d+|I meant|correction|change.*to/i",
        "If correction detected AND workflow is active: pass the message to workflow-executor with a 'correction' flag instead of re-classifying.",
        "In workflow-executor.ts: when correction flag is set, parse the new data (e.g., extract number '3' from 'actually 3 guests'), update collectedData, and respond with acknowledgment like 'Updated to 3 guests. [continue workflow step]'.",
        "This is the hardest story \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d may need careful regex and workflow state handling."
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-008",
      "title": "Fix emergency workflow continuation across turns",
      "priority": 8,
      "description": "When a medical emergency is reported across 3 turns, turn 2 ('He is breathing but unconscious') gets reclassified as general_complaint_in_stay instead of continuing the emergency context. Fix the router to preserve emergency workflow context AND expand emergency keyword patterns. Fixes test workflow-medical-emergency.",
      "acceptanceCriteria": [
        "message-router.ts preserves emergency workflow context \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d when active workflow is emergency-type, prevent re-classification",
        "Emergency regex patterns in intents.ts getEmergencyIntent() include medical terms: collapsed, unconscious, breathing, ambulance, dizzy, fainted, not responding, seizure",
        "workflow-executor.ts handles emergency continuation with appropriate responses",
        "Turn 2 response contains at least one of: ambulance, staff, help, medical, coming, way",
        "Test workflow-medical-emergency passes (3-turn medical emergency)",
        "Existing emergency tests (theft, card locked) still pass"
      ],
      "technicalNotes": [
        "In message-router.ts: check if the current active workflow is an emergency type (theft_report, medical_emergency, etc.). If so, do NOT re-classify the intent \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d continue the workflow.",
        "In intents.ts getEmergencyIntent(): add medical emergency regex patterns. Currently has fire, ambulance, theft, assault, police, locked card. Add: collapsed, unconscious, breathing, not responding, seizure, fainted, medical emergency, heart attack.",
        "In workflow-executor.ts: handle the medical emergency workflow continuation \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d collect details (location, condition) and escalate with URGENT status including medical keywords.",
        "Check if a medical_emergency workflow definition exists or if one needs to be created.",
        "The shouldEscapeWorkflow logic must NOT escape during active emergency workflows."
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-009",
      "title": "Run full regression test suite and verify zero failures",
      "priority": 9,
      "description": "After all fixes are applied, run the full 171-scenario test suite and confirm zero failures. If any tests fail, identify and fix remaining issues. Repeat until 0 failures.",
      "acceptanceCriteria": [
        "Rainbow AI server is running on port 3002",
        "Run: node RainbowAI/scripts/run-tests-desktop-report.js --concurrency=1",
        "All 171 scenarios pass (0 failures)",
        "Desktop error report at ~/Desktop/rainbow-test-errors.txt shows ALL TESTS PASSED",
        "If any tests still fail, diagnose and fix the remaining issues then re-run"
      ],
      "technicalNotes": [
        "IMPORTANT: The server MUST be running before running tests. Start with: cd RainbowAI && npm run dev",
        "Wait for server health check: curl http://localhost:3002/health",
        "Run tests: node RainbowAI/scripts/run-tests-desktop-report.js --concurrency=1",
        "Check the desktop report at C:/Users/Jyue/Desktop/rainbow-test-errors.txt",
        "If failures remain, read the error report, identify root cause, fix, and re-run.",
        "The test runner exits with code 1 when there are failures \u00c3\u00a2\u00e2\u201a\u00ac\u00e2\u20ac\udc9d this is expected.",
        "Always use --concurrency=1 for reliable results (concurrency=2+ causes rate limit failures)."
      ],
      "dependencies": [
        "US-001",
        "US-002",
        "US-003",
        "US-004",
        "US-005",
        "US-006",
        "US-007",
        "US-008"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    }
  ]
}