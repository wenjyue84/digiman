{
  "productName": "Multi-Business Deployment ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d Southern Homestay",
  "branchName": "feature/multi-business",
  "overview": "Transform PelangiManager from a single-business capsule hostel system into a multi-business platform. Rename capsules schema to generic units (with unitType, maxOccupancy, pricePerNight columns), add env-var-driven business config, parameterize deployment, and set up Southern Homestay on its own Lightsail/Neon/Cloudflare/WhatsApp infrastructure.",
  "goals": [
    "One codebase serves multiple accommodation businesses (capsule hostels, homestays, hotels)",
    "Each business runs on its own Lightsail instance with its own Neon database ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d complete data isolation",
    "All business differentiation is driven by environment variables (zero code forks)",
    "Existing Pelangi Capsule Hostel deployment continues working unchanged (backward compatible)",
    "Southern Homestay is fully operational: management dashboard, Rainbow AI WhatsApp bot, Cloudflare HTTPS"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Rename capsules table to units in schema definitions",
      "priority": 1,
      "description": "As a developer, I want the database schema to use generic 'units' naming instead of 'capsules' so that the same codebase works for any accommodation type.",
      "acceptanceCriteria": [
        "shared/schema-tables.ts: capsules pgTable renamed to units (DB table name: 'units')",
        "shared/schema-tables.ts: capsuleProblems renamed to unitProblems (DB: 'unit_problems')",
        "guests.capsuleNumber renamed to guests.unitNumber (DB: 'unit_number')",
        "guestTokens.capsuleNumber renamed to guestTokens.unitNumber",
        "adminNotifications.capsuleNumber renamed to adminNotifications.unitNumber",
        "Exported types renamed: Capsule -> Unit, CapsuleProblem -> UnitProblem, InsertCapsuleProblem -> InsertUnitProblem",
        "Temporary backward-compat aliases added: export type Capsule = Unit (with @deprecated JSDoc)",
        "All index definitions updated to reference new table/column names",
        "TypeScript compiles with zero errors (npm run check)"
      ],
      "technicalNotes": [
        "File: shared/schema-tables.ts ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d this is the foundational change, everything else depends on it",
        "Keep DB column snake_case: unit_number, unit_type, max_occupancy, price_per_night",
        "Drizzle JS variable names use camelCase: unitNumber, unitType, maxOccupancy, pricePerNight",
        "After this change, TypeScript will show errors in ~100 files ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d that's expected and guides the remaining stories"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Add unit type columns for multi-accommodation support",
      "priority": 2,
      "description": "As a property manager, I want each unit to optionally store its type, max occupancy, and price so that I can manage different house sizes (studio, 1BR, 2BR).",
      "acceptanceCriteria": [
        "units table has new nullable column: unitType: text('unit_type') ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d stores 'studio', '1bedroom', '2bedroom', or null for capsules",
        "units table has new nullable column: maxOccupancy: integer('max_occupancy') ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d max guests per unit",
        "units table has new nullable column: pricePerNight: text('price_per_night') ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d base price as decimal string",
        "Existing Pelangi capsule data works unchanged (all new columns are null)",
        "TypeScript Unit type includes the three new fields",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: shared/schema-tables.ts ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d add columns to the units table (renamed in US-001)",
        "All columns nullable so capsule hostels don't need them",
        "pricePerNight is text not numeric to avoid floating point precision issues (same pattern as paymentAmount in guests)"
      ],
      "dependencies": [
        "US-001"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Update validation schemas for units",
      "priority": 3,
      "description": "As a developer, I want validation schemas to match the renamed schema so that API input validation works correctly.",
      "acceptanceCriteria": [
        "shared/validation/capsule-validation.ts renamed to unit-validation.ts",
        "Exports renamed: insertCapsuleSchema -> insertUnitSchema, updateCapsuleSchema -> updateUnitSchema",
        "New columns added to schemas: unitType (optional enum), maxOccupancy (optional int >=1), pricePerNight (optional string)",
        "shared/validation/index.ts re-exports updated",
        "guest-validation.ts: capsule filter key -> unit",
        "token-validation.ts: capsuleNumber -> unitNumber",
        "settings-validation.ts: capsule-related defaults reference updated",
        "shared/validation-patterns.ts: CAPSULE_FORMAT_REGEX -> UNIT_FORMAT_REGEX",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "Files: shared/validation/capsule-validation.ts (rename), shared/validation/index.ts, guest-validation.ts, token-validation.ts, settings-validation.ts, shared/validation-patterns.ts",
        "Use git mv for file renames to preserve history",
        "unitType enum values: 'studio', '1bedroom', '2bedroom', '3bedroom' ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d keep extensible"
      ],
      "dependencies": [
        "US-001",
        "US-002"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Rename storage interface and DB implementation",
      "priority": 4,
      "description": "As a developer, I want the storage layer to use 'unit' naming so that the entire server codebase is consistent.",
      "acceptanceCriteria": [
        "server/Storage/IStorage.ts: ICapsuleStorage -> IUnitStorage; all methods renamed (getAllCapsules -> getAllUnits, getCapsule -> getUnit, createCapsule -> createUnit, updateCapsule -> updateUnit, deleteCapsule -> deleteUnit, markCapsuleCleaned -> markUnitCleaned, markCapsuleNeedsCleaning -> markUnitNeedsCleaning, getCapsulesByCleaningStatus -> getUnitsByCleaningStatus, getAvailableCapsules -> getAvailableUnits, getGuestsByCapsule -> getGuestsByUnit)",
        "server/Storage/db/DbCapsuleQueries.ts renamed to DbUnitQueries.ts with all Drizzle queries updated",
        "server/Storage/db/DbGuestQueries.ts: capsuleNumber -> unitNumber column references",
        "server/Storage/db/DbProblemQueries.ts: same column renames",
        "server/Storage/db/DbTokenQueries.ts: same column renames",
        "server/Storage/DatabaseStorage.ts: all delegations reference new method names",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "Files: server/Storage/IStorage.ts, server/Storage/db/DbCapsuleQueries.ts (rename), DbGuestQueries.ts, DbProblemQueries.ts, DbTokenQueries.ts, DatabaseStorage.ts",
        "Use git mv for file renames",
        "Drizzle queries: replace 'capsules' table import with 'units', replace eq(guests.capsuleNumber, ...) with eq(guests.unitNumber, ...)"
      ],
      "dependencies": [
        "US-003"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Rename memory storage implementation",
      "priority": 5,
      "description": "As a developer, I want the in-memory storage (used for dev/testing) updated to match the renamed interface.",
      "acceptanceCriteria": [
        "server/Storage/mem/MemCapsuleStore.ts renamed to MemUnitStore.ts with methods renamed",
        "server/Storage/mem/MemGuestStore.ts: capsuleNumber -> unitNumber references",
        "server/Storage/mem/MemProblemStore.ts: same renames",
        "server/Storage/mem/MemTokenStore.ts: same renames",
        "server/Storage/MemStorage.ts: property names and imports updated",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "Files: server/Storage/mem/MemCapsuleStore.ts (rename), MemGuestStore.ts, MemProblemStore.ts, MemTokenStore.ts, server/Storage/MemStorage.ts",
        "Mirror the interface changes from US-004 ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d same method names, same param types"
      ],
      "dependencies": [
        "US-004"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-006",
      "title": "Rename server API routes",
      "priority": 6,
      "description": "As a developer, I want API routes to use /api/units instead of /api/capsules so that the API reflects the generic model.",
      "acceptanceCriteria": [
        "server/routes/capsules.ts renamed to units.ts",
        "Route registration in server/routes/index.ts: /api/capsules -> /api/units",
        "All route handlers in units.ts call new storage method names",
        "server/routes/guests.ts: capsuleNumber -> unitNumber in request bodies, query params, responses",
        "server/routes/guest-tokens.ts: same renames",
        "server/routes/dashboard.ts: capsule references -> unit references",
        "server/routes/admin.ts: any capsule references updated",
        "TypeScript compiles with zero errors",
        "Server starts and GET /api/units/available returns correct data"
      ],
      "technicalNotes": [
        "Files: server/routes/capsules.ts (rename to units.ts), server/routes/index.ts, guests.ts, guest-tokens.ts, dashboard.ts, admin.ts",
        "Also check server/routes/objects.ts and server/routes/settings.ts for any capsule refs"
      ],
      "dependencies": [
        "US-005"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-007",
      "title": "Update server test files",
      "priority": 7,
      "description": "As a developer, I want all test files updated so that the automated test suite passes after the rename.",
      "acceptanceCriteria": [
        "server/routes/tests/capsule-tests.ts renamed to unit-tests.ts with all references updated",
        "server/routes/tests/guest-tests.ts: capsule references -> unit",
        "server/routes/tests/e2e-workflow-tests.ts: same",
        "server/routes/tests/system-validation-tests.ts: same",
        "server/routes/tests/data-integrity-tests.ts: same",
        "server/routes/tests/dashboard-tests.ts: same",
        "All tests pass (npm run test)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "Files: server/routes/tests/*.ts ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d all test files that reference capsule",
        "Test assertions may reference /api/capsules endpoints ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d update to /api/units",
        "Test data objects with capsuleNumber fields -> unitNumber"
      ],
      "dependencies": [
        "US-006"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-008",
      "title": "Rename client component files",
      "priority": 8,
      "description": "As a developer, I want client component files renamed from 'Capsule' to 'Unit' for consistency.",
      "acceptanceCriteria": [
        "client/src/components/capsule-cleaning-status.tsx -> unit-cleaning-status.tsx",
        "client/src/components/settings/CapsulesTab.tsx -> settings/UnitsTab.tsx",
        "client/src/components/check-in/CapsuleAssignmentSection.tsx -> check-in/UnitAssignmentSection.tsx",
        "client/src/components/guest-table/CapsuleSelector.tsx -> guest-table/UnitSelector.tsx",
        "All imports of these components updated in consuming files",
        "useAccommodationLabels() hook remains unchanged (already generic)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "Use git mv for file renames to preserve history",
        "Update all import statements in consuming files: grep for old filenames across client/src/",
        "Component function names inside files should also be renamed (e.g., CapsulesTab -> UnitsTab)"
      ],
      "dependencies": [
        "US-001"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-009",
      "title": "Update client pages, hooks, and utilities",
      "priority": 9,
      "description": "As a developer, I want all client code to use unitNumber and Unit type instead of capsuleNumber and Capsule.",
      "acceptanceCriteria": [
        "Pages updated: check-in.tsx, check-out.tsx, guest-checkin.tsx, guest-edit.tsx, maintenance-manage.tsx, cleaning.tsx, settings.tsx, history.tsx",
        "Hooks updated: useCheckInWizard.ts, useTokenValidation.ts, useSuccessPageValidation.ts, useConfig.ts",
        "Utils updated: queryConfig.ts (/api/capsules -> /api/units), receiptGenerator.ts, validation.ts",
        "All Capsule type imports -> Unit",
        "All capsuleNumber state/props -> unitNumber",
        "All /api/capsules fetch URLs -> /api/units",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: Check-in page loads, unit selector works, check-out page loads"
      ],
      "technicalNotes": [
        "Largest story in the rename ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d touches ~20+ client files",
        "Use IDE find-and-replace across client/src/ for: capsuleNumber -> unitNumber, Capsule -> Unit (as type), /api/capsules -> /api/units",
        "Be careful not to replace 'capsule' in useAccommodationLabels.ts ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d that file stays as-is",
        "Also update client/src/components/guest-table/ files (SwipeableGuestCard, etc.)"
      ],
      "dependencies": [
        "US-006",
        "US-008"
      ],
      "estimatedComplexity": "large",
      "passes": true
    },
    {
      "id": "US-010",
      "title": "Update i18n language files",
      "priority": 10,
      "description": "As a developer, I want translation files updated so that capsuleNumber keys become unitNumber.",
      "acceptanceCriteria": [
        "client/src/lib/i18n/en.json: all capsule/Capsule string keys and values updated",
        "client/src/lib/i18n/ms.json: same",
        "client/src/lib/i18n/zh-cn.json: same",
        "Any other language files (ja, ko, es) updated if they exist",
        "Display labels still come from useAccommodationLabels() hook (dynamic, not hardcoded in i18n)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "Files: client/src/lib/i18n/*.json",
        "Keys like capsuleNumber -> unitNumber; display text like 'Capsule Number' -> use labels from useAccommodationLabels() instead",
        "Some i18n values may reference 'capsule' in context ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d update to generic 'unit' where appropriate"
      ],
      "dependencies": [
        "US-009"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-011",
      "title": "Rename Rainbow AI capsule references",
      "priority": 11,
      "description": "As a developer, I want Rainbow AI code updated from 'capsule' to 'unit' naming for consistency.",
      "acceptanceCriteria": [
        "RainbowAI/src/lib/capsule-cache.ts -> unit-cache.ts with methods renamed",
        "RainbowAI/src/tools/capsules.ts -> tools/units.ts",
        "RainbowAI/src/tools/capsules-write.ts -> tools/units-write.ts",
        "RainbowAI/src/tools/dashboard.ts: capsule references -> unit",
        "RainbowAI/src/tools/analytics.ts: same",
        "RainbowAI/src/tools/guests.ts, guests-write.ts: same",
        "RainbowAI/src/lib/daily-report.ts: same",
        "RainbowAI/src/routes/admin/ files: capsule references -> unit",
        "Any workflow/assistant files referencing capsules updated",
        "Import boundary maintained: RainbowAI has ZERO imports from server/, client/, shared/",
        "TypeScript compiles with zero errors (cd RainbowAI && npx tsc --noEmit)"
      ],
      "technicalNotes": [
        "RainbowAI fetches data via HTTP from /api/units (was /api/capsules) ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d update all fetch URLs",
        "RainbowAI has its OWN types for capsule/unit data ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d not imported from shared/",
        "Also update tool descriptions that mention 'capsule' to say 'unit'",
        "Check RainbowAI/src/assistant/workflow-enhancer.ts and workflow-executor.ts for capsule refs"
      ],
      "dependencies": [
        "US-006"
      ],
      "estimatedComplexity": "medium",
      "passes": false
    },
    {
      "id": "US-012",
      "title": "Write production database migration SQL",
      "priority": 12,
      "description": "As an operator, I want a tested migration script so that Pelangi's production DB can be safely upgraded to the new schema.",
      "acceptanceCriteria": [
        "Migration file created at migrations/rename-capsules-to-units.sql",
        "Script includes: ALTER TABLE capsules RENAME TO units, ALTER TABLE capsule_problems RENAME TO unit_problems",
        "Script includes column renames: capsule_number -> unit_number in guests, guest_tokens, admin_notifications, unit_problems",
        "Script includes: ALTER TABLE units ADD COLUMN unit_type text, ADD COLUMN max_occupancy integer, ADD COLUMN price_per_night text",
        "Script includes index renames (all idx_capsules_* -> idx_units_*, idx_capsule_problems_* -> idx_unit_problems_*)",
        "Rollback script included at migrations/rollback-units-to-capsules.sql",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "New files: migrations/rename-capsules-to-units.sql, migrations/rollback-units-to-capsules.sql",
        "ALTER TABLE RENAME is metadata-only in PostgreSQL ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d instant, no data rewrite",
        "Index rename syntax: ALTER INDEX idx_capsules_is_available RENAME TO idx_units_is_available",
        "Test locally: create test DB, seed data, run migration, verify drizzle-kit push shows no changes needed"
      ],
      "dependencies": [
        "US-001",
        "US-002"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-013",
      "title": "Verify zero orphaned capsule references",
      "priority": 13,
      "description": "As a developer, I want to confirm no runtime code still references the old 'capsule' naming.",
      "acceptanceCriteria": [
        "grep -r 'capsule' --include='*.ts' --include='*.tsx' --include='*.js' server/ client/src/ shared/ RainbowAI/src/ returns ZERO hits (excluding: node_modules, dist, deprecated type aliases, migration SQL files, comments)",
        "grep -r '/api/capsules' client/src/ returns ZERO hits",
        "grep -r 'capsule_number' shared/ returns ZERO hits",
        "npm run check passes",
        "npm run test passes ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d all tests green",
        "Local dev server starts and full check-in/check-out flow works end-to-end",
        "Verify in browser using agent-browser: Dashboard loads, units display, check-in assigns unit, check-out releases unit"
      ],
      "technicalNotes": [
        "This is the final verification story for Stage 1",
        "Run grep across all source directories ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d every hit must be investigated",
        "Acceptable exclusions: @deprecated aliases in schema-tables.ts, migration SQL files, CLAUDE.md/docs",
        "If any orphaned references found, fix them before marking this story complete"
      ],
      "dependencies": [
        "US-007",
        "US-009",
        "US-010",
        "US-011",
        "US-012"
      ],
      "estimatedComplexity": "medium",
      "passes": false
    },
    {
      "id": "US-014",
      "title": "Create business config module",
      "priority": 14,
      "description": "As a developer, I want a shared business config module so that all business identity (name, address, accommodation type) is centralized and env-var-driven.",
      "acceptanceCriteria": [
        "New file shared/business-config.ts exports BusinessConfig interface and DEFAULT_BUSINESS_CONFIG constant (Pelangi defaults)",
        "BusinessConfig includes: name, shortName, tagline, accommodationType, address, phone, email, website, receiptPrefix",
        "New file server/lib/business-config.ts exports getBusinessConfig() reading from process.env.BUSINESS_* with Pelangi fallbacks",
        "When no env vars are set, getBusinessConfig() returns Pelangi defaults exactly",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "New files: shared/business-config.ts, server/lib/business-config.ts",
        "DEFAULT_BUSINESS_CONFIG must match current hardcoded Pelangi values exactly for backward compat",
        "getBusinessConfig() caches result in module-level variable (config doesn't change at runtime)"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-015",
      "title": "Add business config API endpoint and client hook",
      "priority": 15,
      "description": "As a frontend developer, I want an API endpoint and React hook to access business config so that UI components can display the correct business branding.",
      "acceptanceCriteria": [
        "GET /api/business-config endpoint added to server/routes.ts (unauthenticated ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d needed for login page)",
        "Endpoint returns BusinessConfig JSON from getBusinessConfig()",
        "New file client/src/hooks/useBusinessConfig.ts exports useBusinessConfig() hook using React Query",
        "Hook has 30-minute staleTime (business config rarely changes)",
        "Hook falls back to DEFAULT_BUSINESS_CONFIG while loading",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "New file: client/src/hooks/useBusinessConfig.ts",
        "Edit: server/routes.ts ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d add before auth middleware routes so it's unauthenticated",
        "React Query queryKey: ['/api/business-config']"
      ],
      "dependencies": [
        "US-014"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-016",
      "title": "Add business environment variables to .env.example",
      "priority": 16,
      "description": "As an operator, I want documented env vars for business configuration so that each deployment can be customized without code changes.",
      "acceptanceCriteria": [
        ".env.example updated with: BUSINESS_NAME, BUSINESS_SHORT_NAME, BUSINESS_TAGLINE, ACCOMMODATION_TYPE, BUSINESS_ADDRESS, BUSINESS_PHONE, BUSINESS_EMAIL, BUSINESS_WEBSITE, RECEIPT_PREFIX",
        "RainbowAI/.env.example updated with: BUSINESS_NAME, BUSINESS_LOCATION, BOT_NAME, STAFF_PRIMARY_PHONE, ADMIN_SITE_URL, PUBLIC_SITE_URL",
        "Each env var has a descriptive comment explaining its purpose",
        "Default values match current Pelangi configuration (backward compatible)",
        "server/validate-env.ts updated to validate new optional env vars (non-breaking)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "Files: .env.example, RainbowAI/.env.example, server/validate-env.ts",
        "All new vars are OPTIONAL ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d system works with zero business env vars set"
      ],
      "dependencies": [
        "US-014"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-017",
      "title": "Replace hardcoded branding in client",
      "priority": 17,
      "description": "As a user, I want the dashboard UI to show the correct business name and branding based on which instance I'm accessing.",
      "acceptanceCriteria": [
        "client/src/components/header.tsx:19-20: 'Pelangi Capsule Hostel' -> useBusinessConfig().name; tagline -> .tagline",
        "client/src/components/login-form.tsx: business name from useBusinessConfig()",
        "client/src/lib/receiptGenerator.ts:34,41,44: business name, address, phone, email, website read from BusinessConfig parameter",
        "Receipt number prefix uses receiptPrefix from config",
        "vite.config.ts:91-94: PWA manifest name, short_name, description read from process.env.BUSINESS_* with Pelangi defaults",
        "With no env vars set: UI shows 'Pelangi Capsule Hostel' exactly as before",
        "TypeScript compiles with zero errors",
        "Verify in browser using agent-browser: Login page shows business name, header shows business name"
      ],
      "technicalNotes": [
        "Files: client/src/components/header.tsx, login-form.tsx, client/src/lib/receiptGenerator.ts, vite.config.ts",
        "receiptGenerator needs BusinessConfig passed as parameter ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d update callers",
        "vite.config.ts uses process.env at build time, not runtime ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d values baked into the bundle"
      ],
      "dependencies": [
        "US-015"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-018",
      "title": "Replace hardcoded branding in server and Rainbow AI",
      "priority": 18,
      "description": "As an operator, I want server-side and Rainbow AI branding configurable so that each instance identifies as the correct business.",
      "acceptanceCriteria": [
        "server/index.ts:42-43: hardcoded 'https://pelangi-manager.vercel.app' replaced with process.env.VERCEL_URL or removed",
        "RainbowAI/src/assistant/default-configs.ts:91: system prompt templates process.env.BOT_NAME and process.env.BUSINESS_NAME",
        "RainbowAI/src/assistant/default-configs.ts:119-142: staff phones template process.env.STAFF_PRIMARY_PHONE",
        "RainbowAI/src/routes/admin/metrics.ts:34-35: hardcoded pelangicapsulehostel.com URLs replaced with process.env.ADMIN_SITE_URL / PUBLIC_SITE_URL",
        "TypeScript compiles with zero errors",
        "With no env vars: all defaults match current Pelangi behavior"
      ],
      "technicalNotes": [
        "Files: server/index.ts, RainbowAI/src/assistant/default-configs.ts, RainbowAI/src/routes/admin/metrics.ts",
        "Default BOT_NAME='Rainbow', default BUSINESS_NAME='Pelangi Capsule Hostel'",
        "Default STAFF_PRIMARY_PHONE='+60127088789'"
      ],
      "dependencies": [
        "US-014"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-019",
      "title": "Make unit seed data configurable",
      "priority": 19,
      "description": "As an operator, I want the initial unit inventory configurable via env var so that different businesses start with different units.",
      "acceptanceCriteria": [
        "server/index.ts:205-241: hardcoded C1-C26 capsule seed replaced with process.env.SEED_UNITS parser",
        "Format: number:section[:unitType[:maxOccupancy]] comma-separated",
        "When SEED_UNITS is not set, defaults to current Pelangi capsule layout (22 capsules)",
        "Seed data correctly populates unitType, maxOccupancy columns when provided",
        "Server starts successfully with both default and custom seed configs",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: server/index.ts lines 205-241",
        "Default SEED_UNITS for Pelangi: C1:back,C2:back,C3:back,C4:back,C5:back,C6:back,C25:middle,C26:middle,C11:front,C12:front,C13:front,C14:front,C15:front,C16:front,C17:front,C18:front,C19:front,C20:front,C21:front,C22:front,C23:front,C24:front",
        "Southern example: Studio-A:ground:studio:2,1BR-1:first_floor:1bedroom:4",
        "Parser: split by comma, then by colon ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d robust error handling for malformed entries"
      ],
      "dependencies": [
        "US-001",
        "US-014"
      ],
      "estimatedComplexity": "medium",
      "passes": false
    },
    {
      "id": "US-020",
      "title": "Parameterize deploy script for multi-target",
      "priority": 20,
      "description": "As a developer, I want deploy.sh to support deploying to different Lightsail instances with one command.",
      "acceptanceCriteria": [
        "New directory deploy/targets/ created",
        "deploy/targets/pelangi.env contains: INSTANCE_IP=18.142.14.142, SSH_KEY, SSH_USER=ubuntu, REMOTE_DIR=/var/www/pelangi, PM2 process names",
        "deploy/targets/southern.env contains: placeholder IP, REMOTE_DIR=/var/www/southern, PM2 process names",
        "deploy.sh lines 10-14 refactored: first positional arg is target name (default: pelangi), sources deploy/targets/${TARGET}.env",
        "Usage: ./deploy.sh southern or ./deploy.sh pelangi --skip-build",
        "Error message if target config file doesn't exist",
        "Existing ./deploy.sh (no args) works exactly as before (Pelangi default)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "New files: deploy/targets/pelangi.env, deploy/targets/southern.env",
        "Edit: deploy.sh ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d change hardcoded vars to sourced vars",
        "Keep --skip-build and --skip-rainbow flags working"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-021",
      "title": "Create per-target ecosystem configs",
      "priority": 21,
      "description": "As a developer, I want PM2 ecosystem configs per business so that process names, paths, and CORS origins are correct per instance.",
      "acceptanceCriteria": [
        "ecosystem.config.cjs parameterized: reads APP_DIR, PM2_API_NAME, PM2_RAINBOW_NAME, CORS_ORIGIN, PUBLIC_URL from env vars with Pelangi defaults",
        "Pelangi: process names pelangi-api / rainbow-ai, cwd /var/www/pelangi",
        "Southern: process names southern-api / southern-rainbow, cwd /var/www/southern",
        "Log file paths use correct instance directory",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: ecosystem.config.cjs",
        "OR create per-target files: deploy/targets/pelangi.ecosystem.cjs and deploy/targets/southern.ecosystem.cjs",
        "Deploy script copies the right one during deployment"
      ],
      "dependencies": [
        "US-020"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-022",
      "title": "Create Neon database for Southern Homestay",
      "priority": 22,
      "description": "As an operator, I want a separate Neon Postgres database for Southern Homestay so that business data is completely isolated.",
      "acceptanceCriteria": [
        "New Neon project created named southern-homestay in ap-southeast-1 region",
        "DATABASE_URL connection string obtained and stored securely",
        "Schema pushed successfully: DATABASE_URL=... npx drizzle-kit push creates all tables with units naming",
        "Server startup on new DB auto-seeds default app settings",
        "Unit seed data (from SEED_UNITS env var) populates correctly for Southern Homestay houses"
      ],
      "technicalNotes": [
        "Manual step: create project at console.neon.tech",
        "Run drizzle-kit push from local machine with the new DATABASE_URL",
        "Verify with: psql <connection_string> -c '\\dt' shows units table (not capsules)"
      ],
      "dependencies": [
        "US-013",
        "US-019"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-023",
      "title": "Provision Lightsail instance for Southern Homestay",
      "priority": 23,
      "description": "As an operator, I want a Lightsail instance running the PelangiManager codebase for Southern Homestay.",
      "acceptanceCriteria": [
        "Lightsail instance created: Ubuntu 22.04, $10/mo (2GB RAM), ap-southeast-1",
        "Static/elastic IP assigned",
        "Server provisioned: Node.js 20+, PM2 global, nginx, 2GB swap",
        "Directories created: /var/www/southern/ and /var/www/southern/RainbowAI/",
        ".env files created on server with Southern Homestay config",
        "Lightsail firewall: ports 80, 443, 5000, 3002 open",
        "First deployment via ./deploy.sh southern succeeds",
        "pm2 status shows both processes running",
        "curl http://localhost:5000/api/health returns healthy",
        "curl http://localhost:3002/api/health returns healthy"
      ],
      "technicalNotes": [
        "Manual steps: AWS Console > Lightsail > Create Instance",
        "Server setup script: apt update, install nodejs, npm install -g pm2, nginx, swap setup",
        "Copy .env template from deploy/targets/southern.env.template",
        "Use provided Neon DB: ep-sweet-cell-a1cw3eeh-pooler.ap-southeast-1.aws.neon.tech"
      ],
      "dependencies": [
        "US-020",
        "US-021",
        "US-022"
      ],
      "estimatedComplexity": "large",
      "passes": false
    },
    {
      "id": "US-024",
      "title": "Set up Cloudflare domain and tunnel for Southern Homestay",
      "priority": 24,
      "description": "As an operator, I want HTTPS access to Southern Homestay via a custom domain routed through Cloudflare Tunnel.",
      "acceptanceCriteria": [
        "Domain registered/transferred (e.g., southernhomestay.com)",
        "Domain added to Cloudflare, nameservers updated, status ACTIVE",
        "cloudflared installed on Southern Lightsail instance",
        "Tunnel created: cloudflared tunnel create southern-homestay",
        "Tunnel config: admin.southernhomestay.com -> http://localhost:80, rainbow.southernhomestay.com -> http://localhost:3002",
        "CNAME DNS records point to <tunnel-id>.cfargotunnel.com",
        "cloudflared running as systemd service (auto-start on reboot)",
        "https://admin.southernhomestay.com loads the management dashboard",
        "https://rainbow.southernhomestay.com loads the Rainbow AI dashboard"
      ],
      "technicalNotes": [
        "Manual steps: domain registration, Cloudflare setup",
        "Reference: .claude/skills/cloudflare-setup/SKILL.md for tunnel setup procedure",
        "Existing Pelangi tunnel ID: 0ef67970-4094-492d-a513-8864fa4cfd53 ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d Southern gets a separate tunnel"
      ],
      "dependencies": [
        "US-023"
      ],
      "estimatedComplexity": "medium",
      "passes": false
    },
    {
      "id": "US-025",
      "title": "Set up WhatsApp for Southern Homestay via Baileys",
      "priority": 25,
      "description": "As an operator, I want Southern Homestay to have its own WhatsApp AI assistant with a separate phone number.",
      "acceptanceCriteria": [
        "New Malaysian phone number obtained for Southern Homestay",
        "WHATSAPP_AUTH_DIR=/var/www/southern/RainbowAI/.whatsapp-auth set in Rainbow .env",
        "Baileys pairing completed: device linked via pairing code",
        "WhatsApp connection status: open",
        "Bot responds to test messages with Southern Homestay knowledge",
        "System prompt uses Southern Homestay business name and bot name",
        "Escalation routes to Southern Homestay staff phone numbers",
        "Knowledge base files customized for Southern Homestay (address, pricing, facilities)"
      ],
      "technicalNotes": [
        "Manual steps: obtain phone number, pair device, customize KB",
        "Each instance MUST have its own WHATSAPP_AUTH_DIR ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d cannot share Baileys credentials",
        "Reference: .claude/skills/whatsapp-baileys/SKILL.md for pairing procedure"
      ],
      "dependencies": [
        "US-023",
        "US-018"
      ],
      "estimatedComplexity": "medium",
      "passes": false
    },
    {
      "id": "US-026",
      "title": "Migrate Pelangi production database",
      "priority": 26,
      "description": "As an operator, I want to safely migrate Pelangi's production database to the new schema.",
      "acceptanceCriteria": [
        "Production DB backed up before migration",
        "Migration SQL from US-012 executed on production Neon DB",
        "All table renames verified: units, unit_problems exist; capsules, capsule_problems do not",
        "All column renames verified: unit_number in guests, guest_tokens, admin_notifications, unit_problems",
        "New columns exist: unit_type, max_occupancy, price_per_night (all NULL for existing capsules)",
        "Updated codebase deployed to Pelangi via ./deploy.sh pelangi",
        "All Pelangi flows work: login, dashboard, check-in, check-out, maintenance, Rainbow AI",
        "No data loss ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d all existing guests, units, expenses intact"
      ],
      "technicalNotes": [
        "Manual step: run migration SQL on Neon console or via psql",
        "Backup first: Neon has point-in-time recovery, but also take explicit snapshot",
        "Sequence: backup -> migration SQL -> deploy new code -> verify",
        "If anything breaks: rollback SQL + git revert deploy"
      ],
      "dependencies": [
        "US-012",
        "US-013"
      ],
      "estimatedComplexity": "medium",
      "passes": false
    },
    {
      "id": "US-027",
      "title": "End-to-end verification of both instances",
      "priority": 27,
      "description": "As an operator, I want to verify both Pelangi and Southern Homestay instances are fully operational and independent.",
      "acceptanceCriteria": [
        "Pelangi: https://admin.pelangicapsulehostel.com ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d login, dashboard, check-in/out, receipts all work",
        "Pelangi: https://rainbow.pelangicapsulehostel.com ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d Rainbow AI dashboard loads, WhatsApp bot responds",
        "Southern: https://admin.southernhomestay.com ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d login, dashboard with rooms/houses, check-in/out work",
        "Southern: https://rainbow.southernhomestay.com ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d Rainbow AI dashboard loads, WhatsApp bot responds",
        "Data isolation: creating a guest on Pelangi does NOT appear on Southern (separate DBs)",
        "Pelangi UI shows 'Pelangi Capsule Hostel' with 'Capsule' labels",
        "Southern UI shows 'Southern Homestay' with 'Room'/'House' labels",
        "Receipts show correct business details per instance",
        "pm2 status healthy on both instances",
        "Memory usage under control on both instances"
      ],
      "technicalNotes": [
        "This is the final verification story",
        "Use agent-browser skill to verify both instances",
        "Check pm2 status, free -h, and application logs on both servers",
        "Verify WhatsApp bot responses on both numbers"
      ],
      "dependencies": [
        "US-023",
        "US-024",
        "US-025",
        "US-026"
      ],
      "estimatedComplexity": "medium",
      "passes": false
    },
    {
      "id": "US-028",
      "title": "Fix hardcoded 'Pelangi Unit Hostel' branding in check-in guest info page",
      "priority": 28,
      "description": "As a guest, I want the check-in information page, email, and share text to show the correct business name so that each property's guests see the right branding.",
      "acceptanceCriteria": [
        "client/src/pages/check-in.tsx: <title> tag uses businessConfig.name instead of hardcoded 'Pelangi Unit Hostel'",
        "check-in.tsx: logo div text uses businessConfig.name",
        "check-in.tsx: email subject uses businessConfig.name",
        "check-in.tsx: email body greeting and footer use businessConfig.name",
        "check-in.tsx: Web Share API title/text uses businessConfig.name",
        "check-in.tsx: address fallback uses businessConfig.address instead of hardcoded JB address",
        "useBusinessConfig() hook called at top of check-in component and passed to all string templates",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: client/src/pages/check-in.tsx",
        "Currently hardcodes: 'Pelangi Unit Hostel', '26A, Jalan Perang, Taman Pelangi, 80400 Johor Bahru'",
        "Fix pattern: import useBusinessConfig, call at component top, replace all 'Pelangi Unit Hostel' with business.name",
        "Address fallback: settings?.guideAddress || business.address (business.address already from env)"
      ],
      "dependencies": [
        "US-015"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-029",
      "title": "Fix document.title fallback from 'Manager' to 'digiman'",
      "priority": 29,
      "description": "As a user, I want the browser tab to show 'digiman' by default instead of 'Manager' when no appTitle setting is configured.",
      "acceptanceCriteria": [
        "client/src/App.tsx AppTitleSync: fallback title is 'digiman' not 'Manager'",
        "Browser tab shows 'digiman' before settings load and when appTitle is empty",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: client/src/App.tsx line 50",
        "Change: document.title = title || 'Manager' -> document.title = title || 'digiman'"
      ],
      "dependencies": [],
      "estimatedComplexity": "trivial",
      "passes": true
    },
    {
      "id": "US-030",
      "title": "Update script files with renamed project folder path",
      "priority": 30,
      "description": "As a developer, I want all Windows startup/deploy scripts to reference the correct 'digiman' folder path instead of the old 'PelangiManager-Zeabur' path.",
      "acceptanceCriteria": [
        "fleet-manager-startup.bat: path updated to ...Projects/digiman/fleet-manager",
        "fleet-manager/register-startup.ps1: path updated to ...Projects/digiman, task name updated to FleetManager-digiman",
        "create-startup-shortcut.ps1: path updated from Desktop/Projects/PelangiManager-Zeabur to Documents/1-projects/Projects/digiman",
        "RainbowAI/backup-files.ps1: path updated to current project location",
        "deploy.sh: header comment and echo updated from 'PelangiManager' to 'digiman'",
        "start-all.bat: title updated from 'PelangiManager' to 'digiman'"
      ],
      "technicalNotes": [
        "Old path: C:\\Users\\Jyue\\Desktop\\Projects\\PelangiManager-Zeabur",
        "New path: C:\\Users\\Jyue\\Documents\\1-projects\\Projects\\digiman",
        "Files updated: fleet-manager-startup.bat, fleet-manager/register-startup.ps1, create-startup-shortcut.ps1, RainbowAI/backup-files.ps1, deploy.sh, start-all.bat"
      ],
      "dependencies": [],
      "estimatedComplexity": "trivial",
      "passes": true
    }
  ],
  "technicalContext": {
    "affectedAreas": [
      "shared/schema-tables.ts",
      "shared/validation/",
      "shared/business-config.ts (NEW)",
      "server/Storage/",
      "server/routes/",
      "server/lib/business-config.ts (NEW)",
      "server/index.ts",
      "client/src/components/",
      "client/src/pages/",
      "client/src/hooks/",
      "client/src/lib/",
      "RainbowAI/src/tools/",
      "RainbowAI/src/lib/",
      "RainbowAI/src/routes/admin/",
      "RainbowAI/src/assistant/default-configs.ts",
      "deploy.sh",
      "ecosystem.config.cjs",
      "vite.config.ts",
      "migrations/ (NEW)"
    ],
    "testingStrategy": "TypeScript compilation check after every story. npm run test after server stories. agent-browser verification for UI stories. End-to-end verification in US-013 (code) and US-027 (infrastructure).",
    "rollbackPlan": "Schema: migrations/rollback-units-to-capsules.sql. Code: git revert to pre-rename commit. Infrastructure: each instance is independent ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d rollback one without affecting the other.",
    "crossCuttingConcerns": {
      "backwardCompatibility": "All env vars have Pelangi defaults. Existing deployment works unchanged until migration.",
      "importBoundaries": "RainbowAI/ must have ZERO imports from server/, client/, or shared/ ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d HTTP fetch only",
      "memoryConstraints": "Southern Homestay needs $10/mo 2GB Lightsail (not $5/mo 512MB) for Rainbow AI",
      "whatsappIsolation": "Each instance needs unique WHATSAPP_AUTH_DIR ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬\udc9d cannot share Baileys credentials",
      "buildLocally": "Never npm install on Lightsail (OOM). Build locally, transfer tarball."
    }
  }
}