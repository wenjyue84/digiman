{
  "productName": "Dashboard Activity Fix & WhatsApp-Style Chat Simulator",
  "branchName": "main",
  "overview": "Two improvements to Rainbow AI Dashboard: (1) Fix the 'Connecting...' bug in Dashboard Recent Activity — the SSE real-time activity stream infrastructure exists fully but fails to connect. (2) Redesign Chat Simulator Live Simulation pane to match WhatsApp's native look with developer metadata overlays. Both must work on localhost and Lightsail.",
  "goals": [
    "Restore real-time activity feed on the Dashboard (SSE stream showing live WhatsApp events, AI classifications, system events)",
    "Make Chat Simulator Live Simulation visually match WhatsApp desktop (bubbles, background, input, header)",
    "Maintain developer metadata badges (intent, confidence, tier, provider, response time) in a clean collapsible overlay",
    "Ensure all changes work identically on localhost:3002 and Lightsail 18.142.14.142:3002"
  ],
  "userStories": [
    {
      "id": "US-180",
      "title": "Verify activity tracker backend emits events correctly",
      "priority": 1,
      "description": "The activity tracker singleton in activity-tracker.ts has tracking functions (trackMessageReceived, trackIntentClassified, trackResponseSent, etc.) integrated into 15+ files. Verify these functions are actually called during the message pipeline and that events are emitted and persisted to data/recent-activity.json. Add debug logging if events are not firing. The backend must work before we can fix the frontend SSE connection.",
      "acceptanceCriteria": [
        "Sending a test message via Chat Simulator Quick Test generates at least 2 activity events (message_received + response_sent)",
        "Activity events include correct metadata (phone, intent, confidence, response time)",
        "data/recent-activity.json file gets created/updated with events after sending messages",
        "GET /api/rainbow/activity returns { events: [...], count: N } with N > 0 after sending test messages",
        "No duplicate events appear in the persisted file",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors"
      ],
      "technicalNotes": [
        "Activity tracker singleton: RainbowAI/src/lib/activity-tracker.ts",
        "Tracking integration points: pipeline/input-validator.ts (trackMessageReceived), pipeline/stages/routing.ts (trackIntentClassified), pipeline/response-processor.ts (trackResponseSent)",
        "WhatsApp tracking: RainbowAI/src/lib/whatsapp/instance.ts (trackWhatsAppConnected/Disconnected/Unlinked)",
        "REST endpoint: GET /api/rainbow/activity in RainbowAI/src/routes/admin/activity.ts",
        "Data file: RainbowAI/data/recent-activity.json (created at runtime, debounced 2s writes)",
        "Test via curl: curl http://localhost:3002/api/rainbow/activity",
        "If events not firing, check import paths and whether activity-tracker.ts is loaded as singleton correctly"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-181",
      "title": "Fix SSE activity stream connection (Connecting... bug)",
      "priority": 2,
      "description": "The Dashboard Recent Activity section shows 'Connecting...' indefinitely. The SSE endpoint at /api/rainbow/activity/stream exists and is registered (admin/index.ts line 88), and the frontend client (dashboard-helpers.js initActivityStream()) creates an EventSource. Debug why the connection fails: check URL path, CORS, cache headers interference (US-162 added selective caching — verify SSE path is excluded), and EventSource error handling. Fix the connection so the LIVE green dot appears and events stream in real time.",
      "acceptanceCriteria": [
        "Opening Dashboard tab shows 'LIVE' green dot within 2 seconds (not 'Connecting...')",
        "SSE connection to /api/rainbow/activity/stream establishes successfully",
        "Incoming WhatsApp messages appear as activity events in real time",
        "AI classifications, responses sent, and connection events appear correctly",
        "Category tabs (All, Message, Reply, Connection, Classified) filter events correctly",
        "Show more / Show less expand/collapse works",
        "Relative timestamps update every 30 seconds",
        "SSE auto-reconnects after disconnect (shows 'Reconnecting...' briefly, then 'LIVE' again)",
        "Activity events persist across page refreshes (loaded from data/recent-activity.json)",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser"
      ],
      "technicalNotes": [
        "SSE route: RainbowAI/src/routes/admin/activity.ts GET /activity/stream",
        "Route registration: RainbowAI/src/routes/admin/index.ts line 16 (import) and line 88 (router.use)",
        "Frontend SSE client: RainbowAI/src/public/js/modules/dashboard-helpers.js initActivityStream() line 305",
        "EventSource URL: window.location.origin + '/api/rainbow/activity/stream'",
        "Check if US-162 cache headers (admin/index.ts STABLE_PATHS/SEMI_STABLE_PATHS) accidentally cache the SSE endpoint — /activity/stream should NOT be cached",
        "SSE headers must include: Content-Type: text/event-stream, Cache-Control: no-cache, X-Accel-Buffering: no",
        "Verify with curl: curl -N http://localhost:3002/api/rainbow/activity/stream — should see event: init followed by data",
        "Dashboard HTML: RainbowAI/src/public/templates/tabs/dashboard.html lines 115-145",
        "CSS: RainbowAI/src/public/css/rainbow-base.css lines 5-37 (activity card styles)",
        "Dashboard chunk must export: window.filterActivityByCategory, window.toggleActivityExpand"
      ],
      "dependencies": [
        "US-180"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-182",
      "title": "WhatsApp-style chat background, header, and layout for Live Simulation",
      "priority": 3,
      "description": "Redesign the Live Simulation pane in Chat Simulator to match WhatsApp desktop's visual layout. Add WhatsApp's doodle background pattern (CSS-only, no external assets), update the chat header to show avatar/name/status like WhatsApp, add pill-shaped date separators, and add a scroll-to-bottom floating button. This is CSS + HTML template changes only — no JS logic changes.",
      "acceptanceCriteria": [
        "Chat area background uses a subtle CSS doodle pattern (not plain #efeae2)",
        "Messages area uses WhatsApp's exact spacing and padding",
        "Chat header matches WhatsApp style: avatar circle (40px), contact name, online/last seen status text, right-side action buttons",
        "Date separators between message groups use WhatsApp's pill-shaped style (rounded, centered, semi-transparent background)",
        "Scroll-to-bottom button appears when user scrolls up (circular down-arrow, bottom-right of message area)",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser"
      ],
      "technicalNotes": [
        "HTML template: RainbowAI/src/public/templates/tabs/chat-simulator.html lines 311-560 (Live Simulation section)",
        "CSS files: RainbowAI/src/public/css/rainbow-livechat-core.css (bubble layout), rainbow-livechat-ui.css (input/buttons)",
        "WhatsApp doodle pattern: use CSS background-image with inline SVG data URI or CSS-only pattern (repeating radial-gradient)",
        "Date separator: WhatsApp uses rounded pill with rgba(255,255,255,0.9) background, 12px font, centered",
        "Scroll-to-bottom: add a fixed-position button inside #rc-messages container, show/hide via scroll event listener",
        "Do NOT change JS message rendering logic in this story — focus on HTML structure and CSS only",
        "Keep all existing functionality: dev mode toggle, search, translate, file upload",
        "No nested template literals in JS HTML generation — use string concatenation"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-183",
      "title": "WhatsApp-style message bubbles with timestamps and read receipts",
      "priority": 4,
      "description": "Update renderMessageBubble() in chat-renderer.js and the associated CSS to produce WhatsApp-accurate message bubbles. Guest messages should be white with left tail, AI messages should be green with right tail. Each bubble must show HH:MM timestamp in bottom-right, and bot messages should show double-checkmark read receipt. Consecutive messages from the same sender should have tighter spacing without repeated tails.",
      "acceptanceCriteria": [
        "Guest messages: white (#fff) bubbles, left-aligned, pointed tail on top-left",
        "AI/bot messages: light green (#d9fdd3) bubbles, right-aligned, pointed tail on top-right",
        "Each bubble shows timestamp in bottom-right corner (HH:MM format, small gray text)",
        "Bot messages show double-checkmark read receipt icon next to timestamp",
        "Manual replies show a Manual indicator next to timestamp",
        "Long messages wrap naturally with max-width ~65%",
        "Consecutive messages from same sender have reduced spacing (2px gap, no repeated tail)",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser"
      ],
      "technicalNotes": [
        "Chat renderer: RainbowAI/src/public/js/components/chat-renderer.js renderMessageBubble() lines 214-356",
        "CSS: RainbowAI/src/public/css/rainbow-livechat-core.css — .lc-bubble, .lc-bubble.guest, .lc-bubble.bot",
        "Bubble tails: use CSS ::before pseudo-element with border trick (WhatsApp uses 8px triangles)",
        "Timestamp + checkmark layout: absolute position bottom-right inside bubble, or float right with padding",
        "Double checkmark SVG: small inline SVG or Unicode characters (✓✓ in blue #53bdeb for read)",
        "Grouped messages: detect consecutive same-sender in real-chat-core.js rendering loop, add .bubble-continuation class",
        "Keep existing rc-bubble and lc-bubble class compatibility — both prefixes may be used in different tabs",
        "No nested template literals — use string concatenation for HTML in JS"
      ],
      "dependencies": [
        "US-182"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-184",
      "title": "WhatsApp-style input area with attachment and send button",
      "priority": 5,
      "description": "Update the Live Simulation input area (below the message pane) to match WhatsApp's design: rounded pill input, attachment button on left, green circular send button on right. The existing functionality (auto-resize, Enter/Shift+Enter, file upload, translation preview) must be preserved — this is a visual-only change.",
      "acceptanceCriteria": [
        "Input area has WhatsApp's light gray background (#f0f2f5)",
        "Text input is rounded pill-shape with no visible border",
        "Attachment button on the left side of input",
        "Green circular send button (42x42px, #00a884) on the right",
        "Input auto-resizes from 1 to 5 rows as text grows",
        "Enter sends message, Shift+Enter adds newline",
        "File preview bar appears above input when file is attached",
        "Translation preview appears below input when translation mode is active",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser"
      ],
      "technicalNotes": [
        "HTML: RainbowAI/src/public/templates/tabs/chat-simulator.html lines 465-500 (Live Simulation input area)",
        "CSS: RainbowAI/src/public/css/rainbow-livechat-ui.css — .rc-input-area, .rc-input-box, .rc-send-btn, .rc-attach-btn",
        "Existing JS logic in real-chat-messaging.js (sendManualReply, autoResizeInput, handleInputKeydown) — do NOT change",
        "The send button already uses #00a884 green — verify it's 42x42px circular",
        "Input pill shape: border-radius: 21px (half of height), background: white, no border, subtle box-shadow",
        "Attachment popup menu (.rc-attach-menu) should still appear above the attachment button",
        "File preview and translation preview bars must not break with new input styling"
      ],
      "dependencies": [
        "US-182"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-185",
      "title": "Developer metadata overlay (collapsible panel in Dev Mode)",
      "priority": 6,
      "description": "Enhance the Dev Mode toggle in Live Simulation to show AI classification details as a collapsible metadata panel below each AI response bubble. When Dev Mode is OFF, messages look exactly like WhatsApp. When ON, each AI bubble gets a subtle expandable panel showing: Detection Tier, Intent, Confidence %, Provider/Model, Response Time, Routing Action, Sentiment, KB files. Dev mode state persists in localStorage.",
      "acceptanceCriteria": [
        "Dev button in chat header toggles developer mode on/off",
        "When OFF: messages look exactly like WhatsApp (clean, no metadata visible)",
        "When ON: each AI response bubble shows a collapsible metadata panel below the message text",
        "Metadata panel shows all 8 fields: Detection Tier badge, Intent name, Confidence %, AI Provider/Model, Response Time, Routing Action, Sentiment, KB files used",
        "Metadata panel uses subtle styling (muted colors, smaller font, light background)",
        "Inline edit buttons (Edit, Add example) appear in dev mode only",
        "Dev mode state persists in localStorage across page loads",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser"
      ],
      "technicalNotes": [
        "Metadata badges: RainbowAI/src/public/js/components/metadata-badges.js (getTierBadge, getConfidenceBadge, etc.)",
        "Chat renderer: RainbowAI/src/public/js/components/chat-renderer.js — devMode option already exists in renderMessageBubble()",
        "Current dev mode: toggled by toggleDevMode() in real-chat-core.js, stored as devModeEnabled in module state",
        "Change from inline footer badges to a collapsible panel: add a clickable chevron below the bubble that expands/collapses the metadata section",
        "Panel CSS: background-color: rgba(0,0,0,0.03), border-top: 1px solid rgba(0,0,0,0.06), font-size: 11px",
        "localStorage key: 'rainbow-dev-mode' (check existing implementation)",
        "Ensure metadata panel doesn't break the WhatsApp bubble styling from US-183",
        "No nested template literals — use string concatenation"
      ],
      "dependencies": [
        "US-183"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-186",
      "title": "Environment compatibility audit (localhost + Lightsail)",
      "priority": 7,
      "description": "Audit all changes from US-180 through US-185 for environment compatibility. Verify no hardcoded localhost URLs exist, SSE works through both direct access and Vite proxy, and CSS/JS assets load correctly on Lightsail. Fix any issues found.",
      "acceptanceCriteria": [
        "No hardcoded localhost URLs in any modified JS/TS files — all API calls use relative paths or window.location.origin",
        "SSE activity stream works when accessed at localhost:3002 (direct)",
        "SSE activity stream works when proxied through Vite at localhost:3000 (dev mode via proxy config)",
        "Chat Simulator Live Simulation renders correctly on both environments",
        "CSS/JS assets load correctly (no 404s on either environment)",
        "WhatsApp doodle background pattern renders (CSS-only, no external asset dependency)",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors"
      ],
      "technicalNotes": [
        "Grep all modified files for 'localhost', '127.0.0.1', 'http://' hardcoded URLs",
        "Vite proxy config: vite.config.ts — /api/rainbow/* proxies to port 3002",
        "Lightsail nginx config: port 3002 is open directly (not proxied through nginx port 80)",
        "SSE through Vite proxy: Vite dev server should pass through text/event-stream responses — verify",
        "PM2 on Lightsail uses ecosystem.config.cjs with fork mode — ESM imports work correctly",
        "If SSE doesn't work through Vite proxy, add SSE-specific proxy config in vite.config.ts"
      ],
      "dependencies": [
        "US-180",
        "US-181",
        "US-182",
        "US-183",
        "US-184",
        "US-185"
      ],
      "estimatedComplexity": "small",
      "passes": true
    }
  ],
  "technicalContext": {
    "affectedAreas": [
      "RainbowAI/src/lib/activity-tracker.ts",
      "RainbowAI/src/routes/admin/activity.ts",
      "RainbowAI/src/routes/admin/index.ts",
      "RainbowAI/src/public/js/modules/dashboard.js",
      "RainbowAI/src/public/js/modules/dashboard-helpers.js",
      "RainbowAI/src/public/js/module-chunks/dashboard-chunk.js",
      "RainbowAI/src/public/templates/tabs/dashboard.html",
      "RainbowAI/src/public/templates/tabs/chat-simulator.html",
      "RainbowAI/src/public/js/components/chat-renderer.js",
      "RainbowAI/src/public/js/components/metadata-badges.js",
      "RainbowAI/src/public/js/modules/real-chat-core.js",
      "RainbowAI/src/public/js/modules/real-chat-messaging.js",
      "RainbowAI/src/public/css/rainbow-livechat-core.css",
      "RainbowAI/src/public/css/rainbow-livechat-ui.css",
      "RainbowAI/src/public/css/rainbow-base.css"
    ],
    "testingStrategy": "TypeScript compilation + curl SSE endpoint verification + agent-browser dashboard visual verification for each UI story",
    "rollbackPlan": "git checkout HEAD -- RainbowAI/src/public/ RainbowAI/src/lib/activity-tracker.ts RainbowAI/src/routes/admin/activity.ts"
  }
}
