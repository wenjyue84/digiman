{
  "productName": "Rainbow AI Live Chat Phase 3 â€” WhatsApp UX, Prisma AI & Bug Fixes",
  "branchName": "ralph/live-chat-enhancements",
  "overview": "Phase 3: 22 user stories across 7 areas â€” fix infrastructure bugs (CORS login, self-check-in URL), fix live-chat bugs (translate toggle, staff-review prediction), improve Rainbow AI content and config (greeting hint, workflow dead ends, Malay naturalness, auto-approve expansion), add WhatsApp UX parity (pill-chip filters, message menu positioning, avatar initials, schedule datetime, date-jump search), build Prisma AI in-chat assistant for new staff, and mirror all features in chat-simulator/live-simulation. All changes within RainbowAI/ and server/ modules only.",
  "goals": [
    "Fix production infrastructure: CORS login error and broken guest self-check-in link URL",
    "Fix live-chat bugs: translate toggle, staff-review prediction marking, Ollama UX",
    "Improve Rainbow AI guest experience: first-contact greeting, workflow cancel escape, natural Malay",
    "Expand copilot auto-approve from 3 to 11 informational intents to reduce 30-minute wait times",
    "Match WhatsApp Web UX conventions: filter chips, context menu anchoring, colored avatars, full datetime scheduling, date-jump search",
    "Build Prisma AI floating assistant for new staff to answer questions using KB, MCP, history, and internet",
    "Keep #live-chat and #chat-simulator/live-simulation in full feature parity"
  ],
  "userStories": [
    {
      "id": "US-018",
      "title": "Fix CORS policy violation on production login",
      "priority": 1,
      "description": "As a staff member logging in at http://18.142.14.142/login, I want the sign-in to succeed without a CORS error so I can access the dashboard. The browser reports 'CORS policy violation' on login form submission. In production, nginx serves both frontend and API from port 80 â€” requests should be same-origin. Root cause is likely a hardcoded localhost URL in the login form action or API call that bypasses nginx and hits port 5000 directly.",
      "acceptanceCriteria": [
        "Identify the CORS root cause: check server/index.ts cors() middleware config AND scan client-side login code for any hardcoded localhost:5000 or port 5000 references",
        "If hardcoded URL found: replace with relative path (e.g. /api/login instead of http://localhost:5000/api/login)",
        "If CORS config is the root cause: add http://18.142.14.142 to allowed origins via CORS_ORIGIN env var",
        "Login at http://18.142.14.142/login completes without CORS errors in browser console",
        "Local dev login at http://localhost:3000 is not broken",
        "CORS_ORIGIN env var documented in root .env.example if used",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: navigate to http://18.142.14.142/login, submit credentials, confirm no CORS error"
      ],
      "technicalNotes": [
        "CORS config: server/index.ts â€” check cors() middleware origin setting",
        "Login API call: client/src/ â€” search for fetch('/api/auth/login') or similar; check if any hardcoded http://localhost:5000 exists",
        "In production: nginx at port 80 proxies /api/* to port 5000. Frontend at port 80 + API at port 80 = same origin = no CORS needed",
        "If login JS calls http://localhost:5000/api directly (not relative path), browser blocks it as cross-origin",
        "Fix priority: relative path fix >> CORS header fix (simpler, no env var needed)",
        "Check Vite config (vite.config.ts) for proxy settings that may be misapplied in production builds"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-017",
      "title": "Fix self-check-in link URL to use public Lightsail IP",
      "priority": 2,
      "description": "As a guest receiving a self-check-in WhatsApp message, I want the check-in link to work from my phone. The current generated link uses http://localhost:5000/guest-checkin?token=... which guests cannot open. Fix: read PUBLIC_URL env var as the base URL when generating the link.",
      "acceptanceCriteria": [
        "Search server/ codebase for all occurrences of 'localhost:5000' in string templates, URL construction, and link generation code",
        "Add PUBLIC_URL env var support: when set, use it as the base URL for all guest-facing links",
        "Generated self-check-in URL uses PUBLIC_URL as base: http://18.142.14.142/guest-checkin?token=...",
        "If PUBLIC_URL is not set, fall back to req.protocol + '://' + req.get('host') (preserves local dev at localhost:5000)",
        "Same fix applied to any other guest-facing links with hardcoded localhost (payment links, QR links, etc.)",
        "Root .env.example updated with: PUBLIC_URL=http://18.142.14.142",
        "On local dev (PUBLIC_URL not set), the link still resolves to localhost (from request host header)",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors"
      ],
      "technicalNotes": [
        "Grep server/ for 'localhost:5000' string literals to find all hardcoded URLs",
        "Self-check-in link is likely generated in server/routes/ when creating a guest token",
        "Pattern to use: const baseUrl = process.env.PUBLIC_URL || `${req.protocol}://${req.get('host')}`;",
        "Also check RainbowAI/ for any guest-facing URL generation that might use localhost",
        "The guest-checkin page is served by the server at port 5000 (proxied by nginx in production)"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-016",
      "title": "Fix 'Failed to mark prediction' error in staff-review",
      "priority": 3,
      "description": "As an admin reviewing predictions in #staff-review, I want marking a prediction to succeed without errors. Every row shows 'Error' status (Image #6). Root cause unknown â€” investigate the mark-prediction API endpoint, request payload, and response.",
      "acceptanceCriteria": [
        "Identify the failing API call: check RainbowAI/src/routes/admin/intent-analytics.ts for the mark-prediction endpoint",
        "Verify the frontend request payload matches what the backend expects (field names, types, content-type header)",
        "Fix the root cause: missing field, wrong content-type, auth issue, or schema mismatch",
        "Marking a prediction as correct or incorrect succeeds and the row updates its status visually (no 'Error' label)",
        "No console errors in browser when marking predictions",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: load #staff-review, click mark on any row, confirm success state"
      ],
      "technicalNotes": [
        "Staff review route: RainbowAI/src/routes/admin/intent-analytics.ts â€” look for PATCH or POST endpoint for marking predictions",
        "Frontend call: search RainbowAI/src/public/js/modules/ for 'mark' or 'prediction' to find the fetch() call",
        "Common causes: body not JSON.stringify'd, missing Content-Type: application/json header, wrong HTTP method, endpoint path mismatch",
        "The 'Error' shown in Image #6 appears in every row â€” suggests a systematic issue (wrong URL or auth), not a data issue"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-006",
      "title": "Fix translate toggle in live-chat",
      "priority": 4,
      "description": "As a staff member, I want the Translate toggle in #live-chat to actually enable translation of incoming messages. The toggle currently cannot be turned ON (reverts immediately or has no effect). This feature was previously working â€” check git log for the regression.",
      "acceptanceCriteria": [
        "Check git log for recent changes to translate-related code in live-chat-actions.js, live-chat-core.js, or the translate API route",
        "Translate toggle can be toggled ON without reverting back to OFF",
        "When ON, incoming messages are translated using the active AI provider and translation appears below the original text",
        "When OFF, no translation is shown",
        "Toggle state persists across conversation switches within the same browser session",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: toggle ON, send a non-English message via chat simulator, confirm translation appears"
      ],
      "technicalNotes": [
        "Translate toggle: RainbowAI/src/public/js/modules/live-chat-actions.js â€” look for toggleTranslate() or similar",
        "State management: RainbowAI/src/public/js/modules/live-chat-core.js â€” check if translate state is being persisted",
        "Translate API: check RainbowAI/src/routes/admin/conversations.ts for a translate endpoint",
        "git log -- RainbowAI/src/public/js/modules/live-chat-actions.js to find the regression commit",
        "Common regression: event listener removed during modular refactor, or state variable renamed"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-001",
      "title": "Ollama troubleshooting guide on speed test error",
      "priority": 5,
      "description": "As a staff member, I want to see a troubleshooting guide when an Ollama model fails the speed test in #settings/ai-models, so I know it's a local software issue and how to fix it. The guide must explain that Ollama must be running locally, with steps to install, start, and retry.",
      "acceptanceCriteria": [
        "When 'Test Speed' is clicked on an Ollama model and it returns an error, a collapsible troubleshooting panel appears below that model card (not a toast â€” must persist)",
        "The panel contains: (1) explanation 'Ollama runs locally on your computer and must be started before use', (2) steps: install Ollama â†’ run ollama serve â†’ pull the model â†’ retry, (3) a Retry button that re-runs the speed test inline",
        "The panel does NOT appear for non-Ollama providers (OpenAI, Anthropic, NVIDIA, etc.)",
        "If the retry succeeds, the panel collapses and the speed result is shown normally",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: open #settings/ai-models, test an Ollama model, confirm guide appears on error"
      ],
      "technicalNotes": [
        "Speed test UI: RainbowAI/src/public/js/modules/settings-ai-models.js â€” find the testSpeed() function",
        "Template: RainbowAI/src/public/templates/tabs/settings.html â€” Ollama provider cards",
        "Detection: check provider.id or provider.type for 'ollama' string before showing the guide",
        "The guide should be injected into the DOM after the model card, not shown as a modal/toast"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Cloud environment Ollama unavailability warning",
      "priority": 6,
      "description": "As a cloud server admin viewing #settings/ai-models on the Lightsail instance, I want a persistent notice that Ollama is not available in the cloud environment, so I don't waste time enabling it. Detect cloud context via RAINBOW_ROLE=primary env var.",
      "acceptanceCriteria": [
        "Detect cloud context server-side: if RAINBOW_ROLE === 'primary', expose isCloud: true in GET /api/rainbow/status response",
        "In #settings/ai-models, when isCloud is true, Ollama model cards show a yellow warning badge: 'Not available on cloud server â€” Ollama requires local installation'",
        "The Activate toggle for Ollama models is disabled (greyed out) in cloud context with tooltip explaining why",
        "Test Speed button for Ollama is also disabled in cloud context",
        "In local/standby mode (RAINBOW_ROLE=standby or unset), the warning does NOT appear",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: open #settings/ai-models and confirm Ollama UI state matches environment"
      ],
      "technicalNotes": [
        "Status endpoint: RainbowAI/src/routes/admin/index.ts or whatsapp.ts â€” GET /api/rainbow/status",
        "Add isCloud: process.env.RAINBOW_ROLE === 'primary' to the status response",
        "Frontend reads isCloud from status API on page load and applies warning state to Ollama provider cards",
        "settings-ai-models.js: add cloud check when rendering provider cards",
        "CSS: add .lc-disabled and yellow badge styles if not already present"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-019",
      "title": "Add capability menu hint to first-contact greeting",
      "priority": 7,
      "description": "As a first-time guest messaging Rainbow on WhatsApp, I want to receive a brief menu of what Rainbow can help with so I know how to interact. The current greeting is a plain welcome with no hints. Add a capability list to the greeting for new contacts (conversation history length = 0).",
      "acceptanceCriteria": [
        "Locate the greeting intent's static reply in RainbowAI/src/assistant/data/ (settings.json or static-replies config)",
        "Update the en variant to include the capability menu: 'Hi! I'm Rainbow ðŸŒˆ I can help with:\\nâ€¢ ðŸ¨ Check-in / Check-out\\nâ€¢ ðŸ’° Pricing & availability\\nâ€¢ ðŸ“ Location & directions\\nâ€¢ ðŸ› Facilities & WiFi\\nâ€¢ ðŸ™‹ Or just ask me anything!'",
        "Add ms (Malay) variant: 'Hai! Saya Rainbow ðŸŒˆ Boleh bantu dengan:\\nâ€¢ ðŸ¨ Check-in / Check-out\\nâ€¢ ðŸ’° Harga & ketersediaan\\nâ€¢ ðŸ“ Lokasi & arah\\nâ€¢ ðŸ› Kemudahan & WiFi\\nâ€¢ ðŸ™‹ Atau tanya apa sahaja!'",
        "Add zh (Chinese) variant with equivalent content",
        "The hint is shown only when conversation history length is 0 (true first contact) â€” verify the message router checks this condition",
        "For returning guests (history exists), the greeting remains the original shorter version",
        "50-scenario accuracy test maintains 100% pass rate after this change",
        "TypeScript compiles with zero errors",
        "Verify in Chat Simulator: send 'hi' from a fresh conversation, confirm capability hint appears"
      ],
      "technicalNotes": [
        "Greeting reply config: likely in RainbowAI/src/assistant/data/settings.json under staticReplies.greeting",
        "First-contact detection: RainbowAI/src/assistant/message-router.ts â€” check if conversationHistory.length === 0 before routing greeting",
        "If first-contact detection doesn't exist: add check in the greeting action handler to select between full hint vs short reply",
        "The greeting response may be in routing.json as a static_reply action â€” trace the full flow from greeting intent â†’ routing â†’ reply"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-021",
      "title": "Improve booking workflow naturalness and Malay translations",
      "priority": 9,
      "description": "As a guest going through the booking process, I want Rainbow to ask questions directly without a preamble filler message, and in natural conversational Malay. Current booking_payment_handler sends a preamble step ('I'll help you with your booking...') before asking the actual question, adding an unnecessary round-trip.",
      "acceptanceCriteria": [
        "Locate booking_payment_handler workflow in RainbowAI/src/assistant/data/workflows.json",
        "Collapse the preamble step: merge Step 1 (preamble) and Step 2 (first question) into a single opening message",
        "en opening: 'Happy to help with your booking! How many guests will be staying?'",
        "ms opening: 'Boleh bantu! Berapa orang tetamu nak check in?'",
        "zh opening: 'å¥½çš„ï¼Œæˆ‘æ¥å¸®æ‚¨åŠžç†ï¼è¯·é—®å‡ ä½å®¢äººå…¥ä½ï¼Ÿ'",
        "Review all other ms variants in this workflow for literal translations and rewrite unnatural ones (payment method, confirmation messages)",
        "Only ONE message is sent before the guest can respond (verified in Chat Simulator)",
        "50-scenario accuracy test maintains 100% pass rate after this change",
        "TypeScript compiles with zero errors",
        "Verify in Chat Simulator: trigger booking workflow, confirm only one opening message before guest response"
      ],
      "technicalNotes": [
        "Workflow definitions: RainbowAI/src/assistant/data/workflows.json",
        "Find booking_payment_handler workflow, look at steps array",
        "Natural Malaysian Malay markers: 'nak' (want to), 'lah' (particle), 'boleh' (can), 'dah' (already), 'berapa' (how many)",
        "Avoid literal translation of 'guests will be staying' â†’ 'tetamu nak check in' is more natural",
        "This is a JSON-only change â€” no TypeScript files need modification"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-022",
      "title": "Expand copilot auto-approve intent list from 3 to 11 intents",
      "priority": 8,
      "description": "As a hostel manager using copilot mode, I want Rainbow to auto-approve replies for all low-risk informational intents so guests don't wait 30 minutes for staff manual approval. Currently only greeting, thanks, and wifi are auto-approved. All 11 informational intents are safe to auto-approve.",
      "acceptanceCriteria": [
        "Locate auto_approve_intents config in RainbowAI/src/assistant/data/settings.json (under copilot key)",
        "Update the list to: ['greeting', 'thanks', 'wifi', 'directions', 'checkin_info', 'checkout_info', 'facilities_info', 'rules_policy', 'payment_info', 'luggage_storage', 'extra_amenity_request']",
        "Verify all 11 intent names exist in intent-keywords.json and routing.json (no typos, no missing intents)",
        "In copilot mode, a message classified as checkin_info is auto-approved and sent without staff action",
        "50-scenario accuracy test maintains 100% pass rate after this change",
        "TypeScript compiles with zero errors",
        "Verify in Chat Simulator: enable copilot mode, ask 'what time is check in?', confirm Rainbow replies without staff approval step"
      ],
      "technicalNotes": [
        "Settings file: RainbowAI/src/assistant/data/settings.json â€” look for copilot.auto_approve_intents array",
        "Cross-check intent names: grep intent-keywords.json for each of the 11 intent names to confirm they exist",
        "Cross-check routing: grep routing.json for each intent name",
        "This is a JSON-only change â€” no TypeScript modification needed",
        "The copilot mode logic that reads this list is in message-router.ts or response-processor.ts"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-020",
      "title": "Fix workflow dead ends â€” cancel intent and routing gaps",
      "priority": 10,
      "description": "As a guest mid-workflow, I want to say 'cancel' or 'nevermind' and have Rainbow gracefully exit, so I don't get confused responses. Three gaps: (1) no cancel_workflow intent, (2) climate_control_complaint routes to static_reply instead of complaint_handling workflow, (3) billing_dispute routes to static_reply instead of escalate workflow.",
      "acceptanceCriteria": [
        "Add cancel_workflow intent to intent-keywords.json with keywords: 'cancel', 'nevermind', 'stop', 'forget it', 'batal', 'tak nak', 'ç®—äº†' (and common variations)",
        "The workflow executor (workflow-executor.ts or action-dispatch.ts) checks for cancel_workflow intent at each step and exits gracefully",
        "Graceful exit message (en): 'No problem! Is there anything else I can help you with?' with ms and zh variants",
        "Update routing.json: climate_control_complaint action changed from static_reply to workflow with workflow_id: complaint_handling",
        "Update routing.json: billing_dispute action changed from static_reply to workflow with workflow_id: escalate",
        "Verify complaint_handling and escalate workflows exist in workflows.json (create minimal 2-step versions if missing)",
        "50-scenario accuracy test maintains 100% pass rate after routing changes",
        "TypeScript compiles with zero errors",
        "Verify in Chat Simulator: send 'cancel' mid-booking-workflow, confirm graceful exit message"
      ],
      "technicalNotes": [
        "Intent keywords: RainbowAI/src/assistant/data/intent-keywords.json",
        "Routing: RainbowAI/src/assistant/data/routing.json â€” find climate_control_complaint and billing_dispute entries",
        "Workflow executor: RainbowAI/src/assistant/pipeline/stages/action-dispatch.ts or a workflow-executor.ts file",
        "Cancel check location: add at the top of the workflow step handler â€” if classified intent === 'cancel_workflow', call exitWorkflow()",
        "Workflows file: RainbowAI/src/assistant/data/workflows.json â€” verify complaint_handling and escalate exist"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-007",
      "title": "Colored initials avatar for contacts without profile picture",
      "priority": 11,
      "description": "As a staff member, I want contacts without a profile picture to show a colored circle with their initials (e.g. 'AF' for Alston Foo) instead of a blank grey circle, making conversations visually distinguishable at a glance.",
      "acceptanceCriteria": [
        "When a contact has no profile picture, avatar is a filled circle with a deterministic background color derived from contact's phone number (same number = same color always)",
        "Initials: first letter(s) of display name (e.g. 'Alston Foo' â†’ 'AF', 'Jay' â†’ 'J')",
        "Color palette uses at least 8 distinct, readable colors â€” not red or green (avoid confusion with status indicators)",
        "White or near-white text on dark backgrounds for legibility",
        "Applied in: conversation list avatars, chat header avatar, and message thread avatars",
        "Contacts with actual profile pictures are unaffected",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: open #live-chat, confirm contacts without photos show colored initials"
      ],
      "technicalNotes": [
        "Avatar rendering: RainbowAI/src/public/js/modules/live-chat-panels.js and live-chat-core.js â€” find where avatar img tags are created",
        "Color hash: sum = name.split('').reduce((a,c) => a + c.charCodeAt(0), 0); color = palette[sum % palette.length]",
        "Palette suggestion: ['#1abc9c','#3498db','#9b59b6','#e67e22','#e91e63','#00bcd4','#ff5722','#607d8b']",
        "If profile picture 404s or src is empty/null, show initials div instead of broken img",
        "Add CSS class .avatar-initials with display:flex, align-items:center, justify-content:center, border-radius:50%",
        "CSS target file: RainbowAI/src/public/css/rainbow-livechat-core.css or rainbow-livechat-ui.css"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Redesign chat filter bar to WhatsApp-style pill chips",
      "priority": 12,
      "description": "As a staff member, I want the Tags and Unit filter icons in #live-chat to look like WhatsApp's horizontal pill chip row (All | Unread | Favourites | Groups | Tags â–¾ | Unit â–¾) instead of icon-based buttons, making the interface familiar and visually consistent.",
      "acceptanceCriteria": [
        "Filter row shows: All | Unread | Favourites | Groups | Tags â–¾ | Unit â–¾ as horizontal scrollable pill chips",
        "All chip has a filled/active style (green background matching Image #1) when no filter is active",
        "Tags and Unit chips show a downward chevron (â–¾) indicating they open a dropdown",
        "Active filter chip has a distinct active style (filled background, different from inactive)",
        "Chips are scrollable horizontally on narrow viewports without wrapping to a second line",
        "Existing icon-based Tags/Unit buttons are replaced (not kept alongside new chips)",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: open #live-chat, confirm pill chip row matches WhatsApp style"
      ],
      "technicalNotes": [
        "Current filter HTML: RainbowAI/src/public/templates/tabs/live-chat.html (lines 111-125 â€” tag/unit filter buttons)",
        "Replace icon buttons with a <div class='lc-filter-chips'> containing <button class='lc-chip'> elements",
        "CSS: RainbowAI/src/public/css/rainbow-livechat-core.css or rainbow-livechat-ui.css",
        "Chip active state: .lc-chip.active { background: #25d366; color: #fff; }",
        "Horizontal scroll: .lc-filter-chips { display:flex; overflow-x:auto; gap:8px; padding:8px; scrollbar-width:none; }",
        "This story is visual only â€” dropdown wiring is in US-004"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Wire Tags and Unit filter chips to backend conversation filtering",
      "priority": 13,
      "description": "As a staff member, I want clicking a Tags or Unit chip to actually filter the conversation list, showing only conversations with that tag or unit assignment. Dropdowns fetch data from backend APIs.",
      "acceptanceCriteria": [
        "Clicking Tags â–¾ opens a dropdown listing all available tags fetched from GET /api/rainbow/tags",
        "Selecting a tag filters the conversation list to show only conversations with that tag",
        "Clicking Unit â–¾ opens a dropdown listing all capsule units fetched from GET /api/rainbow/capsules or contacts",
        "Selecting a unit filters the conversation list to show only conversations with that unit assignment",
        "Multiple filters can be active simultaneously (Tags AND Unit combined)",
        "A clear/reset option appears when any filter is active, restoring full conversation list",
        "Filter state persists during the browser session (not wiped on tab switch)",
        "Dropdown closes when clicking anywhere outside it",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: select a tag filter, confirm conversation list updates"
      ],
      "technicalNotes": [
        "Existing filter code: RainbowAI/src/public/js/modules/live-chat-panels.js (lines 773-883: _renderTagFilterDropdown, _renderUnitFilterDropdown)",
        "Core filtering: RainbowAI/src/public/js/modules/live-chat-core.js (lines 433-449)",
        "Tags API: GET /api/rainbow/tags (RainbowAI/src/routes/admin/tags.ts)",
        "Capsules API: GET /api/rainbow/capsules (RainbowAI/src/routes/admin/capsules.ts)",
        "Root cause from Phase 5: $.contactTagsMap and $.contactUnitsMap not populated â€” ensure loadContactTagsMap() and loadContactUnitsMap() are called in initialization",
        "Wire the new chip click events (US-003) to the existing dropdown render functions"
      ],
      "dependencies": [
        "US-003"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Reposition message action menu near message bubble (WhatsApp style)",
      "priority": 14,
      "description": "As a staff member, I want the message action menu (Like, Love, Haha, Wow, Sad, Thanks, Reply, Copy, Forward) to appear adjacent to the clicked message bubble, not in a fixed or off-position location, matching WhatsApp Web's context menu behaviour.",
      "acceptanceCriteria": [
        "When the downward chevron on a message is clicked, the action menu appears immediately adjacent to that message bubble",
        "Right-aligned for outgoing messages, left-aligned for incoming messages",
        "Emoji reactions (Like, Love, Haha, Wow, Sad, Thanks) appear in a horizontal icon row at the top of the menu",
        "Text actions (Reply, Copy, Forward) appear below the emoji row",
        "If the menu would overflow the bottom of the viewport, it opens upward from the chevron instead",
        "Clicking anywhere outside the menu closes it",
        "Works correctly for both incoming and outgoing message bubbles",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: click message chevron, confirm menu appears near that bubble"
      ],
      "technicalNotes": [
        "Message action menu: RainbowAI/src/public/js/modules/live-chat-actions.js â€” find the menu render/position code",
        "Current issue: menu likely uses position:fixed or a detached absolute div not anchored to the message",
        "Fix: use getBoundingClientRect() on the chevron element to get absolute position, then set menu top/left accordingly",
        "Overflow check: if (menuTop + menuHeight > window.innerHeight) { menuTop = chevronRect.top - menuHeight; }",
        "CSS: menu should be position:absolute inside a relative-positioned container, or position:fixed with calculated coordinates",
        "WhatsApp Web reference: renders menu as absolute-positioned div with emoji row + text row, flips vertically on overflow"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-008",
      "title": "Improve schedule message picker with full date-time editing",
      "priority": 15,
      "description": "As a staff member, I want to edit the exact hour, minute, and second when scheduling a message, so I can schedule precisely (e.g., exactly at check-in time 14:00:00). The current modal only allows date editing via a datetime-local input.",
      "acceptanceCriteria": [
        "Schedule Message modal shows separate editable fields for: Date, Hour (00-23), Minute (00-59), Second (00-59)",
        "Users can type directly into each field or use up/down arrows to increment/decrement values",
        "A human-readable preview shows the composed datetime: 'Will send: 19 Mar 2026 at 02:30:45'",
        "Validation prevents scheduling in the past â€” inline error shown if datetime < now",
        "The existing datetime-local input is replaced or augmented with the separate fields",
        "Repeat (None / Daily / Weekly) dropdown remains unchanged",
        "Schedule button submits the full datetime including seconds to the backend",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: open Schedule Message modal, edit hour/minute/second fields, confirm they work"
      ],
      "technicalNotes": [
        "Schedule modal: RainbowAI/src/public/templates/tabs/live-chat.html â€” search for 'Schedule Message' modal",
        "Frontend scheduling logic: RainbowAI/src/public/js/modules/live-chat-panels.js â€” find lcScheduleMessage() or similar",
        "Replace <input type='datetime-local'> with three <input type='number'> fields for HH, MM, SS plus a <input type='date'>",
        "Combine into ISO string: new Date(`${date}T${hh}:${mm}:${ss}`).toISOString()",
        "Scheduled messages route: RainbowAI/src/routes/admin/scheduled-messages.ts â€” verify it accepts seconds in the datetime"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-014",
      "title": "Add date-jump to in-conversation message search",
      "priority": 16,
      "description": "As a staff member searching messages, I want a 'Jump to date' calendar button beside the search bar so I can navigate to messages from a specific date without scrolling, matching WhatsApp Web's date-jump behaviour.",
      "acceptanceCriteria": [
        "The in-conversation search bar has a calendar icon button beside it",
        "Clicking the calendar icon opens a date picker (date only, not datetime)",
        "Selecting a date scrolls the message thread to the nearest message on or after that date",
        "A date separator is highlighted to indicate the jump destination",
        "If no messages exist for the selected date, a toast shows: 'No messages found for [date]'",
        "The existing â–² / â–¼ navigation arrows for keyword search results are not affected",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: open a conversation, use date-jump to navigate to an older date"
      ],
      "technicalNotes": [
        "Search bar: RainbowAI/src/public/templates/tabs/live-chat.html â€” find the search messages input",
        "Search logic: RainbowAI/src/public/js/modules/live-chat-core.js â€” find message search and navigation",
        "Date jump: find the message element closest to the target date (messages should have data-timestamp attributes or similar)",
        "Use element.scrollIntoView({ behavior: 'smooth', block: 'start' }) to scroll to the date",
        "Date separator: messages are grouped by date â€” find or create the date separator element and highlight it temporarily",
        "Use <input type='date'> in a small popover triggered by the calendar icon button"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-009",
      "title": "Add 'Ask AI â€” Prisma' entry to conversation 3-dot menu",
      "priority": 17,
      "description": "As a staff member, I want an 'Ask AI' option in the conversation's 3-dot (â‹®) menu so I can launch the Prisma AI assistant without leaving the chat. This is the entry point for the Prisma floating window (built in US-010).",
      "acceptanceCriteria": [
        "The 3-dot (â‹®) menu in the conversation header includes a new item: 'Ask AI â€” Prisma' with a sparkle icon (âœ¦ or similar)",
        "Clicking it opens/focuses the Prisma floating chat window (to be implemented in US-010 â€” create empty placeholder div for now)",
        "If Prisma window is already open, clicking again focuses it (does not open duplicate)",
        "The menu item is clearly distinguishable from other menu items (icon + label)",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: open a conversation, click 3-dot menu, confirm 'Ask AI â€” Prisma' item is visible"
      ],
      "technicalNotes": [
        "3-dot menu: RainbowAI/src/public/templates/tabs/live-chat.html â€” find the vertical ellipsis menu in the chat header",
        "Menu JS: RainbowAI/src/public/js/modules/live-chat-actions.js or live-chat-panels.js",
        "Add menu item that calls window.openPrismaWindow() (to be implemented in US-010)",
        "For now: show an alert or empty div if Prisma window doesn't exist yet"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-010",
      "title": "Build Prisma AI floating chat window UI",
      "priority": 18,
      "description": "As a staff member, I want a draggable Prisma AI floating chat panel with a source selector and conversation history so I can ask questions without leaving the live chat. The panel is launched from the Ask AI menu entry (US-009).",
      "acceptanceCriteria": [
        "A floating panel appears with: title 'Prisma AI âœ¦', close (âœ•) button, source selector chips, message input, send button, scrollable response history",
        "Source selector shows 4 chip options: Knowledge Base | MCP Server | All History | Internet (default: Knowledge Base)",
        "Conversation history within the panel persists for the current browser session (JS in-memory state)",
        "User messages appear right-aligned; Prisma responses appear left-aligned with avatar",
        "A loading indicator (typing dots) appears while waiting for a response",
        "Panel can be minimised to a floating 'Ask Prisma âœ¦' button at bottom-right corner",
        "Panel does NOT interfere with the main guest message input area",
        "Responses use mock/placeholder text until US-011 wires up the backend",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: launch Prisma panel, select source, type a question, confirm UI renders"
      ],
      "technicalNotes": [
        "Create new JS module: RainbowAI/src/public/js/modules/prisma-ai.js (or add to live-chat-actions.js)",
        "CSS: Add floating panel styles to rainbow-livechat-ui.css â€” position:fixed, bottom:80px, right:20px, z-index:1000",
        "Draggable: use mousedown/mousemove/mouseup events on the panel header to implement drag",
        "Minimise: toggle between full panel and compact button using CSS class toggle",
        "window.openPrismaWindow() / window.closePrismaWindow() global functions for US-009 integration",
        "Session history: module-level array var prismaHistory = [] that resets when panel is closed"
      ],
      "dependencies": [
        "US-009"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-011",
      "title": "Wire Prisma AI to Knowledge Base and AI provider",
      "priority": 19,
      "description": "As a staff member using Prisma with 'Knowledge Base' source, I want Prisma to answer from the Rainbow KB files so I get accurate hostel-specific answers. This story adds the backend endpoint and wires it to the UI.",
      "acceptanceCriteria": [
        "New admin API endpoint POST /api/rainbow/prisma/ask added and mounted in RainbowAI/src/routes/admin/index.ts",
        "Endpoint accepts { question, source, conversationHistory } and returns { answer, sourceUsed }",
        "When source = 'knowledge_base', endpoint queries existing KB (knowledge-base.ts / .rainbow-kb/) and passes relevant chunks to active AI provider",
        "Response includes which KB topic files were consulted (for transparency in the UI)",
        "Errors return graceful fallback: 'I couldn't find an answer in the knowledge base. Try asking differently or choose a different source.'",
        "Prisma UI (US-010) calls this endpoint and renders the response in the chat panel",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: ask Prisma a hostel question with KB source, confirm a real answer appears"
      ],
      "technicalNotes": [
        "New route file: RainbowAI/src/routes/admin/prisma.ts (or add to conversations.ts)",
        "KB access: import { loadRelevantKBContent } from '../../../assistant/knowledge-base' or equivalent",
        "AI call: use existing chatWithFallback() or callAI() from ai-client.ts",
        "Endpoint must be authenticated: check X-Admin-Key header in production (RAINBOW_ROLE=primary)",
        "Mount in: RainbowAI/src/routes/admin/index.ts â€” app.use('/prisma', prismaRouter)"
      ],
      "dependencies": [
        "US-010"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-012",
      "title": "Add MCP Server, All History, and Internet sources to Prisma AI",
      "priority": 20,
      "description": "As a staff member, I want to select MCP Server, All History, or Internet as Prisma's source to get context-aware answers beyond the knowledge base. Each source adds different context to the AI prompt.",
      "acceptanceCriteria": [
        "When source = 'mcp_server': Prisma calls available MCP tools (booking lookup, capsule availability) and includes tool results in the answer",
        "When source = 'all_history': Prisma receives the full conversation history of the currently open conversation as context",
        "When source = 'internet': Prisma uses an internet-capable AI provider or performs a web search if configured â€” cites sources in answer",
        "Source label appears in each Prisma response bubble so staff know what was consulted",
        "If a source is unavailable (no internet provider configured), the chip is greyed out with tooltip explaining why",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser: test each source type, confirm responses reference the correct context"
      ],
      "technicalNotes": [
        "Extend POST /api/rainbow/prisma/ask endpoint (US-011) to handle source: 'mcp_server' | 'all_history' | 'internet'",
        "MCP tools: check RainbowAI/src/tools/ for available tool definitions to call for mcp_server source",
        "All history: the frontend sends the currently loaded conversation messages along with the question",
        "Internet: if the active AI provider supports web search (e.g. Perplexity, or a provider with search), use it; otherwise return unavailable message",
        "The frontend prisma-ai.js should include currentConversationMessages when source = all_history"
      ],
      "dependencies": [
        "US-011"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-013",
      "title": "Prisma AI session conversation memory",
      "priority": 21,
      "description": "As a staff member having a multi-turn conversation with Prisma, I want Prisma to remember earlier messages in the session so follow-up questions work naturally (e.g. 'what about weekends?' after 'what is the check-in time?').",
      "acceptanceCriteria": [
        "POST /api/rainbow/prisma/ask accepts a conversationHistory array (role/content pairs) and includes it in the AI prompt",
        "Frontend sends the full session history on each new message (prismaHistory array from US-010)",
        "After 20 exchanges, history is trimmed to the last 20 messages (client-side) to avoid token overflow",
        "Closing Prisma window (âœ•) and re-opening resets the session history to empty",
        "Follow-up questions in the same session demonstrate context awareness in responses",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser: ask Prisma a question, then ask a follow-up referencing the first answer, confirm it responds correctly"
      ],
      "technicalNotes": [
        "Client-side: prisma-ai.js already has prismaHistory array (US-010) â€” pass it as conversationHistory in each POST request",
        "Trim: if (prismaHistory.length > 40) prismaHistory = prismaHistory.slice(-40); // 40 role/content items = 20 exchanges",
        "Server-side: prepend conversationHistory to the AI messages array before calling the provider",
        "Reset on close: prismaHistory = [] when the panel close (âœ•) button is clicked",
        "No server-side storage needed â€” purely stateless endpoint that receives history each time"
      ],
      "dependencies": [
        "US-011"
      ],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-015",
      "title": "Mirror all Phase 3 features in chat-simulator/live-simulation",
      "priority": 22,
      "description": "As a staff member testing via Chat Simulator live-simulation mode, I want all new live-chat features to also work in that tab so I can test the full experience without switching tabs. All features from US-003 through US-014 must be mirrored.",
      "acceptanceCriteria": [
        "WhatsApp-style filter chips (US-003/US-004) appear and function in the simulator's conversation list panel",
        "Message action menu (US-005) appears correctly positioned in the simulator's message thread",
        "Translate toggle (US-006) works in the simulator",
        "Colored initials avatars (US-007) render in the simulator's contact list",
        "Schedule message with full datetime editing (US-008) works in the simulator",
        "'Ask AI â€” Prisma' menu entry (US-009) and full Prisma window (US-010 to US-013) are accessible from the simulator",
        "Date-jump search (US-014) works in the simulator",
        "All features reuse the same JS modules as live-chat (no code duplication)",
        "TypeScript compiles with zero errors",
        "Server starts and dashboard loads without errors",
        "Verify in browser using agent-browser: open #chat-simulator/live-simulation, confirm each feature is present and functional"
      ],
      "technicalNotes": [
        "Chat simulator template: RainbowAI/src/public/templates/tabs/chat-simulator.html",
        "Live simulation sub-tab: find the live-simulation section within chat-simulator.html",
        "Shared modules: all features built in US-003 to US-014 use JS modules that should already be loaded in chat-simulator context",
        "Verify module-chunks: RainbowAI/src/public/js/module-chunks/ â€” check if live-chat modules are bundled into chat-simulator chunk",
        "If any feature is chat-simulator-specific HTML missing, add the required DOM elements (filter bar, search bar, action menus)",
        "CSS: all styles are global in rainbow-livechat-core.css and rainbow-livechat-ui.css â€” no extra CSS needed"
      ],
      "dependencies": [
        "US-003",
        "US-004",
        "US-005",
        "US-006",
        "US-007",
        "US-008",
        "US-009",
        "US-010",
        "US-011",
        "US-012",
        "US-013",
        "US-014"
      ],
      "estimatedComplexity": "large",
      "passes": true
    },
    {
      "id": "US-023",
      "title": "Fix admin auth blocking Rainbow AI dashboard tabs at production IP",
      "priority": 1,
      "description": "As a staff member accessing the Rainbow AI dashboard at http://18.142.14.142:3002, I want all tabs (#dashboard, #live-chat, #understanding) to load without 'Failed to load X tab' errors. Root cause: the adminAuth middleware in the production dist requires an X-Admin-Key header for all remote (non-localhost) requests, but the browser JS was not sending it. Secondary cause: tabs.js, template-loader.js, help.js all use raw fetch() calls that bypass the api() utility which sends the header.",
      "acceptanceCriteria": [
        "Set RAINBOW_ADMIN_KEY=pelangi-admin-2026 in /var/www/pelangi/RainbowAI/.env",
        "Set CORS_ORIGIN=http://18.142.14.142:3002 in /var/www/pelangi/RainbowAI/.env",
        "Inject window.__ADMIN_KEY__ + fetch interceptor into served HTML via getDashboardHtml() in index.ts",
        "Fetch interceptor auto-adds X-Admin-Key header to ALL /api/rainbow/* requests including raw fetch() calls",
        "Navigate to http://18.142.14.142:3002/#dashboard â€” tab loads without 'Failed to load' error",
        "Navigate to http://18.142.14.142:3002/#live-chat â€” loads cleanly",
        "Navigate to http://18.142.14.142:3002/#understanding â€” loads cleanly"
      ],
      "technicalNotes": [
        "Real root cause: adminAuth middleware blocks remote IPs unless X-Admin-Key header matches RAINBOW_ADMIN_KEY env var",
        "CORS was a secondary symptom (also fixed via CORS_ORIGIN env var)",
        "tabs.js, template-loader.js, help.js, intent-manager.js all use raw fetch() not api() â€” so utils.js header injection alone is insufficient",
        "Fix: inject a window.fetch interceptor in getDashboardHtml() that auto-adds X-Admin-Key to all /api/rainbow/ requests",
        "Production dist patched: dist/public/rainbow-admin.html has fetch interceptor injected; dist/index.js restored from bak2 + watchdog no-op",
        "Local source updated: index.ts getDashboardHtml() now injects full fetch interceptor (not just window.__ADMIN_KEY__)"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    }
  ],
  "technicalContext": {
    "affectedAreas": [
      "RainbowAI/src/public/js/modules/live-chat-actions.js",
      "RainbowAI/src/public/js/modules/live-chat-core.js",
      "RainbowAI/src/public/js/modules/live-chat-panels.js",
      "RainbowAI/src/public/js/modules/live-chat.js",
      "RainbowAI/src/public/js/modules/settings-ai-models.js",
      "RainbowAI/src/public/js/modules/prisma-ai.js",
      "RainbowAI/src/public/templates/tabs/live-chat.html",
      "RainbowAI/src/public/templates/tabs/settings.html",
      "RainbowAI/src/public/templates/tabs/chat-simulator.html",
      "RainbowAI/src/public/css/rainbow-livechat-core.css",
      "RainbowAI/src/public/css/rainbow-livechat-ui.css",
      "RainbowAI/src/routes/admin/index.ts",
      "RainbowAI/src/routes/admin/intent-analytics.ts",
      "RainbowAI/src/routes/admin/conversations.ts",
      "RainbowAI/src/routes/admin/tags.ts",
      "RainbowAI/src/routes/admin/capsules.ts",
      "RainbowAI/src/routes/admin/prisma.ts",
      "RainbowAI/src/assistant/data/settings.json",
      "RainbowAI/src/assistant/data/routing.json",
      "RainbowAI/src/assistant/data/workflows.json",
      "RainbowAI/src/assistant/data/intent-keywords.json",
      "RainbowAI/src/assistant/message-router.ts",
      "RainbowAI/src/assistant/knowledge-base.ts",
      "RainbowAI/src/assistant/pipeline/stages/action-dispatch.ts",
      "server/index.ts",
      "server/routes/"
    ],
    "newFiles": [
      "RainbowAI/src/routes/admin/prisma.ts",
      "RainbowAI/src/public/js/modules/prisma-ai.js"
    ],
    "testingStrategy": "Bug fixes verified via agent-browser before marking complete. Intent/workflow changes run 50-scenario accuracy test. UI changes verified in both #live-chat and #chat-simulator/live-simulation. TypeScript compilation check after every story.",
    "rollbackPlan": "git checkout HEAD -- RainbowAI/src/public/ RainbowAI/src/routes/ RainbowAI/src/assistant/data/ server/index.ts",
    "crossCuttingConcerns": {
      "agentBrowserVerification": "All UI stories must be verified using agent-browser before marking complete",
      "accuracyTest": "All intent and workflow changes must maintain 100% on 50-scenario accuracy test",
      "importBoundaries": "RainbowAI/ must have ZERO imports from server/, client/, or shared/ â€” HTTP fetch only for cross-module data",
      "atomicWrites": "All new JSON data files use config-store.ts atomic write pattern (.tmp then renameSync)",
      "cssConvention": "All new UI components use existing CSS files â€” no inline styles, no new stylesheet files"
    }
  }
}
