<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rainbow Admin Dashboard</title>

  <!-- Prevent caching for better development experience -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast { animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; } }
    .tab-active { border-bottom: 2px solid #6366f1; color: #6366f1; font-weight: 600; }
    .spinner { border: 3px solid #e5e7eb; border-top-color: #6366f1; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.6s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    .animate-bounce { animation: bounce 1s infinite; }
    textarea { font-family: ui-monospace, SFMono-Regular, monospace; font-size: 0.85rem; }
    .badge-warn { background: #fef3c7; color: #92400e; font-size: 0.65rem; padding: 1px 6px; border-radius: 9999px; }
    .badge-info { background: #dbeafe; color: #1e40af; font-size: 0.65rem; padding: 1px 6px; border-radius: 9999px; }
    .kb-preview { font-family: system-ui, sans-serif; font-size: 0.9rem; line-height: 1.6; }
    .kb-preview h1 { font-size: 1.5rem; font-weight: 700; margin: 1rem 0 0.5rem; }
    .kb-preview h2 { font-size: 1.25rem; font-weight: 600; margin: 0.8rem 0 0.4rem; }
    .kb-preview h3 { font-size: 1.1rem; font-weight: 600; margin: 0.6rem 0 0.3rem; }
    .kb-preview p { margin: 0.4rem 0; }
    .kb-preview ul, .kb-preview ol { margin: 0.4rem 0 0.4rem 1.5rem; }
    .kb-preview li { margin: 0.2rem 0; }
    .kb-preview code { background: #f3f4f6; padding: 1px 4px; border-radius: 3px; font-size: 0.85em; }
    .kb-preview strong { font-weight: 600; }
    .kb-preview em { font-style: italic; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

<!-- Header -->
<header class="bg-white border-b shadow-sm">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <span class="text-2xl">ğŸŒˆ</span>
      <h1 class="text-xl font-bold text-gray-800">Rainbow</h1>
      <span id="wa-badge" class="text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600">...</span>
    </div>
    <button onclick="reloadConfig()" class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded-md transition">Reload Config</button>
  </div>
</header>

<!-- Tabs -->
<nav class="bg-white border-b">
  <div class="max-w-6xl mx-auto px-4 flex gap-0 overflow-x-auto">
    <button class="tab-btn tab-active px-4 py-3 text-sm whitespace-nowrap transition" data-tab="status">Status</button>
    <button class="tab-btn px-4 py-3 text-sm whitespace-nowrap text-gray-500 hover:text-gray-700 transition" data-tab="intents">Intents & Routing</button>
    <button class="tab-btn px-4 py-3 text-sm whitespace-nowrap text-gray-500 hover:text-gray-700 transition" data-tab="static-replies">Static Replies</button>
    <button class="tab-btn px-4 py-3 text-sm whitespace-nowrap text-gray-500 hover:text-gray-700 transition" data-tab="kb">Knowledge Base</button>
    <button class="tab-btn px-4 py-3 text-sm whitespace-nowrap text-gray-500 hover:text-gray-700 transition" data-tab="preview">Preview</button>
    <button class="tab-btn px-4 py-3 text-sm whitespace-nowrap text-gray-500 hover:text-gray-700 transition" data-tab="workflow">Workflow</button>
    <button class="tab-btn px-4 py-3 text-sm whitespace-nowrap text-gray-500 hover:text-gray-700 transition" data-tab="settings">Settings</button>
  </div>
</nav>

<!-- Content -->
<main class="max-w-6xl mx-auto px-4 py-6">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Status Tab -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="tab-status" class="tab-content">
    <!-- WhatsApp Instances (Most Important) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="bg-white rounded-lg border p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-gray-700">WhatsApp Instances</h3>
          <button onclick="showAddInstance()" class="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded transition">+ Add Number</button>
        </div>
        <div id="wa-instances" class="space-y-2 text-sm text-gray-600">Loading...</div>
      </div>
      <div class="bg-white rounded-lg border p-5">
        <h3 class="font-semibold text-gray-700 mb-3">AI Availability</h3>
        <div id="ai-status" class="space-y-2 text-sm text-gray-600">Loading...</div>
      </div>
    </div>

    <!-- Server Status -->
    <div class="mb-4 bg-white rounded-lg border p-5">
      <h3 class="font-semibold text-gray-700 mb-3">ğŸ–¥ï¸ Server Status</h3>
      <div id="server-status" class="grid grid-cols-1 md:grid-cols-3 gap-4">Loading...</div>
    </div>

    <div class="bg-white rounded-lg border p-5">
      <h3 class="font-semibold text-gray-700 mb-3">Config Files</h3>
      <div id="config-files" class="flex flex-wrap gap-2 text-sm"></div>
    </div>

    <!-- Add Instance Modal -->
    <div id="add-instance-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-semibold mb-4">Add WhatsApp Number</h3>
        <form id="add-instance-form" onsubmit="submitAddInstance(event)">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
            <div class="flex items-center gap-1">
              <span class="text-sm text-gray-500 font-medium">+60</span>
              <input id="add-inst-phone" class="flex-1 border rounded-md px-3 py-2 text-sm" placeholder="167052004" inputmode="numeric" required
                title="Malaysian phone number without leading 0 or country code" oninput="onPhoneInput(this)" />
            </div>
            <p id="add-inst-phone-hint" class="text-xs text-gray-400 mt-1">Enter the number without leading 0. Example: <b>167052004</b> for 016-705 2004</p>
            <p id="add-inst-phone-error" class="text-xs text-red-500 mt-1 hidden"></p>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Label <span class="text-gray-400 font-normal">(optional)</span></label>
            <input id="add-inst-label" class="w-full border rounded-md px-3 py-2 text-sm" placeholder="e.g. Front Desk, Reception" />
          </div>
          <div id="add-inst-preview" class="hidden mb-4 bg-gray-50 rounded-md p-3 text-xs text-gray-600">
            <div>Instance ID: <code id="add-inst-preview-id" class="font-mono text-indigo-600"></code></div>
            <div>Label: <span id="add-inst-preview-label" class="font-medium"></span></div>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeModal('add-instance-modal')" class="px-3 py-1.5 text-sm text-gray-600 border rounded-md hover:bg-gray-50">Cancel</button>
            <button type="submit" id="add-inst-submit" class="px-3 py-1.5 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Create & Connect</button>
          </div>
        </form>
      </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4 text-center">
        <h3 class="text-lg font-semibold mb-2">Scan QR Code</h3>
        <p id="qr-modal-label" class="text-sm text-gray-500 mb-4"></p>
        <div id="qr-modal-content" class="mb-4"><div class="spinner mx-auto"></div></div>
        <p class="text-xs text-gray-500 mb-4">Open WhatsApp â†’ Linked Devices â†’ Link a Device</p>
        <button onclick="closeQRModal()" class="px-3 py-1.5 text-sm text-gray-600 border rounded-md hover:bg-gray-50">Close</button>
      </div>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Intents & Routing Tab -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="tab-intents" class="tab-content hidden">
    <div class="mb-4">
      <h2 class="text-lg font-semibold text-gray-800">Intents & Routing</h2>
      <p class="text-sm text-gray-500">Define intents the LLM classifies into, and control how each one is handled.</p>
    </div>

    <div class="bg-white border rounded-lg p-5 mb-4">
      <h3 class="font-semibold text-gray-700 mb-3">Architecture</h3>
      <div class="text-sm text-gray-600 space-y-1">
        <p>1. <span class="font-mono text-red-600">Emergency regex</span> â€” fire, stolen, assault â†’ instant staff escalation</p>
        <p>2. <span class="font-mono text-indigo-600">LLM classifies intent</span> from the defined list below</p>
        <p>3. <span class="font-mono text-green-600">Routing rule</span> determines handling: static reply, LLM response, booking, escalation, or payment forwarding</p>
      </div>
    </div>

    <!-- Test Classifier -->
    <div class="bg-white border rounded-lg p-5 mb-4">
      <h3 class="font-semibold text-gray-700 mb-3">Test Classifier</h3>
      <p class="text-sm text-gray-500 mb-3">Send a test message to see how Rainbow classifies it and which routing rule applies.</p>
      <div class="flex gap-2 mb-3">
        <input id="test-input" class="flex-1 border rounded-md px-3 py-2 text-sm" placeholder="Type a guest message, e.g. 'what's the wifi password?'" onkeydown="if(event.key==='Enter')testClassifier()" />
        <button onclick="testClassifier()" class="text-sm bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition">Test</button>
      </div>
      <div id="test-result" class="hidden">
        <div class="bg-gray-50 rounded-md p-4 text-sm space-y-2">
          <div class="flex gap-4">
            <span class="text-gray-500 w-24">Intent:</span>
            <span id="test-intent" class="font-medium"></span>
          </div>
          <div class="flex gap-4">
            <span class="text-gray-500 w-24">LLM Action:</span>
            <span id="test-action" class="font-mono text-indigo-600"></span>
          </div>
          <div class="flex gap-4">
            <span class="text-gray-500 w-24">Routed To:</span>
            <span id="test-routed" class="font-mono text-green-700 font-medium"></span>
          </div>
          <div class="flex gap-4">
            <span class="text-gray-500 w-24">Confidence:</span>
            <span id="test-confidence" class="font-medium"></span>
          </div>
          <div class="mt-2 pt-2 border-t">
            <span class="text-gray-500 block mb-1">Response:</span>
            <div id="test-response" class="whitespace-pre-wrap text-gray-800"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Intent Table -->
    <div class="bg-white border rounded-lg p-5 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-700">Intent Routing Table</h3>
        <button onclick="showAddIntent()" class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-md transition">+ Add Intent</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b text-left text-gray-500">
              <th class="py-2 pr-3 font-medium">Intent</th>
              <th class="py-2 pr-3 font-medium">Enabled</th>
              <th class="py-2 pr-3 font-medium">Routing</th>
              <th class="py-2 pr-3 font-medium">Static Reply?</th>
              <th class="py-2 font-medium">Actions</th>
            </tr>
          </thead>
          <tbody id="intents-table-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Add Intent Modal -->
    <div id="add-intent-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
        <h3 class="text-lg font-semibold mb-4">Add Intent</h3>
        <form onsubmit="submitAddIntent(event)">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Category (snake_case)</label>
            <input id="add-i-category" class="w-full border rounded-md px-3 py-2 text-sm" required placeholder="e.g. breakfast_info" />
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Routing Action</label>
            <select id="add-i-routing" class="w-full border rounded-md px-3 py-2 text-sm">
              <option value="llm_reply">LLM Reply</option>
              <option value="static_reply">Static Reply</option>
              <option value="start_booking">Start Booking</option>
              <option value="escalate">Escalate</option>
              <option value="forward_payment">Forward Payment</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Regex Patterns (one per line, optional)</label>
            <textarea id="add-i-patterns" rows="3" class="w-full border rounded-md px-3 py-2 text-sm" placeholder="\\b(keyword)\\b"></textarea>
          </div>
          <div class="mb-3 flex items-center gap-2">
            <input type="checkbox" id="add-i-enabled" checked />
            <label for="add-i-enabled" class="text-sm text-gray-700">Enabled</label>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeModal('add-intent-modal')" class="px-3 py-1.5 text-sm text-gray-600 border rounded-md hover:bg-gray-50">Cancel</button>
            <button type="submit" class="px-3 py-1.5 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600">Save</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Static Replies Tab (merged System Messages + FAQ) -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="tab-static-replies" class="tab-content hidden">
    <div class="mb-4">
      <h2 class="text-lg font-semibold text-gray-800">Static Replies</h2>
      <p class="text-sm text-gray-500">Pre-written responses for intents routed to "Static Reply", plus system messages (errors, rate limits, etc.).</p>
    </div>

    <!-- Validation Warnings -->
    <div id="static-warnings" class="mb-4 space-y-2"></div>

    <!-- Intent Replies (from knowledge.json) -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-gray-700">Intent Replies</h3>
          <span class="badge-info">knowledge.json</span>
        </div>
        <button onclick="showAddKnowledge('static')" class="text-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-md transition">+ Add Reply</button>
      </div>
      <div id="static-intent-replies" class="space-y-3"></div>
    </div>

    <!-- System Messages (from templates.json) -->
    <div>
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-gray-700">System Messages</h3>
          <span class="badge-info">templates.json</span>
        </div>
        <button onclick="showAddTemplate()" class="text-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-md transition">+ Add Template</button>
      </div>
      <div id="static-templates" class="space-y-3"></div>
    </div>

    <!-- Add Knowledge Modal -->
    <div id="add-knowledge-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
        <h3 class="text-lg font-semibold mb-4">Add Intent Reply</h3>
        <form onsubmit="submitAddKnowledge(event)">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Intent</label>
            <input id="add-k-intent" class="w-full border rounded-md px-3 py-2 text-sm" required placeholder="e.g. breakfast_info" />
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Response (EN) *</label>
            <textarea id="add-k-en" rows="3" class="w-full border rounded-md px-3 py-2 text-sm" required></textarea>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Response (MS)</label>
            <textarea id="add-k-ms" rows="2" class="w-full border rounded-md px-3 py-2 text-sm"></textarea>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Response (ZH)</label>
            <textarea id="add-k-zh" rows="2" class="w-full border rounded-md px-3 py-2 text-sm"></textarea>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeModal('add-knowledge-modal')" class="px-3 py-1.5 text-sm text-gray-600 border rounded-md hover:bg-gray-50">Cancel</button>
            <button type="submit" class="px-3 py-1.5 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Template Modal -->
    <div id="add-template-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
        <h3 class="text-lg font-semibold mb-4">Add System Message</h3>
        <form onsubmit="submitAddTemplate(event)">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Key</label>
            <input id="add-t-key" class="w-full border rounded-md px-3 py-2 text-sm" required placeholder="e.g. welcome_back" />
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">English *</label>
            <textarea id="add-t-en" rows="2" class="w-full border rounded-md px-3 py-2 text-sm" required></textarea>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Malay</label>
            <textarea id="add-t-ms" rows="2" class="w-full border rounded-md px-3 py-2 text-sm"></textarea>
          </div>
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Chinese</label>
            <textarea id="add-t-zh" rows="2" class="w-full border rounded-md px-3 py-2 text-sm"></textarea>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" onclick="closeModal('add-template-modal')" class="px-3 py-1.5 text-sm text-gray-600 border rounded-md hover:bg-gray-50">Cancel</button>
            <button type="submit" class="px-3 py-1.5 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600">Save</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Knowledge Base Tab -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="tab-kb" class="tab-content hidden">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-800">Knowledge Base</h2>
        <p class="text-sm text-gray-500">Edit the markdown that Rainbow uses when an intent is routed to "LLM Reply". Changes take effect immediately.</p>
      </div>
    </div>

    <div class="bg-white border rounded-lg p-5 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-700">pelangi-kb.md</h3>
        <div class="flex gap-2">
          <button onclick="toggleKBPreview()" id="kb-preview-btn" class="text-sm border border-gray-300 hover:bg-gray-50 px-3 py-1.5 rounded-md transition">Preview</button>
          <button onclick="saveKB()" class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded-md transition">Save</button>
        </div>
      </div>
      <div id="kb-editor-container">
        <textarea id="kb-editor" rows="24" class="w-full border rounded-md px-4 py-3 text-sm leading-relaxed resize-y" placeholder="Loading..."></textarea>
      </div>
      <div id="kb-preview-container" class="hidden border rounded-md px-4 py-3 bg-gray-50 min-h-[200px] max-h-[600px] overflow-y-auto kb-preview"></div>
      <p class="text-xs text-gray-400 mt-2">Tip: Use ## headings for topics. This content is used when an intent is routed to "LLM Reply".</p>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Preview Tab -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="tab-preview" class="tab-content hidden">
    <div class="mb-4">
      <h2 class="text-lg font-semibold text-gray-800">AI Agent Preview</h2>
      <p class="text-sm text-gray-500">Test how the AI agent responds to guest messages in real-time</p>
    </div>

    <!-- Chat Container -->
    <div class="bg-white border rounded-lg overflow-hidden flex flex-col" style="height: 600px;">
      <!-- Chat Header -->
      <div class="bg-indigo-50 border-b px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-2xl">ğŸ’¬</span>
          <div>
            <h3 class="font-semibold text-gray-800">Guest Simulation</h3>
            <p class="text-xs text-gray-500">Messages are processed using the current Rainbow configuration</p>
          </div>
        </div>
        <button onclick="clearChat()" class="text-sm bg-white border border-gray-300 hover:bg-gray-50 px-3 py-1.5 rounded-md transition">Clear Chat</button>
      </div>

      <!-- Chat Messages -->
      <div id="chat-messages" class="flex-1 overflow-y-auto px-4 py-4 space-y-3 bg-gray-50">
        <div class="text-center text-gray-400 text-sm py-8">
          <p>ğŸ‘‹ Start a conversation by typing a message below</p>
          <p class="text-xs mt-1">Try: "What's the wifi password?" or "I want to book a room"</p>
        </div>
      </div>

      <!-- Chat Input -->
      <div class="border-t bg-white px-4 py-3">
        <form onsubmit="sendChatMessage(event)" class="flex gap-2">
          <input
            id="chat-input"
            type="text"
            class="flex-1 border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="Type a message as a guest..."
            autocomplete="off"
          />
          <button
            type="submit"
            id="send-btn"
            class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Send
          </button>
        </form>
        <div id="chat-meta" class="mt-2 text-xs text-gray-500"></div>
      </div>
    </div>

    <!-- Info Card -->
    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h3 class="font-semibold text-blue-900 mb-2">How Preview Works</h3>
      <ul class="text-sm text-blue-800 space-y-1">
        <li>â€¢ Messages are processed by the AI agent using your current configuration</li>
        <li>â€¢ Intent classification, routing rules, and responses are applied in real-time</li>
        <li>â€¢ Conversation history is maintained during the session</li>
        <li>â€¢ Use "Clear Chat" to start a fresh conversation</li>
      </ul>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Workflow Tab -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="tab-workflow" class="tab-content hidden">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Workflow Configuration</h2>
    <div id="workflow-content" class="space-y-4"></div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Settings Tab -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="tab-settings" class="tab-content hidden">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Settings</h2>
    <div id="settings-content" class="space-y-4"></div>
  </section>

</main>

<script>
const API = '/api/rainbow';
let cachedRouting = {};
let cachedKnowledge = { static: [], dynamic: {} };

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  const colors = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
  el.className = `toast ${colors} text-white text-sm px-4 py-2 rounded-lg shadow-lg`;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// â”€â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path, opts = {}) {
  const res = await fetch(API + path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts,
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

// â”€â”€â”€ Tabs (URL-based routing) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BASE_PATH = '/admin/rainbow';
const VALID_TABS = ['status', 'intents', 'static-replies', 'kb', 'preview', 'workflow', 'settings'];

function getTabFromURL() {
  const seg = window.location.pathname.replace(BASE_PATH, '').replace(/^\//, '').split('/')[0];
  return VALID_TABS.includes(seg) ? seg : 'status';
}

function switchTab(tab, pushState = true) {
  document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('tab-active'); b.classList.add('text-gray-500'); });
  const active = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
  if (active) { active.classList.add('tab-active'); active.classList.remove('text-gray-500'); }
  document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
  document.getElementById('tab-' + tab).classList.remove('hidden');
  if (pushState) history.pushState(null, '', BASE_PATH + '/' + tab);
  loadTab(tab);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

window.addEventListener('popstate', () => switchTab(getTabFromURL(), false));

function loadTab(tab) {
  const loaders = {
    status: loadStatus,
    intents: loadIntents,
    'static-replies': loadStaticReplies,
    kb: loadKB,
    preview: loadPreview,
    settings: loadSettings,
    workflow: loadWorkflow
  };
  if (loaders[tab]) loaders[tab]();
}

// â”€â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// â”€â”€â”€ Reload Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function reloadConfig() {
  try {
    await api('/reload', { method: 'POST' });
    toast('Config reloaded from disk');
    const activeTab = document.querySelector('.tab-active')?.dataset.tab || 'status';
    loadTab(activeTab);
  } catch (e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Status Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStatus() {
  try {
    const d = await api('/status');
    const instances = d.whatsappInstances || [];
    const connectedCount = instances.filter(i => i.state === 'open').length;
    const totalCount = instances.length;

    // Update server status
    const servers = d.servers || {};
    const serverStatusEl = document.getElementById('server-status');
    serverStatusEl.innerHTML = Object.values(servers).map(server => {
      const statusColor = server.online ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
      const statusIcon = server.online ? 'âœ“' : 'âœ—';
      const responseTime = server.responseTime !== undefined ? `${server.responseTime}ms` : 'N/A';
      return `
        <div class="border rounded-lg p-4 ${server.online ? 'border-green-200' : 'border-red-200'}">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-medium text-gray-800">${esc(server.name)}</h4>
            <span class="${statusColor} px-2 py-1 rounded-full text-xs font-medium">${statusIcon} ${server.online ? 'Online' : 'Offline'}</span>
          </div>
          <div class="text-sm text-gray-600 space-y-1">
            <div class="flex justify-between">
              <span class="text-gray-500">Port:</span>
              <span class="font-mono font-medium">${server.port}</span>
            </div>
            ${server.online ? `
              <div class="flex justify-between">
                <span class="text-gray-500">Response:</span>
                <span class="font-mono text-green-600">${responseTime}</span>
              </div>
            ` : `
              <div class="flex justify-between">
                <span class="text-gray-500">Error:</span>
                <span class="font-mono text-red-600 text-xs">${esc(server.error || 'Unknown')}</span>
              </div>
            `}
            ${server.url ? `
              <div class="mt-2">
                <a href="${server.url}" target="_blank" class="text-xs text-indigo-600 hover:text-indigo-700 underline">Open â†’</a>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');

    const badge = document.getElementById('wa-badge');
    if (totalCount === 0) {
      badge.textContent = 'no instances';
      badge.className = 'text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600';
    } else {
      badge.textContent = `${connectedCount}/${totalCount} connected`;
      badge.className = 'text-xs px-2 py-0.5 rounded-full ' +
        (connectedCount === totalCount ? 'bg-green-100 text-green-700' :
         connectedCount > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700');
    }

    const el = document.getElementById('wa-instances');
    if (totalCount === 0) {
      el.innerHTML = '<p class="text-gray-400">No WhatsApp instances. Click "+ Add Number" to connect one.</p>';
    } else {
      el.innerHTML = instances.map(i => `
        <div class="flex items-center justify-between py-2 border-b last:border-0">
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full flex-shrink-0 ${i.state === 'open' ? 'bg-green-400' : 'bg-yellow-400'}"></span>
            <div>
              <div class="font-medium text-gray-800">${esc(i.label)}</div>
              <div class="text-xs text-gray-400">${esc(i.id)} ${i.user ? 'â€” ' + esc(i.user.name || '') + ' (' + esc(i.user.phone || '') + ')' : ''}</div>
            </div>
          </div>
          <div class="flex gap-1 flex-shrink-0">
            ${i.state !== 'open' ? `<button onclick="showInstanceQR('${esc(i.id)}', '${esc(i.label)}')" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded transition">QR</button>` : ''}
            ${i.state === 'open' ? `<button onclick="logoutInstance('${esc(i.id)}')" class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded transition">Logout</button>` : ''}
            <button onclick="removeInstance('${esc(i.id)}')" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition">Remove</button>
          </div>
        </div>
      `).join('');
    }

    // AI Availability with all providers
    const aiProviders = d.ai?.providers || [];
    const aiHtml = aiProviders.map(provider => {
      const statusColor = provider.available ? 'bg-green-400' : 'bg-gray-300';
      const typeBadge = provider.type === 'primary'
        ? '<span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded ml-1">Primary</span>'
        : '<span class="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded ml-1">Fallback</span>';
      return `
        <div class="flex items-center justify-between py-1.5 border-b last:border-0">
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full ${statusColor}"></span>
            <span class="font-medium text-gray-800">${esc(provider.name)}</span>
            ${typeBadge}
          </div>
          <span class="text-xs ${provider.available ? 'text-green-600' : 'text-gray-400'}">${esc(provider.details)}</span>
        </div>
      `;
    }).join('');

    const overallStatus = d.ai?.available
      ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-medium">âœ“ Available</span>'
      : '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded font-medium">âœ— Unavailable</span>';

    document.getElementById('ai-status').innerHTML = `
      <div class="flex items-center justify-between mb-3 pb-2 border-b">
        <span class="text-sm font-medium text-gray-700">Overall Status:</span>
        ${overallStatus}
      </div>
      ${aiHtml}
    `;

    document.getElementById('config-files').innerHTML = (d.config_files || [])
      .map(f => `<span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs font-mono">${f}.json</span>`).join('');
  } catch (e) {
    document.getElementById('wa-instances').innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
  }
}

// â”€â”€â”€ Instance Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showAddInstance() {
  document.getElementById('add-inst-phone').value = '';
  document.getElementById('add-inst-label').value = '';
  document.getElementById('add-inst-phone-error').classList.add('hidden');
  document.getElementById('add-inst-preview').classList.add('hidden');
  document.getElementById('add-inst-submit').disabled = true;
  document.getElementById('add-instance-modal').classList.remove('hidden');
  document.getElementById('add-inst-phone').focus();
}

function onPhoneInput(el) {
  el.value = el.value.replace(/\D/g, '');
  const raw = el.value;
  const errEl = document.getElementById('add-inst-phone-error');
  const previewEl = document.getElementById('add-inst-preview');
  const submitBtn = document.getElementById('add-inst-submit');

  if (raw.startsWith('0')) {
    el.value = raw.slice(1);
    errEl.textContent = 'Leading 0 removed automatically';
    errEl.classList.remove('hidden', 'text-red-500');
    errEl.classList.add('text-yellow-600');
    setTimeout(() => errEl.classList.add('hidden'), 3000);
  }

  const phone = el.value;
  const fullNumber = '60' + phone;

  if (phone.length === 0) { errEl.classList.add('hidden'); previewEl.classList.add('hidden'); submitBtn.disabled = true; return; }
  if (!phone.startsWith('1')) { errEl.textContent = 'Malaysian mobile numbers start with 1'; errEl.classList.remove('hidden', 'text-yellow-600'); errEl.classList.add('text-red-500'); previewEl.classList.add('hidden'); submitBtn.disabled = true; return; }
  if (phone.length < 8 || phone.length > 10) { errEl.textContent = phone.length < 8 ? 'Number too short' : 'Number too long'; errEl.classList.remove('hidden', 'text-yellow-600'); errEl.classList.add('text-red-500'); previewEl.classList.add('hidden'); submitBtn.disabled = true; return; }

  errEl.classList.add('hidden');
  const label = document.getElementById('add-inst-label').value.trim();
  document.getElementById('add-inst-preview-id').textContent = fullNumber;
  document.getElementById('add-inst-preview-label').textContent = label || 'WhatsApp +60' + phone;
  previewEl.classList.remove('hidden');
  submitBtn.disabled = false;
}

async function submitAddInstance(e) {
  e.preventDefault();
  const phone = document.getElementById('add-inst-phone').value.trim();
  const fullNumber = '60' + phone;
  const label = document.getElementById('add-inst-label').value.trim() || 'WhatsApp +60' + phone;
  try {
    await api('/whatsapp/instances', { method: 'POST', body: { id: fullNumber, label } });
    toast('Instance created: ' + label);
    closeModal('add-instance-modal');
    loadStatus();
    setTimeout(() => showInstanceQR(fullNumber, label), 500);
  } catch (e) { toast(e.message, 'error'); }
}

async function logoutInstance(id) {
  if (!confirm('Logout this WhatsApp instance?')) return;
  try {
    await api('/whatsapp/instances/' + encodeURIComponent(id) + '/logout', { method: 'POST' });
    toast('Instance logged out');
    loadStatus();
  } catch (e) { toast(e.message, 'error'); }
}

async function removeInstance(id) {
  if (!confirm('Remove instance "' + id + '"?')) return;
  try {
    await api('/whatsapp/instances/' + encodeURIComponent(id), { method: 'DELETE' });
    toast('Instance removed');
    loadStatus();
  } catch (e) { toast(e.message, 'error'); }
}

let qrRefreshInterval = null;

function showInstanceQR(id, label) {
  document.getElementById('qr-modal-label').textContent = label;
  document.getElementById('qr-modal-content').innerHTML = '<div class="spinner mx-auto"></div>';
  document.getElementById('qr-modal').classList.remove('hidden');
  if (qrRefreshInterval) clearInterval(qrRefreshInterval);

  async function fetchQR() {
    try {
      const d = await api('/whatsapp/instances/' + encodeURIComponent(id) + '/qr');
      const el = document.getElementById('qr-modal-content');
      if (d.state === 'open') { el.innerHTML = '<p class="text-green-600 font-medium py-4">Connected!</p>'; clearInterval(qrRefreshInterval); loadStatus(); }
      else if (d.qrDataUrl) { el.innerHTML = `<img src="${d.qrDataUrl}" class="w-64 h-64 mx-auto" />`; }
      else { el.innerHTML = '<p class="text-gray-500 text-sm py-4">Waiting for QR code...</p>'; }
    } catch (e) { document.getElementById('qr-modal-content').innerHTML = `<p class="text-red-500 text-sm">Error: ${e.message}</p>`; clearInterval(qrRefreshInterval); }
  }
  fetchQR();
  qrRefreshInterval = setInterval(fetchQR, 5000);
}

function closeQRModal() {
  document.getElementById('qr-modal').classList.add('hidden');
  if (qrRefreshInterval) { clearInterval(qrRefreshInterval); qrRefreshInterval = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Intents & Routing Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadIntents() {
  try {
    const [intentsData, routingData, knowledgeData] = await Promise.all([
      api('/intents'),
      api('/routing'),
      api('/knowledge')
    ]);

    cachedRouting = routingData;
    cachedKnowledge = knowledgeData;

    const el = document.getElementById('intents-table-body');
    const categories = intentsData.categories || [];
    // Build a set of all intents (from intents.json + routing.json)
    const allIntents = new Set([...categories.map(c => c.category), ...Object.keys(routingData)]);
    const staticIntentNames = new Set(knowledgeData.static.map(e => e.intent));

    const ACTIONS = ['static_reply', 'llm_reply', 'start_booking', 'escalate', 'forward_payment'];
    const ACTION_LABELS = { static_reply: 'Static Reply', llm_reply: 'LLM Reply', start_booking: 'Start Booking', escalate: 'Escalate', forward_payment: 'Forward Payment' };

    const rows = [];
    for (const intent of allIntents) {
      const catEntry = categories.find(c => c.category === intent);
      const route = routingData[intent]?.action || 'llm_reply';
      const enabled = catEntry ? catEntry.enabled : true;
      const hasStatic = staticIntentNames.has(intent);
      const needsStatic = route === 'static_reply';

      let warning = '';
      if (needsStatic && !hasStatic) warning = '<span class="badge-warn">No static reply!</span>';
      if (!needsStatic && hasStatic) warning = '<span class="badge-warn">Unused reply</span>';

      rows.push(`
        <tr class="border-b hover:bg-gray-50" id="intent-row-${css(intent)}">
          <td class="py-2.5 pr-3 font-mono text-sm">${esc(intent)}</td>
          <td class="py-2.5 pr-3">
            <button onclick="toggleIntent('${esc(intent)}', ${!enabled})"
              class="text-xs px-2 py-0.5 rounded-full ${enabled ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-500'} hover:opacity-80">
              ${enabled ? 'On' : 'Off'}
            </button>
          </td>
          <td class="py-2.5 pr-3">
            <select onchange="changeRouting('${esc(intent)}', this.value)" class="text-xs border rounded px-2 py-1">
              ${ACTIONS.map(a => `<option value="${a}" ${route === a ? 'selected' : ''}>${ACTION_LABELS[a]}</option>`).join('')}
            </select>
          </td>
          <td class="py-2.5 pr-3 text-xs">${warning || (hasStatic ? '<span class="text-green-600">Yes</span>' : '<span class="text-gray-400">â€”</span>')}</td>
          <td class="py-2.5">
            <button onclick="deleteIntent('${esc(intent)}')" class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded">Delete</button>
          </td>
        </tr>
      `);
    }

    el.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="5" class="text-gray-400 py-4 text-center">No intents configured</td></tr>';
  } catch (e) { toast(e.message, 'error'); }
}

async function changeRouting(intent, action) {
  try {
    await api('/routing/' + encodeURIComponent(intent), { method: 'PATCH', body: { action } });
    toast(`${intent} â†’ ${action}`);
    cachedRouting[intent] = { action };
  } catch (e) { toast(e.message, 'error'); loadIntents(); }
}

async function toggleIntent(category, enabled) {
  try {
    await api('/intents/' + encodeURIComponent(category), { method: 'PUT', body: { enabled } });
    toast(category + ': ' + (enabled ? 'enabled' : 'disabled'));
    loadIntents();
  } catch (e) { toast(e.message, 'error'); }
}

async function deleteIntent(category) {
  if (!confirm('Delete intent "' + category + '"? This also removes its routing rule.')) return;
  try {
    // Delete from intents.json
    try { await api('/intents/' + encodeURIComponent(category), { method: 'DELETE' }); } catch {}
    // Delete from routing.json
    const routing = { ...cachedRouting };
    delete routing[category];
    await api('/routing', { method: 'PUT', body: routing });
    toast('Deleted: ' + category);
    loadIntents();
  } catch (e) { toast(e.message, 'error'); }
}

function showAddIntent() {
  document.getElementById('add-intent-modal').classList.remove('hidden');
  document.getElementById('add-i-category').value = '';
  document.getElementById('add-i-patterns').value = '';
  document.getElementById('add-i-category').focus();
}

async function submitAddIntent(e) {
  e.preventDefault();
  const category = document.getElementById('add-i-category').value.trim().toLowerCase().replace(/\s+/g, '_');
  const routingAction = document.getElementById('add-i-routing').value;
  const patternsText = document.getElementById('add-i-patterns').value;
  const patterns = patternsText ? patternsText.split('\n').map(s => s.trim()).filter(Boolean) : [];
  const enabled = document.getElementById('add-i-enabled').checked;

  try {
    // Add to intents.json
    await api('/intents', { method: 'POST', body: { category, patterns, flags: 'i', enabled } });
    // Add to routing.json
    await api('/routing/' + encodeURIComponent(category), { method: 'PATCH', body: { action: routingAction } });
    toast('Intent added: ' + category);
    closeModal('add-intent-modal');
    loadIntents();
  } catch (e) { toast(e.message, 'error'); }
}

// â”€â”€â”€ Test Classifier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testClassifier() {
  const input = document.getElementById('test-input');
  const msg = input.value.trim();
  if (!msg) return;

  const resultEl = document.getElementById('test-result');
  resultEl.classList.remove('hidden');
  document.getElementById('test-response').textContent = 'Thinking...';
  document.getElementById('test-intent').textContent = '...';
  document.getElementById('test-action').textContent = '...';
  document.getElementById('test-routed').textContent = '...';
  document.getElementById('test-confidence').textContent = '...';

  try {
    const d = await api('/intents/test', { method: 'POST', body: { message: msg } });
    document.getElementById('test-intent').textContent = d.intent || 'unknown';
    document.getElementById('test-action').textContent = d.action || 'reply';

    // Show the actual routed action
    const routedAction = cachedRouting[d.intent]?.action || d.action;
    document.getElementById('test-routed').textContent = routedAction;

    const conf = typeof d.confidence === 'number' ? (d.confidence * 100).toFixed(0) + '%' : '?';
    document.getElementById('test-confidence').textContent = conf;

    if (routedAction === 'static_reply') {
      const staticEntry = cachedKnowledge.static.find(e => e.intent === d.intent);
      document.getElementById('test-response').textContent = staticEntry
        ? '[STATIC] ' + (staticEntry.response?.en || '(empty)')
        : '[STATIC] (no static reply configured â€” would fall back to LLM)';
    } else {
      document.getElementById('test-response').textContent = d.response || '(empty)';
    }
  } catch (e) {
    document.getElementById('test-response').textContent = 'Error: ' + e.message;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Static Replies Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStaticReplies() {
  try {
    const [knowledgeData, templatesData, routingData] = await Promise.all([
      api('/knowledge'),
      api('/templates'),
      api('/routing')
    ]);

    cachedRouting = routingData;
    cachedKnowledge = knowledgeData;

    // Validation warnings
    const warnings = [];
    const staticIntents = new Set((knowledgeData.static || []).map(e => e.intent));
    for (const [intent, cfg] of Object.entries(routingData)) {
      if (cfg.action === 'static_reply' && !staticIntents.has(intent)) {
        warnings.push(`<div class="bg-yellow-50 border border-yellow-200 rounded-lg px-4 py-2 text-sm text-yellow-800">âš ï¸ Intent <b>"${esc(intent)}"</b> is routed to Static Reply but has no reply configured. <button onclick="switchTab('intents')" class="text-indigo-600 underline">Change routing</button> or add a reply below.</div>`);
      }
    }
    for (const entry of (knowledgeData.static || [])) {
      if (routingData[entry.intent] && routingData[entry.intent].action !== 'static_reply') {
        warnings.push(`<div class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 text-sm text-blue-800">â„¹ï¸ Reply for <b>"${esc(entry.intent)}"</b> exists but intent is routed to <b>${routingData[entry.intent].action}</b>, not static_reply. This reply won't be used.</div>`);
      }
    }
    document.getElementById('static-warnings').innerHTML = warnings.join('');

    // Intent Replies
    const repliesEl = document.getElementById('static-intent-replies');
    if (!knowledgeData.static || knowledgeData.static.length === 0) {
      repliesEl.innerHTML = '<p class="text-gray-400 text-sm">No intent replies configured</p>';
    } else {
      repliesEl.innerHTML = knowledgeData.static.map(e => {
        const route = routingData[e.intent]?.action;
        const isActive = route === 'static_reply';
        return `
        <div class="bg-white border rounded-lg p-4" id="k-static-${css(e.intent)}">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="font-medium text-sm text-indigo-700">${esc(e.intent)}</span>
              ${isActive ? '<span class="badge-info">Active</span>' : `<span class="badge-warn">Not routed (${route || 'none'})</span>`}
            </div>
            <div class="flex gap-1">
              <button onclick="editKnowledgeStatic('${esc(e.intent)}')" class="text-xs px-2 py-1 text-blue-600 hover:bg-blue-50 rounded">Edit</button>
              <button onclick="deleteKnowledge('${esc(e.intent)}')" class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded">Delete</button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm" id="k-static-view-${css(e.intent)}">
            <div><span class="text-gray-400">EN:</span> ${esc(truncate(e.response?.en || '', 120))}</div>
            <div><span class="text-gray-400">MS:</span> ${esc(truncate(e.response?.ms || '', 120))}</div>
            <div><span class="text-gray-400">ZH:</span> ${esc(truncate(e.response?.zh || '', 120))}</div>
          </div>
          <div class="hidden mt-2" id="k-static-edit-${css(e.intent)}">
            <div class="grid grid-cols-1 gap-2 mb-2">
              <div><label class="text-xs text-gray-500">EN</label><textarea class="w-full border rounded px-2 py-1 text-sm" id="k-ed-en-${css(e.intent)}" rows="3">${esc(e.response?.en || '')}</textarea></div>
              <div><label class="text-xs text-gray-500">MS</label><textarea class="w-full border rounded px-2 py-1 text-sm" id="k-ed-ms-${css(e.intent)}" rows="3">${esc(e.response?.ms || '')}</textarea></div>
              <div><label class="text-xs text-gray-500">ZH</label><textarea class="w-full border rounded px-2 py-1 text-sm" id="k-ed-zh-${css(e.intent)}" rows="3">${esc(e.response?.zh || '')}</textarea></div>
            </div>
            <div class="flex gap-2">
              <button onclick="saveKnowledgeStatic('${esc(e.intent)}')" class="text-xs px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600">Save</button>
              <button onclick="cancelEditKnowledge('${css(e.intent)}')" class="text-xs px-3 py-1 border rounded hover:bg-gray-50">Cancel</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    // System Messages
    const tplEl = document.getElementById('static-templates');
    const tplKeys = Object.keys(templatesData);
    if (tplKeys.length === 0) {
      tplEl.innerHTML = '<p class="text-gray-400 text-sm">No system messages</p>';
    } else {
      tplEl.innerHTML = tplKeys.map(k => `
        <div class="bg-white border rounded-lg p-4">
          <div class="flex items-center justify-between mb-2">
            <span class="font-medium text-sm font-mono text-purple-700">${esc(k)}</span>
            <div class="flex gap-1">
              <button onclick="editTemplate('${esc(k)}')" class="text-xs px-2 py-1 text-blue-600 hover:bg-blue-50 rounded">Edit</button>
              <button onclick="deleteTemplate('${esc(k)}')" class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded">Delete</button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm" id="tpl-view-${css(k)}">
            <div><span class="text-gray-400">EN:</span> <span class="whitespace-pre-wrap">${esc(truncate(templatesData[k].en, 120))}</span></div>
            <div><span class="text-gray-400">MS:</span> <span class="whitespace-pre-wrap">${esc(truncate(templatesData[k].ms, 120))}</span></div>
            <div><span class="text-gray-400">ZH:</span> <span class="whitespace-pre-wrap">${esc(truncate(templatesData[k].zh, 120))}</span></div>
          </div>
          <div class="hidden mt-2" id="tpl-edit-${css(k)}">
            <div class="grid grid-cols-1 gap-2 mb-2">
              <div><label class="text-xs text-gray-500">EN</label><textarea class="w-full border rounded px-2 py-1 text-sm" id="tpl-ed-en-${css(k)}" rows="3">${esc(templatesData[k].en)}</textarea></div>
              <div><label class="text-xs text-gray-500">MS</label><textarea class="w-full border rounded px-2 py-1 text-sm" id="tpl-ed-ms-${css(k)}" rows="3">${esc(templatesData[k].ms)}</textarea></div>
              <div><label class="text-xs text-gray-500">ZH</label><textarea class="w-full border rounded px-2 py-1 text-sm" id="tpl-ed-zh-${css(k)}" rows="3">${esc(templatesData[k].zh)}</textarea></div>
            </div>
            <div class="flex gap-2">
              <button onclick="saveTemplate('${esc(k)}')" class="text-xs px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600">Save</button>
              <button onclick="cancelEditTemplate('${css(k)}')" class="text-xs px-3 py-1 border rounded hover:bg-gray-50">Cancel</button>
            </div>
          </div>
        </div>
      `).join('');
    }
  } catch (e) { toast(e.message, 'error'); }
}

// Knowledge CRUD
function editKnowledgeStatic(intent) {
  document.getElementById('k-static-view-' + css(intent)).classList.add('hidden');
  document.getElementById('k-static-edit-' + css(intent)).classList.remove('hidden');
}
function cancelEditKnowledge(id) {
  document.getElementById('k-static-view-' + id).classList.remove('hidden');
  document.getElementById('k-static-edit-' + id).classList.add('hidden');
}
async function saveKnowledgeStatic(intent) {
  const id = css(intent);
  try {
    await api('/knowledge/' + encodeURIComponent(intent), {
      method: 'PUT',
      body: { response: { en: document.getElementById('k-ed-en-' + id).value, ms: document.getElementById('k-ed-ms-' + id).value, zh: document.getElementById('k-ed-zh-' + id).value } }
    });
    toast('Saved: ' + intent);
    loadStaticReplies();
  } catch (e) { toast(e.message, 'error'); }
}
async function deleteKnowledge(intent) {
  if (!confirm('Delete reply for "' + intent + '"?')) return;
  try {
    await api('/knowledge/' + encodeURIComponent(intent), { method: 'DELETE' });
    toast('Deleted: ' + intent);
    loadStaticReplies();
  } catch (e) { toast(e.message, 'error'); }
}

function showAddKnowledge() {
  document.getElementById('add-k-intent').value = '';
  document.getElementById('add-k-en').value = '';
  document.getElementById('add-k-ms').value = '';
  document.getElementById('add-k-zh').value = '';
  document.getElementById('add-knowledge-modal').classList.remove('hidden');
  document.getElementById('add-k-intent').focus();
}

async function submitAddKnowledge(e) {
  e.preventDefault();
  const intent = document.getElementById('add-k-intent').value.trim();
  try {
    await api('/knowledge', {
      method: 'POST',
      body: { intent, response: { en: document.getElementById('add-k-en').value, ms: document.getElementById('add-k-ms').value, zh: document.getElementById('add-k-zh').value } }
    });
    toast('Added: ' + intent);
    closeModal('add-knowledge-modal');
    loadStaticReplies();
  } catch (e) { toast(e.message, 'error'); }
}

// Template CRUD
function editTemplate(key) {
  document.getElementById('tpl-view-' + css(key)).classList.add('hidden');
  document.getElementById('tpl-edit-' + css(key)).classList.remove('hidden');
}
function cancelEditTemplate(id) {
  document.getElementById('tpl-view-' + id).classList.remove('hidden');
  document.getElementById('tpl-edit-' + id).classList.add('hidden');
}
async function saveTemplate(key) {
  const id = css(key);
  try {
    await api('/templates/' + encodeURIComponent(key), {
      method: 'PUT',
      body: { en: document.getElementById('tpl-ed-en-' + id).value, ms: document.getElementById('tpl-ed-ms-' + id).value, zh: document.getElementById('tpl-ed-zh-' + id).value }
    });
    toast('Saved: ' + key);
    loadStaticReplies();
  } catch (e) { toast(e.message, 'error'); }
}
async function deleteTemplate(key) {
  if (!confirm('Delete template "' + key + '"?')) return;
  try {
    await api('/templates/' + encodeURIComponent(key), { method: 'DELETE' });
    toast('Deleted: ' + key);
    loadStaticReplies();
  } catch (e) { toast(e.message, 'error'); }
}

function showAddTemplate() {
  document.getElementById('add-t-key').value = '';
  document.getElementById('add-t-en').value = '';
  document.getElementById('add-t-ms').value = '';
  document.getElementById('add-t-zh').value = '';
  document.getElementById('add-template-modal').classList.remove('hidden');
  document.getElementById('add-t-key').focus();
}

async function submitAddTemplate(e) {
  e.preventDefault();
  try {
    await api('/templates', {
      method: 'POST',
      body: { key: document.getElementById('add-t-key').value.trim(), en: document.getElementById('add-t-en').value, ms: document.getElementById('add-t-ms').value, zh: document.getElementById('add-t-zh').value }
    });
    toast('Template added');
    closeModal('add-template-modal');
    loadStaticReplies();
  } catch (e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Knowledge Base Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let kbPreviewVisible = false;

async function loadKB() {
  try {
    const d = await api('/knowledge-base');
    document.getElementById('kb-editor').value = d.content || '';
    if (kbPreviewVisible) renderKBPreview();
  } catch (e) { toast(e.message, 'error'); }
}

async function saveKB() {
  try {
    const content = document.getElementById('kb-editor').value;
    await api('/knowledge-base', { method: 'PUT', body: { content } });
    toast('Knowledge Base saved (' + content.length + ' chars)');
  } catch (e) { toast(e.message, 'error'); }
}

function toggleKBPreview() {
  kbPreviewVisible = !kbPreviewVisible;
  const btn = document.getElementById('kb-preview-btn');
  const editor = document.getElementById('kb-editor-container');
  const preview = document.getElementById('kb-preview-container');

  if (kbPreviewVisible) {
    btn.textContent = 'Edit';
    btn.classList.add('bg-indigo-100', 'text-indigo-700');
    editor.classList.add('hidden');
    preview.classList.remove('hidden');
    renderKBPreview();
  } else {
    btn.textContent = 'Preview';
    btn.classList.remove('bg-indigo-100', 'text-indigo-700');
    editor.classList.remove('hidden');
    preview.classList.add('hidden');
  }
}

function renderKBPreview() {
  const raw = document.getElementById('kb-editor').value;
  // Simple markdown to HTML (covers headings, bold, italic, lists, code)
  let html = esc(raw)
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>');
  html = '<p>' + html + '</p>';
  document.getElementById('kb-preview-container').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Settings Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSettings() {
  try {
    const d = await api('/settings');
    const el = document.getElementById('settings-content');
    el.innerHTML = `
      <div class="bg-white border rounded-lg p-5">
        <h3 class="font-semibold text-gray-700 mb-3">AI Model Configuration</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="text-xs text-gray-500 block mb-1">Model</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="s-ai-model" value="${esc(d.ai?.model || '')}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Ollama Model</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="s-ai-ollama-model" value="${esc(d.ai?.ollama_model || '')}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Ollama Base URL</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="s-ai-ollama-url" value="${esc(d.ai?.ollama_base_url || '')}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Max Classify Tokens</label>
            <input type="number" class="w-full border rounded px-2 py-1.5 text-sm" id="s-ai-classify-tokens" value="${d.ai?.max_classify_tokens || 0}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Max Chat Tokens</label>
            <input type="number" class="w-full border rounded px-2 py-1.5 text-sm" id="s-ai-chat-tokens" value="${d.ai?.max_chat_tokens || 0}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Classify Temperature</label>
            <input type="number" step="0.1" class="w-full border rounded px-2 py-1.5 text-sm" id="s-ai-classify-temp" value="${d.ai?.classify_temperature || 0}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Chat Temperature</label>
            <input type="number" step="0.1" class="w-full border rounded px-2 py-1.5 text-sm" id="s-ai-chat-temp" value="${d.ai?.chat_temperature || 0}" /></div>
        </div>
      </div>
      <div class="bg-white border rounded-lg p-5">
        <h3 class="font-semibold text-gray-700 mb-3">Rate Limits</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="text-xs text-gray-500 block mb-1">Per Minute</label>
            <input type="number" class="w-full border rounded px-2 py-1.5 text-sm" id="s-rate-minute" value="${d.rate_limits?.per_minute || 0}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Per Hour</label>
            <input type="number" class="w-full border rounded px-2 py-1.5 text-sm" id="s-rate-hour" value="${d.rate_limits?.per_hour || 0}" /></div>
        </div>
      </div>
      <div class="bg-white border rounded-lg p-5">
        <h3 class="font-semibold text-gray-700 mb-3">Staff Phones</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="text-xs text-gray-500 block mb-1">Jay's Phone</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="s-staff-jay" value="${esc(d.staff?.jay_phone || '')}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Alston's Phone</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="s-staff-alston" value="${esc(d.staff?.alston_phone || '')}" /></div>
          <div class="md:col-span-2"><label class="text-xs text-gray-500 block mb-1">Staff Phones (comma-separated)</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="s-staff-phones" value="${esc((d.staff?.phones || []).join(', '))}" /></div>
        </div>
      </div>
      <div class="bg-white border rounded-lg p-5">
        <h3 class="font-semibold text-gray-700 mb-3">System Prompt</h3>
        <textarea class="w-full border rounded px-3 py-2 text-sm" id="s-system-prompt" rows="6">${esc(d.system_prompt || '')}</textarea>
      </div>
      <button onclick="saveSettings()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md text-sm transition">Save Settings</button>
    `;
  } catch (e) { toast(e.message, 'error'); }
}

async function saveSettings() {
  try {
    await api('/settings', {
      method: 'PATCH',
      body: {
        ai: {
          model: document.getElementById('s-ai-model').value,
          ollama_model: document.getElementById('s-ai-ollama-model').value,
          ollama_base_url: document.getElementById('s-ai-ollama-url').value,
          max_classify_tokens: parseInt(document.getElementById('s-ai-classify-tokens').value) || 0,
          max_chat_tokens: parseInt(document.getElementById('s-ai-chat-tokens').value) || 0,
          classify_temperature: parseFloat(document.getElementById('s-ai-classify-temp').value) || 0,
          chat_temperature: parseFloat(document.getElementById('s-ai-chat-temp').value) || 0
        },
        rate_limits: {
          per_minute: parseInt(document.getElementById('s-rate-minute').value) || 0,
          per_hour: parseInt(document.getElementById('s-rate-hour').value) || 0
        },
        staff: {
          jay_phone: document.getElementById('s-staff-jay').value,
          alston_phone: document.getElementById('s-staff-alston').value,
          phones: document.getElementById('s-staff-phones').value.split(',').map(s => s.trim()).filter(Boolean)
        },
        system_prompt: document.getElementById('s-system-prompt').value
      }
    });
    toast('Settings saved');
  } catch (e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Workflow Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadWorkflow() {
  try {
    const d = await api('/workflow');
    const el = document.getElementById('workflow-content');
    el.innerHTML = `
      <div class="bg-white border rounded-lg p-5">
        <h3 class="font-semibold text-gray-700 mb-3">Escalation</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="text-xs text-gray-500 block mb-1">Timeout (ms)</label>
            <input type="number" class="w-full border rounded px-2 py-1.5 text-sm" id="w-esc-timeout" value="${d.escalation?.timeout_ms || 0}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Unknown Threshold</label>
            <input type="number" class="w-full border rounded px-2 py-1.5 text-sm" id="w-esc-threshold" value="${d.escalation?.unknown_threshold || 0}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Primary Phone</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="w-esc-primary" value="${esc(d.escalation?.primary_phone || '')}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Secondary Phone</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="w-esc-secondary" value="${esc(d.escalation?.secondary_phone || '')}" /></div>
        </div>
      </div>
      <div class="bg-white border rounded-lg p-5">
        <h3 class="font-semibold text-gray-700 mb-3">Payment</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="text-xs text-gray-500 block mb-1">Forward To</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="w-pay-forward" value="${esc(d.payment?.forward_to || '')}" /></div>
          <div><label class="text-xs text-gray-500 block mb-1">Receipt Patterns (comma-separated)</label>
            <input class="w-full border rounded px-2 py-1.5 text-sm" id="w-pay-patterns" value="${esc((d.payment?.receipt_patterns || []).join(', '))}" /></div>
        </div>
      </div>
      <div class="bg-white border rounded-lg p-5">
        <h3 class="font-semibold text-gray-700 mb-3">Booking</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="w-book-enabled" ${d.booking?.enabled ? 'checked' : ''} />
            <label for="w-book-enabled" class="text-sm text-gray-700">Enabled</label>
          </div>
          <div><label class="text-xs text-gray-500 block mb-1">Max Guests (Auto)</label>
            <input type="number" class="w-full border rounded px-2 py-1.5 text-sm" id="w-book-max" value="${d.booking?.max_guests_auto || 0}" /></div>
        </div>
      </div>
      <div class="bg-white border rounded-lg p-5">
        <h3 class="font-semibold text-gray-700 mb-3">Non-Text Handling</h3>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="w-nontext-enabled" ${d.non_text_handling?.enabled ? 'checked' : ''} />
          <label for="w-nontext-enabled" class="text-sm text-gray-700">Enabled</label>
        </div>
      </div>
      <button onclick="saveWorkflow()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md text-sm transition">Save Workflow</button>
    `;
  } catch (e) { toast(e.message, 'error'); }
}

async function saveWorkflow() {
  try {
    await api('/workflow', {
      method: 'PATCH',
      body: {
        escalation: {
          timeout_ms: parseInt(document.getElementById('w-esc-timeout').value) || 0,
          unknown_threshold: parseInt(document.getElementById('w-esc-threshold').value) || 0,
          primary_phone: document.getElementById('w-esc-primary').value,
          secondary_phone: document.getElementById('w-esc-secondary').value
        },
        payment: {
          forward_to: document.getElementById('w-pay-forward').value,
          receipt_patterns: document.getElementById('w-pay-patterns').value.split(',').map(s => s.trim()).filter(Boolean)
        },
        booking: {
          enabled: document.getElementById('w-book-enabled').checked,
          max_guests_auto: parseInt(document.getElementById('w-book-max').value) || 0
        },
        non_text_handling: {
          enabled: document.getElementById('w-nontext-enabled').checked
        }
      }
    });
    toast('Workflow saved');
  } catch (e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Preview Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chatHistory = [];

function loadPreview() {
  // Just initialize - chat is ready to use
}

function clearChat() {
  chatHistory = [];
  const messagesEl = document.getElementById('chat-messages');
  messagesEl.innerHTML = `
    <div class="text-center text-gray-400 text-sm py-8">
      <p>ğŸ‘‹ Start a conversation by typing a message below</p>
      <p class="text-xs mt-1">Try: "What's the wifi password?" or "I want to book a room"</p>
    </div>
  `;
  document.getElementById('chat-meta').innerHTML = '';
  document.getElementById('chat-input').value = '';
}

async function sendChatMessage(event) {
  event.preventDefault();

  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  if (!message) return;

  const sendBtn = document.getElementById('send-btn');
  const messagesEl = document.getElementById('chat-messages');
  const metaEl = document.getElementById('chat-meta');

  // Clear placeholder if first message
  if (chatHistory.length === 0) {
    messagesEl.innerHTML = '';
  }

  // Add user message to UI
  const userMsgEl = document.createElement('div');
  userMsgEl.className = 'flex justify-end';
  userMsgEl.innerHTML = `
    <div class="bg-indigo-500 text-white rounded-lg px-4 py-2 max-w-md">
      <div class="text-sm">${esc(message)}</div>
    </div>
  `;
  messagesEl.appendChild(userMsgEl);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  // Add user message to history
  chatHistory.push({ role: 'user', content: message });

  // Clear input and disable button
  input.value = '';
  sendBtn.disabled = true;
  sendBtn.textContent = 'Thinking...';

  // Show typing indicator
  const typingEl = document.createElement('div');
  typingEl.className = 'flex justify-start';
  typingEl.id = 'typing-indicator';
  typingEl.innerHTML = `
    <div class="bg-white border rounded-lg px-4 py-2">
      <div class="flex gap-1">
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
      </div>
    </div>
  `;
  messagesEl.appendChild(typingEl);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  try {
    // Send to API
    const result = await api('/preview/chat', {
      method: 'POST',
      body: { message, history: chatHistory.slice(0, -1) }
    });

    // Remove typing indicator
    typingEl.remove();

    // Add assistant message to UI
    const assistantMsgEl = document.createElement('div');
    assistantMsgEl.className = 'flex justify-start';
    assistantMsgEl.innerHTML = `
      <div class="bg-white border rounded-lg px-4 py-2 max-w-md">
        <div class="text-sm whitespace-pre-wrap">${esc(result.message)}</div>
        <div class="mt-2 pt-2 border-t flex items-center gap-2 text-xs text-gray-500">
          <span class="px-1.5 py-0.5 bg-indigo-50 text-indigo-700 rounded font-mono">${esc(result.intent)}</span>
          <span class="px-1.5 py-0.5 bg-green-50 text-green-700 rounded">${esc(result.routedAction)}</span>
          ${result.confidence ? `<span>${(result.confidence * 100).toFixed(0)}%</span>` : ''}
        </div>
      </div>
    `;
    messagesEl.appendChild(assistantMsgEl);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    // Add assistant message to history
    chatHistory.push({ role: 'assistant', content: result.message });

    // Update meta info
    metaEl.innerHTML = `Last intent: <b>${esc(result.intent)}</b> | Routed to: <b>${esc(result.routedAction)}</b> | Confidence: ${result.confidence ? (result.confidence * 100).toFixed(0) + '%' : 'N/A'}`;

  } catch (error) {
    // Remove typing indicator
    typingEl.remove();

    // Show error message
    const errorMsgEl = document.createElement('div');
    errorMsgEl.className = 'flex justify-start';
    errorMsgEl.innerHTML = `
      <div class="bg-red-50 border border-red-200 text-red-800 rounded-lg px-4 py-2 max-w-md">
        <div class="text-sm">âŒ Error: ${esc(error.message || 'Failed to get response')}</div>
      </div>
    `;
    messagesEl.appendChild(errorMsgEl);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    toast(error.message || 'Failed to send message', 'error');
  } finally {
    // Re-enable button
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
    input.focus();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Utils
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) { const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }
function css(s) { return String(s).replace(/[^a-zA-Z0-9_-]/g, '_'); }
function truncate(s, n) { return s.length > n ? s.slice(0, n) + '...' : s; }

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
switchTab(getTabFromURL(), false);

// â”€â”€â”€ Development Auto-Reload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Check for updates every 2 seconds in development mode
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
  let lastCheck = Date.now();
  setInterval(() => {
    fetch(window.location.href, {
      method: 'HEAD',
      cache: 'no-cache',
      headers: { 'Cache-Control': 'no-cache' }
    }).then(response => {
      const lastModified = response.headers.get('Last-Modified');
      if (lastModified) {
        const serverTime = new Date(lastModified).getTime();
        if (serverTime > lastCheck) {
          console.log('[Dev] Page updated, reloading...');
          window.location.reload();
        }
      }
    }).catch(() => {
      // Silently fail - server might be restarting
    });
  }, 2000);
}
</script>
</body>
</html>
