## Codebase Patterns

- **3-server architecture**: Port 3000 (Vite), 5000 (Express API), 3002 (Rainbow MCP). All 3 must run for dashboard.
- **Import boundaries**: RainbowAI/ has ZERO imports from server/, client/, or shared/. They communicate via HTTP.
- **Config is atomic**: config-store.ts writes .tmp then renameSync to prevent corruption.
- **Intent classification is 4-tier**: T1 (Emergency regex ~0.1ms) → T2 (Fuzzy keywords ~1ms) → T3 (Semantic similarity ~50ms) → T4 (LLM fallback ~2s).
- **Routing is separate from classification**: intents.ts classifies; routing.json decides the action.
- **Multi-language always**: Any new template/response needs en, ms, zh variants.
- **Localhost-only internal endpoints**: Use IP check (127.0.0.1, ::1, ::ffff:127.0.0.1) instead of auth for inter-service endpoints.
- **FK constraints matter**: guest_tokens.created_by references users.id — must be a valid UUID, not a string like 'rainbow-ai'. Query first admin user.
- **Pipeline DI pattern**: Pipeline stages receive IPipelineContext (dependency injection) — never import dependencies directly.
- **Workflow enhancer pattern**: Strategy pattern with switch/case in executeAction(). Add new actions as case branches.
- **Node-based workflows**: Use format: 'nodes' + startNodeId + nodes[] array. Executor auto-detects and dispatches. Keep legacy steps[] as fallback.
- **Template variables in nodes**: {{guest.name}}, {{workflow.data.varName}}, {{system.admin_phone}}, {{pelangi.field}} — resolved at execution time via resolveTemplateVars().
- **Zod .passthrough()**: Add to schemas when extra JSON fields needed (e.g., node workflow fields on workflowDefinitionSchema).
- **Test with Chat Simulator**: Use /admin/rainbow#understanding Test Console for quick intent verification.
- **agent-browser for UI testing**: Use `agent-browser open <url>` then `agent-browser snapshot -i` for interactive elements.
- **No nested template literals**: In HTML generation, use string concatenation instead of nested backtick templates.
- **Module-registry.js is the bridge**: All ES6 module exports must be imported + registered as window.* here for HTML onclick handlers to work. Missing registration = silent failure.
- **TS quality gate uses error-count baseline**: Ralph's quality gate counts TS errors and compares against a baseline (222 pre-existing as of 2026-02-17), not exit code. Only NEW errors fail the gate.
- **Test endpoints bypass the pipeline**: /intents/test and /preview/chat call classifyMessage() directly — they DON'T go through the pipeline stages. Activity tracking must be added explicitly to these endpoints.
- **Dashboard URL is root /**: On port 3002, the dashboard is at `http://localhost:3002/` (NOT /admin/rainbow). The /admin/rainbow path only works via Vite proxy on port 3000.
- **Activity tracker is EventEmitter-based**: activityTracker.track() emits 'activity' event → SSE clients listen via activityTracker.on('activity', ...). Ring buffer keeps last 100 events, debounced 2s disk writes.
- **SSE + compression conflict**: Express `compression()` middleware buffers SSE responses, preventing EventSource from receiving data. Fix: add `filter` to compression config that skips `text/event-stream` requests AND SSE URL paths. Also call `res.flushHeaders()` after `res.writeHead()` in SSE handlers.
- **Activity event metadata structure**: Events store phone in `metadata.phone` (not top-level). Simulator events use `simulator@test` / `simulator@preview` identifiers. Filter by metadata fields, not top-level fields.
- **Two chat rendering paths**: `real-chat-core.js` renderChatView() (Live Simulation) and `chat-renderer.js` renderMessageBubble() (Quick Test/reusable). Both must be updated for visual consistency.
- **Collapsible panels use CSS class toggle**: Add/remove `.open` class (not inline `style.display`) for CSS animation support. Toggle button gets `.open` too for chevron rotation.
- **Dev mode gates UI chrome**: Edit/Add buttons, metadata panels, and search toggle only appear when `StateManager.get('realChat.devMode')` is true. Clean WhatsApp look when OFF.
- **CSS side class inconsistency**: CSS historically used `.bot`, but JS side variable is `'ai'`. Both `.ai` and `.bot` classes are now defined for bubble styling. Use `ai` in new code.
- **WhatsApp footer uses float-right**: Timestamp+checkmark inside bubble uses `float: right` with negative margins to flow inline with last text line.

---

# Ralph Progress Log — Live Chat & Chat Simulator Enhancements (2026-02-18)

(Previous PRD progress archived to archive/ralph/2026-02-18-dashboard-activity-chat-simulator/)

## Iteration 1 - Wed, Feb 18, 2026  1:19:25 AM
Incomplete: Display token usage in Chat Simulator Live Simulation (ID: US-001)
- Hit max turns (50) — likely spent too much context on codebase exploration (first iteration, cold start)

## Iteration 2 - Wed, Feb 18, 2026  1:25:22 AM
Incomplete: Display token usage in Chat Simulator Live Simulation (ID: US-001)

## Iteration 3 - Wed, Feb 18, 2026

### What was implemented
- US-001: Display token usage in Chat Simulator Live Simulation — COMPLETE
- Added token usage row to `chat-renderer.js` dev metadata panel (the only missing piece)
- Backend (`testing-preview.ts`) already returned `usage`, `tokenBreakdown`, `contextCount`
- `real-chat-core.js` (Live Simulation) already displayed tokens in dev panel
- `chat-preview.js` (Guest Simulation) already displayed tokens with clickable breakdown popover
- `chat-send.js` already stored token metadata in session history
- CSS `.rc-dev-token-badge` style already existed in `rainbow-realchat.css`

### Patterns discovered
- **Most of US-001 was already implemented by iterations 1-2** but they hit max turns before marking it complete. Future iterations should check what previous iterations actually changed (git diff) before starting fresh.
- **Three rendering paths for Chat Simulator**: `real-chat-core.js` (Live Simulation), `chat-preview.js` (Guest Simulation sessions), and `chat-renderer.js` (reusable component). All three must show the same metadata.

### Gotchas
- TS error count fluctuates between 222-224 due to pre-existing rootDir issues — not caused by JS-only changes.

### Useful context for future iterations
- Token badge builder is `buildTokenBadge()` in `chat-preview.js` — reusable for any new view that needs token display
- `fmtTokenCount(n)` / `fmtTokens(n)` helpers exist in both `real-chat-core.js` and `chat-preview.js`

