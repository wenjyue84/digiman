<div class="mb-4">
  <h2 class="text-lg font-semibold text-neutral-800">Responses</h2>
  <p class="text-sm text-neutral-500">Manage knowledge base, quick replies, smart workflows, and system messages for
    Rainbow AI.</p>
</div>

<!-- Sub-tab Navigation (easy â†’ hard: Quick Replies â†’ System Messages â†’ Smart Workflows â†’ Knowledge Base) -->
<div class="mb-6 border-b border-neutral-200">
  <div class="flex gap-1">
    <button onclick="switchResponseTab('quick-replies')" data-response-tab="quick-replies"
      class="response-tab-btn px-4 py-2.5 text-sm font-medium text-primary-600 border-b-2 border-primary-500 transition cursor-help"
      title="Pre-written answers sent when Rainbow detects a specific intent (e.g. check-in time, wifi). No AI needed â€” instant and consistent. Edit in knowledge.json.">
      ğŸ“š Quick Replies
    </button>
    <button onclick="switchResponseTab('system-messages')" data-response-tab="system-messages"
      class="response-tab-btn px-4 py-2.5 text-sm font-medium text-neutral-500 border-b-2 border-transparent hover:text-neutral-700 hover:border-neutral-300 transition cursor-help"
      title="Templates for system-level messages: errors, rate limits, &quot;thinking&quot;, and non-intent replies. Stored in templates.json.">
      âš™ï¸ System Messages
    </button>
    <button onclick="switchResponseTab('workflows')" data-response-tab="workflows"
      class="response-tab-btn px-4 py-2.5 text-sm font-medium text-neutral-500 border-b-2 border-transparent hover:text-neutral-700 hover:border-neutral-300 transition cursor-help"
      title="Multi-step guided flows: booking, complaints, check-in, escalation. Each workflow has steps, messages, and actions (e.g. send to staff, forward payment).">
      ğŸ”„ Smart Workflows
    </button>
    <button onclick="switchResponseTab('knowledge-base')" data-response-tab="knowledge-base"
      class="response-tab-btn px-4 py-2.5 text-sm font-medium text-neutral-500 border-b-2 border-transparent hover:text-neutral-700 hover:border-neutral-300 transition cursor-help"
      title="Markdown files (.rainbow-kb/) that Rainbow loads for LLM replies. Only relevant topics are loaded per question (progressive disclosure). Edit what the AI &quot;knows&quot; here.">
      ğŸ“– Knowledge Base
    </button>
  </div>
</div>

<!-- Tab Content Container -->
<div id="response-tabs-content">

  <!-- Tab 0: Knowledge Base (.rainbow-kb/ files) -->
  <div id="knowledge-base-tab" class="response-tab-content hidden">

    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="text-sm text-neutral-500">Progressive disclosure system â€” edit individual knowledge files that Rainbow
          uses for AI responses</p>
      </div>
    </div>

    <!-- KB Accuracy Tester (US-009: moved to top) -->
    <div class="bg-gradient-to-br from-emerald-50 to-teal-50 border border-emerald-200 rounded-2xl p-5 mb-5">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h3 class="font-semibold text-emerald-900">ğŸ”¬ KB Accuracy Tester</h3>
          <p class="text-xs text-emerald-600 mt-0.5">Ask questions answered ONLY from Knowledge Base content (bypasses intent pipeline)</p>
        </div>
        <button onclick="kbTestClear()"
          class="text-xs bg-white hover:bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg border border-emerald-200 transition">Clear</button>
      </div>

      <!-- Test Messages -->
      <div id="kb-test-messages"
        class="bg-white rounded-lg border border-emerald-200 p-4 mb-3 max-h-72 overflow-y-auto min-h-[100px]">
        <div class="text-center text-neutral-400 text-sm py-6">Ask a question to test Knowledge Base accuracy</div>
      </div>

      <!-- Test Input -->
      <div class="flex gap-2">
        <input type="text" id="kb-test-input" placeholder="Ask a question (e.g. What time is check-in?)"
          class="flex-1 border border-emerald-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
          onkeydown="kbTestKeydown(event)" />
        <button onclick="kbTestSend()"
          class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm transition">Send</button>
      </div>
    </div>

    <div class="grid grid-cols-12 gap-4" style="min-height: 700px;">

      <!-- File Browser Sidebar (4 cols) -->
      <div class="col-span-12 md:col-span-4">
        <div class="bg-white border rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-neutral-700 text-sm">Files</h3>
            <span class="text-xs text-neutral-400">.rainbow-kb/</span>
          </div>
          <div class="flex flex-wrap gap-1 mb-3">
            <button onclick="kbFilterCategory('core')" data-kb-cat="core"
              class="kb-cat-btn text-xs px-3 py-1.5 rounded-full border transition bg-primary-500 text-white border-primary-500">Core</button>
            <button onclick="kbFilterCategory('system')" data-kb-cat="system"
              class="kb-cat-btn text-xs px-3 py-1.5 rounded-full border transition border-neutral-300 hover:bg-neutral-50">System</button>
            <button onclick="kbFilterCategory('knowledge')" data-kb-cat="knowledge"
              class="kb-cat-btn text-xs px-3 py-1.5 rounded-full border transition border-neutral-300 hover:bg-neutral-50">Knowledge</button>
            <button onclick="kbFilterCategory('memory')" data-kb-cat="memory"
              class="kb-cat-btn text-xs px-3 py-1.5 rounded-full border transition border-neutral-300 hover:bg-neutral-50">Memory</button>
            <button onclick="kbFilterCategory('contacts')" data-kb-cat="contacts"
              class="kb-cat-btn text-xs px-3 py-1.5 rounded-full border transition border-neutral-300 hover:bg-neutral-50">Contacts</button>
          </div>
          <!-- Search Box -->
          <div class="relative mb-3">
            <input type="text" id="kb-search-input" placeholder="Search knowledge base..."
              class="w-full border rounded-2xl px-4 py-2 pl-9 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
              oninput="filterKBFiles()" />
            <svg class="absolute left-3 top-2.5 w-3.5 h-3.5 text-neutral-400" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <div id="kb-file-list" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
        </div>

        <!-- Progressive Disclosure Info Card -->
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded-2xl p-4 mt-4">
          <h3 class="font-semibold text-sm text-purple-800 mb-2">How LLM Reply Works</h3>
          <p class="text-xs text-purple-600">When an intent is routed to <strong>LLM Reply</strong>, Rainbow loads only
            what it needs:</p>
          <ol class="text-xs text-purple-600 mt-2 space-y-1 list-decimal list-inside">
            <li>Read <strong>AGENTS.md</strong> (routing table)</li>
            <li>Load <strong>soul.md</strong> (voice &amp; personality)</li>
            <li>Load specific files matching the question</li>
            <li>Generate answer in Rainbow's voice</li>
          </ol>
          <div class="mt-3 px-3 py-1.5 bg-white rounded-lg border border-purple-200 text-center">
            <span class="text-xs font-semibold text-purple-700">Token Savings: ~60-70%</span>
          </div>
          <p class="text-xs text-purple-500 mt-2">Edit files here to change what Rainbow knows. Changes take effect
            immediately.</p>
        </div>
      </div>

      <!-- Editor Panel (8 cols) -->
      <div class="col-span-12 md:col-span-8">

        <!-- No File Selected Placeholder -->
        <div id="kb-no-file" class="bg-white border rounded-2xl p-12 text-center">
          <div class="text-5xl mb-4 text-neutral-300">&#128196;</div>
          <h3 class="text-lg font-semibold mb-2 text-neutral-600">No File Selected</h3>
          <p class="text-sm text-neutral-400">Select a file from the sidebar to view and edit</p>
        </div>

        <!-- Editor Panel -->
        <div id="kb-editor-panel" class="bg-white border rounded-2xl overflow-hidden hidden">

          <!-- File Header -->
          <div class="px-5 py-3 border-b bg-neutral-50 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span id="kb-editor-icon" class="text-lg"></span>
              <div>
                <h3 id="kb-editor-filename" class="font-semibold text-sm"></h3>
                <p id="kb-editor-desc" class="text-xs text-neutral-500"></p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div class="flex border rounded-lg overflow-hidden">
                <button onclick="kbSetViewMode('edit')" id="kb-mode-edit"
                  class="text-xs px-3 py-1.5 bg-primary-500 text-white transition">Edit</button>
                <button onclick="kbSetViewMode('preview')" id="kb-mode-preview"
                  class="text-xs px-3 py-1.5 hover:bg-neutral-50 transition">Preview</button>
              </div>
              <button onclick="kbResetContent()" id="kb-reset-btn"
                class="hidden text-xs border border-neutral-300 hover:bg-neutral-50 px-3 py-1.5 rounded-lg transition">Reset</button>
              <button onclick="kbSaveFile()" id="kb-save-btn"
                class="hidden text-xs bg-primary-500 hover:bg-primary-600 text-white px-3 py-1.5 rounded-lg transition">Save</button>
            </div>
          </div>

          <!-- Unsaved Changes Bar -->
          <div id="kb-unsaved-bar"
            class="hidden px-5 py-2 bg-yellow-50 border-b border-yellow-200 flex items-center gap-2 text-sm text-yellow-800">
            <span>&#9888;&#65039;</span>
            <span>You have unsaved changes</span>
          </div>

          <!-- Edit / Preview Area -->
          <div class="p-4">
            <div id="kb-edit-container">
              <textarea id="kb-file-editor" rows="26"
                class="w-full border rounded-xl px-4 py-3 text-sm font-mono leading-relaxed resize-y focus:outline-none focus:ring-2 focus:ring-primary-500"
                placeholder="Select a file to edit..." oninput="kbOnInput()"></textarea>
            </div>
            <div id="kb-preview-pane"
              class="hidden border rounded-xl px-4 py-3 bg-neutral-50 min-h-[500px] max-h-[700px] overflow-y-auto kb-preview">
            </div>
          </div>

          <!-- Stats Bar -->
          <div class="px-5 py-2 border-t bg-neutral-50 flex items-center justify-between text-xs text-neutral-400">
            <span id="kb-editor-stats">0 lines &middot; 0 characters</span>
            <span id="kb-editor-modified" class="hidden text-yellow-600 font-medium">Modified &middot; Not saved</span>
          </div>
        </div>
      </div>
    </div>

    <!-- KB Edit Modal -->
    <div id="kb-edit-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
      <div class="bg-white rounded-2xl shadow-strong p-6 w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Edit: <span id="kb-edit-filename" class="text-primary-600"></span></h3>
          <button onclick="closeKbEditModal()" class="text-neutral-400 hover:text-neutral-600 text-xl">&times;</button>
        </div>
        <textarea id="kb-edit-content"
          class="flex-1 w-full border rounded-xl px-4 py-3 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none min-h-[300px]"
          disabled></textarea>
        <div class="flex justify-end gap-2 mt-4">
          <button onclick="closeKbEditModal()"
            class="px-3 py-1.5 text-sm text-neutral-600 border rounded-2xl hover:bg-neutral-50">Cancel</button>
          <button id="kb-edit-save-btn" onclick="saveKbFileFromModal()"
            class="px-3 py-1.5 text-sm bg-primary-500 text-white rounded-2xl hover:bg-primary-600"
            disabled>Save</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Tab 1: Quick Replies (knowledge.json) â€” DEFAULT -->
  <div id="quick-replies-tab" class="response-tab-content">
    <!-- Search and Filter Bar -->
    <div class="mb-4 space-y-3">
      <!-- Search Box -->
      <div class="relative">
        <input type="text" id="static-search-input" placeholder="Search messages by intent, key, or content..."
          class="w-full border rounded-2xl px-4 py-2.5 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
          oninput="filterStaticReplies()" />
        <svg class="absolute left-3 top-3 w-4 h-4 text-neutral-400" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>

      <!-- Phase Filter (matches intent categories) -->
      <div class="flex flex-wrap gap-2">
        <button onclick="filterStaticCategory('all')" data-category="all"
          class="static-category-btn text-xs px-3 py-1.5 rounded-full border bg-primary-500 text-white border-primary-500 transition">
          All
        </button>
        <button onclick="filterStaticCategory('GENERAL_SUPPORT')" data-category="GENERAL_SUPPORT"
          class="static-category-btn text-xs px-3 py-1.5 rounded-full border border-neutral-300 hover:bg-neutral-50 transition">
          ğŸ‘‹ General
        </button>
        <button onclick="filterStaticCategory('PRE_ARRIVAL')" data-category="PRE_ARRIVAL"
          class="static-category-btn text-xs px-3 py-1.5 rounded-full border border-neutral-300 hover:bg-neutral-50 transition">
          ğŸ” Pre-Arrival
        </button>
        <button onclick="filterStaticCategory('ARRIVAL_CHECKIN')" data-category="ARRIVAL_CHECKIN"
          class="static-category-btn text-xs px-3 py-1.5 rounded-full border border-neutral-300 hover:bg-neutral-50 transition">
          ğŸ¨ Check-in
        </button>
        <button onclick="filterStaticCategory('DURING_STAY')" data-category="DURING_STAY"
          class="static-category-btn text-xs px-3 py-1.5 rounded-full border border-neutral-300 hover:bg-neutral-50 transition">
          ğŸ›ï¸ During Stay
        </button>
        <button onclick="filterStaticCategory('CHECKOUT_DEPARTURE')" data-category="CHECKOUT_DEPARTURE"
          class="static-category-btn text-xs px-3 py-1.5 rounded-full border border-neutral-300 hover:bg-neutral-50 transition">
          ğŸšª Checkout
        </button>
        <button onclick="filterStaticCategory('POST_CHECKOUT')" data-category="POST_CHECKOUT"
          class="static-category-btn text-xs px-3 py-1.5 rounded-full border border-neutral-300 hover:bg-neutral-50 transition">
          ğŸ“¬ Post-Checkout
        </button>
      </div>
    </div>

    <!-- Validation Warnings -->
    <div id="static-warnings" class="mb-4 space-y-2"></div>

    <!-- Intent Replies (from knowledge.json) -->
    <div>
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2 group">
          <h3 class="font-semibold text-neutral-700">Intent Replies</h3>
          <span class="badge-info">knowledge.json</span>
          <div class="relative inline-block">
            <svg class="w-4 h-4 text-neutral-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                clip-rule="evenodd"></path>
            </svg>
            <div
              class="absolute left-6 top-0 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-50 w-72 bg-neutral-900 text-white text-xs rounded-lg p-3 shadow-lg">
              <div class="font-semibold mb-1">Intent Replies</div>
              <p>Pre-written responses triggered when Rainbow detects a specific user intent (like "breakfast_info",
                "check_in_time"). These are fast, consistent answers that don't require AI processing. Used when an
                intent is routed to "Static Reply" action.</p>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="translateAllIntents()" id="translate-all-btn"
            class="text-sm bg-success-500 hover:bg-success-600 text-white px-3 py-1.5 rounded-2xl transition inline-flex items-center gap-1.5"
            title="Auto-translate all intents missing MS or ZH translations">Translate All</button>
          <button onclick="showGenerateByLLMModal()"
            class="text-sm bg-primary-500 hover:bg-primary-600 text-white px-3 py-1.5 rounded-2xl transition inline-flex items-center gap-1.5">âœ¨
            Generate by LLM</button>
          <button onclick="showAddKnowledge('static')"
            class="text-sm bg-success-500 hover:bg-success-600 text-white px-3 py-1.5 rounded-2xl transition">+ Add
            Reply</button>
        </div>
      </div>
      <div id="static-intent-replies" class="space-y-3"></div>
    </div>
  </div>

  <!-- Tab 2: Smart Workflows -->
  <div id="workflows-tab" class="response-tab-content hidden">
    <!-- Workflow Builder -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- Left: Workflow List -->
      <div class="md:col-span-1">
        <div class="bg-white border rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-neutral-700 text-sm">Workflows</h3>
            <div class="flex items-center gap-1">
              <button onclick="importWorkflowJSON()" title="Import workflow from JSON file"
                class="text-xs text-neutral-600 hover:text-primary-600 px-1.5 py-1 rounded transition" aria-label="Import">
                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
              </button>
              <button onclick="exportWorkflowJSON()" title="Export selected workflow as JSON"
                class="text-xs text-neutral-600 hover:text-primary-600 px-1.5 py-1 rounded transition" aria-label="Export">
                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l4 4m0 0l4-4m-4 4V4"/></svg>
              </button>
              <button onclick="createWorkflow()"
                class="text-xs bg-success-500 hover:bg-success-600 text-white px-2 py-1 rounded transition">+ New</button>
            </div>
          </div>
          <!-- Search Box -->
          <div class="relative mb-3">
            <input type="text" id="workflows-search-input" placeholder="Search workflows..."
              class="w-full border rounded-2xl px-4 py-2 pl-9 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
              oninput="filterWorkflows()" />
            <svg class="absolute left-3 top-2.5 w-3.5 h-3.5 text-neutral-400" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <div id="workflow-list" class="space-y-2">Loading...</div>
        </div>
      </div>

      <!-- Right: Step Editor -->
      <div class="md:col-span-2">
        <div id="workflow-editor-placeholder" class="bg-white border rounded-2xl p-8 text-center text-neutral-400">
          <p class="text-lg mb-1">Select a workflow</p>
          <p class="text-sm">Click a workflow on the left to edit its steps</p>
        </div>
        <div id="workflow-editor" class="hidden bg-white border rounded-2xl p-5">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3 flex-1">
              <input id="wf-edit-name"
                class="text-lg font-semibold border-b border-transparent hover:border-neutral-300 focus:border-primary-500 outline-none px-1 py-0.5 flex-1" />
              <span id="wf-edit-id" class="text-xs font-mono text-neutral-400"></span>
            </div>
            <div class="flex items-center gap-2">
              <!-- Format toggle -->
              <div id="wf-format-toggle" class="flex bg-neutral-100 rounded-lg p-0.5 text-xs">
                <button id="wf-format-steps-btn" onclick="switchWorkflowFormat('steps')" class="px-2.5 py-1 rounded-md transition font-medium">Steps</button>
                <button id="wf-format-nodes-btn" onclick="switchWorkflowFormat('nodes')" class="px-2.5 py-1 rounded-md transition font-medium">Nodes</button>
              </div>
              <button onclick="saveCurrentWorkflow()"
                class="text-sm bg-primary-500 hover:bg-primary-600 text-white px-3 py-1.5 rounded-2xl transition">Save</button>
              <button onclick="deleteCurrentWorkflow()"
                class="text-sm text-danger-500 hover:bg-danger-50 px-3 py-1.5 rounded-2xl border transition">Delete</button>
            </div>
          </div>

          <!-- Steps Editor (legacy) -->
          <div id="wf-steps-editor">
            <div id="wf-steps-container" class="space-y-0 mb-4"></div>
            <button onclick="addStep()"
              class="text-sm bg-neutral-100 hover:bg-neutral-200 text-neutral-700 px-3 py-2 rounded-2xl w-full transition border border-dashed border-neutral-300">+
              Add Step</button>
          </div>

          <!-- Nodes Editor (n8n-inspired) -->
          <div id="wf-nodes-editor" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="text-xs text-neutral-500">Start node:</span>
                <select id="wf-start-node" onchange="updateStartNodeId()" class="text-xs border rounded-lg px-2 py-1 bg-white"></select>
              </div>
              <div class="text-xs text-neutral-400" id="wf-node-count">0 nodes</div>
            </div>
            <div id="wf-nodes-container" class="space-y-0 mb-4"></div>
            <div class="flex gap-2">
              <button onclick="addNode('message')" class="flex-1 text-sm bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-2 rounded-2xl transition border border-dashed border-blue-300">+ Message</button>
              <button onclick="addNode('wait_reply')" class="flex-1 text-sm bg-purple-50 hover:bg-purple-100 text-purple-700 px-3 py-2 rounded-2xl transition border border-dashed border-purple-300">+ Wait Reply</button>
              <button onclick="addNode('condition')" class="flex-1 text-sm bg-amber-50 hover:bg-amber-100 text-amber-700 px-3 py-2 rounded-2xl transition border border-dashed border-amber-300">+ Condition</button>
            </div>
            <div class="flex gap-2 mt-2">
              <button onclick="addNode('whatsapp_send')" class="flex-1 text-sm bg-green-50 hover:bg-green-100 text-green-700 px-3 py-2 rounded-2xl transition border border-dashed border-green-300">+ WhatsApp Send</button>
              <button onclick="addNode('pelangi_api')" class="flex-1 text-sm bg-orange-50 hover:bg-orange-100 text-orange-700 px-3 py-2 rounded-2xl transition border border-dashed border-orange-300">+ API Call</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Workflow Testing Box -->
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-5 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="font-semibold text-blue-900">Workflow Tester</h3>
          <p class="text-xs text-blue-600 mt-1">Simulate and test your workflows in real-time</p>
        </div>
        <button onclick="resetWorkflowTest()"
          class="text-xs bg-white hover:bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg border border-blue-200 transition">Reset</button>
      </div>

      <!-- Workflow Selection -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-blue-800 mb-2">Select Workflow to Test</label>
        <select id="test-workflow-select" onchange="loadWorkflowTestSteps()"
          class="w-full border border-blue-200 rounded-lg px-3 py-2 bg-white text-sm">
          <option value="">-- Choose a workflow --</option>
        </select>
      </div>

      <!-- Workflow Steps Preview -->
      <div id="test-workflow-steps" class="hidden mb-4 bg-white rounded-lg border border-blue-200 p-4">
        <h4 class="text-sm font-semibold text-blue-800 mb-3">Workflow Steps:</h4>
        <div id="test-steps-list" class="space-y-2 text-sm"></div>
      </div>

      <!-- Test Chat Interface -->
      <div id="test-workflow-chat" class="hidden">
        <div class="bg-white rounded-lg border border-blue-200 p-4 mb-3 max-h-80 overflow-y-auto"
          id="test-chat-messages">
          <div class="text-center text-blue-400 text-sm py-8">Start testing by clicking "Begin Test" below</div>
        </div>

        <!-- Test Controls -->
        <div class="flex gap-2">
          <input type="text" id="test-user-input" placeholder="Type user message..."
            class="flex-1 border border-blue-200 rounded-lg px-3 py-2 text-sm" disabled />
          <button onclick="sendTestMessage()" id="test-send-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition"
            disabled>Send</button>
          <button onclick="beginWorkflowTest()" id="test-begin-btn"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm transition">Begin
            Test</button>
        </div>

        <!-- Current Step Indicator -->
        <div id="test-step-indicator" class="mt-3 text-xs text-blue-600 hidden">
          <span class="font-semibold">Current Step:</span> <span id="test-current-step-text">-</span>
        </div>
      </div>
    </div>

    <!-- Advanced Settings (existing workflow.json) -->
    <details class="bg-white border rounded-2xl">
      <summary class="px-5 py-3 cursor-pointer text-sm font-semibold text-neutral-700 hover:bg-neutral-50 rounded-2xl">
        Advanced Workflow Settings</summary>
      <div id="workflow-advanced-content" class="px-5 pb-5 space-y-4"></div>
    </details>
  </div>

  <!-- Tab 3: System Messages (templates.json) -->
  <div id="system-messages-tab" class="response-tab-content hidden">
    <!-- Search Box -->
    <div class="mb-4">
      <div class="relative">
        <input type="text" id="system-messages-search-input" placeholder="Search messages by key or content..."
          class="w-full border rounded-2xl px-4 py-2.5 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
          oninput="filterSystemMessages()" />
        <svg class="absolute left-3 top-3 w-4 h-4 text-neutral-400" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <div>
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2 group">
          <h3 class="font-semibold text-neutral-700">System Messages</h3>
          <span class="badge-info">templates.json</span>
          <div class="relative inline-block">
            <svg class="w-4 h-4 text-neutral-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                clip-rule="evenodd"></path>
            </svg>
            <div
              class="absolute left-6 top-0 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-50 w-72 bg-neutral-900 text-white text-xs rounded-lg p-3 shadow-lg">
              <div class="font-semibold mb-1">System Messages</div>
              <p>Automated messages sent by the system for operational events (errors, rate limits, maintenance notices,
                etc.). These are templates used internally by Rainbow, not triggered by user intents. Examples:
                error_general, rate_limit, out_of_office.</p>
            </div>
          </div>
        </div>
        <button onclick="showAddTemplate()"
          class="text-sm bg-success-500 hover:bg-success-600 text-white px-3 py-1.5 rounded-2xl transition">+ Add
          Template</button>
      </div>
      <div id="static-templates" class="space-y-3"></div>
    </div>
  </div>
</div>

<!-- Generate by LLM Modal (draft â†’ approve â†’ add to intent replies) -->
<div id="generate-by-llm-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
  <div class="bg-white rounded-2xl shadow-strong p-6 w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
    <h3 class="text-lg font-semibold mb-4">âœ¨ Generate reply by LLM</h3>
    <p class="text-sm text-neutral-500 mb-4">The LLM will read the knowledge base and suggest an intent, category (guest
      phase), and a reply in EN/MS/ZH for you to approve.</p>
    <!-- Step 1: Topic input + Generate -->
    <div id="gen-llm-step1" class="space-y-3 mb-4">
      <label class="block text-sm font-medium text-neutral-700">Topic or question this reply answers (optional)</label>
      <textarea id="gen-llm-topic" rows="2" class="w-full border rounded-2xl px-3 py-2 text-sm"
        placeholder="e.g. breakfast hours, pet policy, luggage storage"></textarea>
      <button type="button" id="gen-llm-btn" onclick="callGenerateDraft()"
        class="text-sm bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-2xl transition">Generate
        draft</button>
    </div>
    <div id="gen-llm-loading" class="hidden mb-4 text-sm text-primary-600">â³ Reading knowledge base and generating...
    </div>
    <!-- Step 2: Draft result â†’ edit â†’ Approve -->
    <div id="gen-llm-step2" class="hidden space-y-4 flex-1 overflow-y-auto">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-medium text-neutral-500 mb-1">Suggested intent</label>
          <input type="text" id="gen-llm-intent" class="w-full border rounded-xl px-3 py-2 text-sm font-mono"
            placeholder="e.g. breakfast_info" />
        </div>
        <div>
          <label class="block text-xs font-medium text-neutral-500 mb-1">Category (guest phase)</label>
          <select id="gen-llm-phase" class="w-full border rounded-xl px-3 py-2 text-sm">
            <option value="GENERAL_SUPPORT">ğŸ‘‹ General Support</option>
            <option value="PRE_ARRIVAL">ğŸ” Pre-Arrival</option>
            <option value="ARRIVAL_CHECKIN">ğŸ¨ Arrival & Check-in</option>
            <option value="DURING_STAY">ğŸ›ï¸ During Stay</option>
            <option value="CHECKOUT_DEPARTURE">ğŸšª Checkout & Departure</option>
            <option value="POST_CHECKOUT">ğŸ“¬ Post-Checkout</option>
            <option value="UNCATEGORIZED">ğŸ“‹ Uncategorized</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-xs font-medium text-neutral-500 mb-1">Response (EN) *</label>
        <textarea id="gen-llm-en" rows="4" class="w-full border rounded-xl px-3 py-2 text-sm"></textarea>
      </div>
      <div>
        <label class="block text-xs font-medium text-neutral-500 mb-1">Response (MS)</label>
        <textarea id="gen-llm-ms" rows="3" class="w-full border rounded-xl px-3 py-2 text-sm"></textarea>
      </div>
      <div>
        <label class="block text-xs font-medium text-neutral-500 mb-1">Response (ZH)</label>
        <textarea id="gen-llm-zh" rows="3" class="w-full border rounded-xl px-3 py-2 text-sm"></textarea>
      </div>
      <div class="flex justify-end gap-2 pt-2 border-t flex-wrap">
        <button type="button" onclick="translateQuickReplyFields('gen-llm-en','gen-llm-ms','gen-llm-zh')"
          class="px-3 py-1.5 text-sm bg-success-500 text-white rounded-2xl hover:bg-success-600"
          title="Fill missing languages using the same AI as LLM reply">Translate</button>
        <button type="button" onclick="closeGenerateByLLMModal()"
          class="px-3 py-1.5 text-sm text-neutral-600 border rounded-2xl hover:bg-neutral-50">Cancel</button>
        <button type="button" onclick="approveGeneratedReply()"
          class="px-3 py-1.5 text-sm bg-success-500 text-white rounded-2xl hover:bg-success-600">Approve &amp; Add to
          Replies</button>
      </div>
    </div>
    <div class="mt-4 flex justify-end">
      <button type="button" onclick="closeGenerateByLLMModal()" id="gen-llm-close-btn"
        class="text-sm text-neutral-500 hover:text-neutral-700">Close</button>
    </div>
  </div>
</div>

<!-- Add Knowledge Modal -->
<div id="add-knowledge-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
  <div class="bg-white rounded-2xl shadow-strong p-6 w-full max-w-lg mx-4">
    <h3 class="text-lg font-semibold mb-4">Add Intent Reply</h3>
    <form onsubmit="submitAddKnowledge(event)">
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Intent</label>
        <input id="add-k-intent" class="w-full border rounded-2xl px-3 py-2 text-sm" required
          placeholder="e.g. breakfast_info" />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Response (EN) *</label>
        <textarea id="add-k-en" rows="3" class="w-full border rounded-2xl px-3 py-2 text-sm" required></textarea>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Response (MS)</label>
        <textarea id="add-k-ms" rows="2" class="w-full border rounded-2xl px-3 py-2 text-sm"></textarea>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Response (ZH)</label>
        <textarea id="add-k-zh" rows="2" class="w-full border rounded-2xl px-3 py-2 text-sm"></textarea>
      </div>
      <div class="flex justify-end gap-2 flex-wrap">
        <button type="button" onclick="translateQuickReplyFields('add-k-en','add-k-ms','add-k-zh')"
          class="px-3 py-1.5 text-sm bg-success-500 text-white rounded-2xl hover:bg-success-600"
          title="Fill missing languages using the same AI as LLM reply">Translate</button>
        <button type="button" onclick="closeModal('add-knowledge-modal')"
          class="px-3 py-1.5 text-sm text-neutral-600 border rounded-2xl hover:bg-neutral-50">Cancel</button>
        <button type="submit"
          class="px-3 py-1.5 text-sm bg-primary-500 text-white rounded-2xl hover:bg-primary-600">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Template Modal -->
<div id="add-template-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
  <div class="bg-white rounded-2xl shadow-strong p-6 w-full max-w-lg mx-4">
    <h3 class="text-lg font-semibold mb-4">Add System Message</h3>
    <form onsubmit="submitAddTemplate(event)">
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Key</label>
        <input id="add-t-key" class="w-full border rounded-2xl px-3 py-2 text-sm" required
          placeholder="e.g. welcome_back" />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">English *</label>
        <textarea id="add-t-en" rows="2" class="w-full border rounded-2xl px-3 py-2 text-sm" required></textarea>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Malay</label>
        <textarea id="add-t-ms" rows="2" class="w-full border rounded-2xl px-3 py-2 text-sm"></textarea>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Chinese</label>
        <textarea id="add-t-zh" rows="2" class="w-full border rounded-2xl px-3 py-2 text-sm"></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeModal('add-template-modal')"
          class="px-3 py-1.5 text-sm text-neutral-600 border rounded-2xl hover:bg-neutral-50">Cancel</button>
        <button type="submit"
          class="px-3 py-1.5 text-sm bg-primary-500 text-white rounded-2xl hover:bg-primary-600">Save</button>
      </div>
    </form>
  </div>
</div>