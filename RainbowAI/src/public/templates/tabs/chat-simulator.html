<div class="mb-4">
  <h2 class="text-lg font-semibold text-neutral-800">Chat Simulator</h2>
  <p class="text-sm text-neutral-500">Test AI responses with Quick Test (ChatGPT-style) or Live Simulation (WhatsApp
    conversations)</p>
</div>

<!-- Tabbed Interface -->
<div class="bg-white border rounded-2xl overflow-hidden mb-4">
  <div class="flex border-b">
    <button id="tab-quick-test" onclick="switchSimulatorTab('quick-test')"
      class="flex-1 px-4 py-3 text-sm font-medium text-primary-600 border-b-2 border-primary-500 bg-primary-50 transition">
      ğŸ’¬ Quick Test
    </button>
    <button id="tab-live-simulation" onclick="switchSimulatorTab('live-simulation')"
      class="flex-1 px-4 py-3 text-sm font-medium text-neutral-600 hover:text-neutral-800 hover:bg-neutral-50 transition">
      ğŸ“± Live Simulation
    </button>
    <button onclick="testIntentClassifier()"
      class="px-4 py-3 text-sm font-medium bg-indigo-500 hover:bg-indigo-600 text-white transition flex items-center gap-2">
      <span>ğŸ¯</span>
      <span>Test Intent Classifier</span>
    </button>
  </div>
</div>

<!-- Tab 1: Quick Test (ChatGPT-style) -->
<div id="quick-test-content" class="simulator-tab-content">
  <!-- Autotest Panel (hidden by default) -->
  <div id="autotest-panel" class="hidden">
    <!-- Autotest Header -->
    <div class="bg-indigo-50 border rounded-2xl p-4 mb-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-2xl">ğŸ§ª</span>
          <div>
            <h3 class="font-semibold text-neutral-800">Autotest Suite</h3>
            <p class="text-xs text-neutral-500">58 scenarios across 6 guest journey phases</p>
          </div>
        </div>
        <div class="flex gap-2">
          <!-- View History Button -->
          <button id="view-history-btn" onclick="showAutotestHistory()"
            class="text-sm bg-white border border-neutral-300 hover:bg-neutral-50 px-3 py-1.5 rounded-2xl transition flex items-center gap-1"
            title="View past test runs (available even while Autotest is running)">
            <span>ğŸ“‹</span>
            <span>History</span>
          </button>
          <!-- Export Report Dropdown -->
          <div id="export-report-dropdown" class="hidden relative">
            <button onclick="toggleExportDropdown()"
              class="text-sm bg-white border border-neutral-300 hover:bg-neutral-50 px-3 py-1.5 rounded-2xl transition flex items-center gap-1">
              Export Report
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div id="export-dropdown-menu"
              class="hidden absolute right-0 mt-1 w-72 bg-white border border-neutral-300 rounded-xl shadow-lg z-50">
              <button onclick="exportAutotestReport(lastAutotestResults, 'all')"
                class="w-full text-left text-sm px-4 py-2.5 hover:bg-neutral-50 transition flex items-center gap-2 rounded-t-xl">
                <span class="text-lg">ğŸ“Š</span>
                <span>Export All Results</span>
              </button>
              <button onclick="exportAutotestReport(lastAutotestResults, 'warnings-failed')"
                class="w-full text-left text-sm px-4 py-2.5 hover:bg-neutral-50 transition flex items-center gap-2 border-t border-neutral-200">
                <span class="text-lg">âš ï¸</span>
                <span>Export Warnings & Failed Only</span>
              </button>
              <button onclick="exportAutotestReport(lastAutotestResults, 'failed')"
                class="w-full text-left text-sm px-4 py-2.5 hover:bg-neutral-50 transition flex items-center gap-2 border-t border-neutral-200 rounded-b-xl">
                <span class="text-lg">âŒ</span>
                <span>Export Failed Only</span>
              </button>
            </div>
          </div>
          <div class="flex items-center gap-1.5"
            title="Number of scenarios run at the same time. Higher = faster but may cause timeouts or rate limits. Default 6. Lower to 3â€“4 if you see many failures.">
            <label for="autotest-concurrency" class="text-xs text-neutral-500 whitespace-nowrap">Concurrent:</label>
            <input type="number" id="autotest-concurrency" min="1" max="20" value="6"
              class="w-12 text-sm text-center border border-neutral-300 rounded-lg px-1 py-1.5 bg-white"
              aria-label="Concurrent tests">
          </div>
          <div id="run-all-dropdown" class="relative inline-block">
            <button id="run-all-btn" onclick="toggleRunAllDropdown()"
              class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-1.5 rounded-2xl transition inline-flex items-center gap-1">
              Run All
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div id="run-all-dropdown-menu"
              class="hidden absolute right-0 mt-1 w-56 bg-white border border-neutral-300 rounded-xl shadow-lg z-50 py-1">
              <button type="button" onclick="runAutotestWithFilter('all'); closeRunAllDropdown();"
                class="w-full text-left text-sm px-4 py-2.5 hover:bg-neutral-50 transition flex items-center gap-2 rounded-t-xl">
                <span>ğŸ“‹</span>
                <span>Run All</span>
                <span id="run-all-count" class="ml-auto text-neutral-400 text-xs">0</span>
              </button>
              <button type="button" onclick="runAutotestWithFilter('static_reply'); closeRunAllDropdown();"
                class="w-full text-left text-sm px-4 py-2.5 hover:bg-neutral-50 transition flex items-center gap-2 border-t border-neutral-100">
                <span>ğŸ“Œ</span>
                <span>Static Reply only</span>
                <span id="run-static-count" class="ml-auto text-neutral-400 text-xs">0</span>
              </button>
              <button type="button" onclick="runAutotestWithFilter('workflow'); closeRunAllDropdown();"
                class="w-full text-left text-sm px-4 py-2.5 hover:bg-neutral-50 transition flex items-center gap-2 border-t border-neutral-100">
                <span>ğŸ”„</span>
                <span>Workflow only</span>
                <span id="run-workflow-count" class="ml-auto text-neutral-400 text-xs">0</span>
              </button>
              <button type="button" onclick="runAutotestWithFilter('llm_reply'); closeRunAllDropdown();"
                class="w-full text-left text-sm px-4 py-2.5 hover:bg-neutral-50 transition flex items-center gap-2 border-t border-neutral-100 rounded-b-xl">
                <span>ğŸ¤–</span>
                <span>LLM Reply only</span>
                <span id="run-llm-count" class="ml-auto text-neutral-400 text-xs">0</span>
              </button>
            </div>
          </div>
          <button id="stop-autotest-btn" onclick="stopAutotest()"
            class="hidden text-sm bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded-2xl transition">Stop</button>
          <button onclick="toggleAutotest()"
            class="text-sm bg-white border border-neutral-300 hover:bg-neutral-50 px-3 py-1.5 rounded-2xl transition">Back
            to Chat</button>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div id="autotest-summary" class="grid grid-cols-5 gap-3 mb-4 hidden">
      <div class="bg-white border rounded-2xl p-3 text-center">
        <div class="text-2xl font-bold text-neutral-800" id="at-total">0</div>
        <div class="text-xs text-neutral-500">Total</div>
      </div>
      <div class="bg-white border rounded-2xl p-3 text-center">
        <div class="text-2xl font-bold text-green-600" id="at-passed">0</div>
        <div class="text-xs text-neutral-500">Passed</div>
      </div>
      <div class="bg-white border rounded-2xl p-3 text-center">
        <div class="text-2xl font-bold text-yellow-600" id="at-warnings">0</div>
        <div class="text-xs text-neutral-500">Warnings</div>
      </div>
      <div class="bg-white border rounded-2xl p-3 text-center">
        <div class="text-2xl font-bold text-red-600" id="at-failed">0</div>
        <div class="text-xs text-neutral-500">Failed</div>
      </div>
      <div class="bg-white border rounded-2xl p-3 text-center">
        <div class="text-2xl font-bold text-indigo-600" id="at-time">0s</div>
        <div class="text-xs text-neutral-500">Time</div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div id="autotest-progress" class="hidden mb-4">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <div class="animate-spin h-4 w-4 border-2 border-indigo-500 border-t-transparent rounded-full"></div>
          <span id="at-progress-text" class="text-sm text-neutral-600">Running...</span>
        </div>
        <div id="at-live-counters" class="flex items-center gap-3 text-xs font-medium">
          <span class="text-green-600"><span id="at-live-pass">0</span> Pass</span>
          <span class="text-yellow-600"><span id="at-live-warn">0</span> Warn</span>
          <span class="text-red-600"><span id="at-live-fail">0</span> Fail</span>
        </div>
      </div>
      <div class="w-full bg-neutral-200 rounded-full h-2">
        <div id="at-progress-bar" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%">
        </div>
      </div>
    </div>

    <!-- Results Container -->
    <div id="autotest-results" class="space-y-2" style="max-height: calc(100vh - 420px); overflow-y: auto;">
      <div class="text-center text-neutral-400 text-sm py-12">
        <p>Click "Run All" to execute <span id="scenario-count">0</span> test scenarios</p>
        <p class="text-xs mt-1">Tests check intent detection, multilingual support, edge cases, and more</p>
      </div>
    </div>
  </div>

  <!-- Autotest History Modal -->
  <div id="autotest-history-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
      <!-- Modal Header -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-neutral-800">Test History</h3>
        <button onclick="closeAutotestHistory()" class="text-neutral-500 hover:text-neutral-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- History List -->
      <div id="autotest-history-list" class="flex-1 overflow-y-auto space-y-2">
        <div class="text-center text-neutral-400 text-sm py-12">
          <p>No test history yet</p>
          <p class="text-xs mt-1">Run tests to see results here</p>
        </div>
      </div>
    </div>
  </div>

  <!-- WhatsApp-style Layout (matches Live Chat) -->
  <div id="chat-layout" class="lc-container overflow-hidden rounded-2xl border"
    style="height: calc(100vh - 340px); min-height: 600px;">

    <!-- Sidebar: Chat Sessions -->
    <div class="cs-sidebar">
      <!-- Sidebar Header -->
      <div class="cs-sidebar-header">
        <button onclick="createNewChat()"
          class="cs-new-chat-btn">
          + New Chat
        </button>
      </div>

      <!-- Chat Sessions List -->
      <div id="chat-sessions" class="lc-chat-list" style="padding: 0;">
        <!-- Sessions will be populated here -->
      </div>

      <!-- Info Footer -->
      <div class="cs-sidebar-footer">
        <span>Sessions auto-save</span>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="lc-main" style="background: #efeae2;">
      <!-- Chat Header -->
      <div class="lc-chat-header">
        <div style="display:flex;align-items:center;">
          <div class="lc-header-avatar" style="background:#6366f1;font-size:18px;">AI</div>
          <div class="lc-header-info">
            <div class="lc-header-name">Guest Simulation</div>
            <div class="lc-header-phone">Messages use current Rainbow config</div>
          </div>
        </div>
        <div class="lc-header-actions">
          <button onclick="showQuickTestHistory()" title="Quick Test History">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </button>
          <button onclick="toggleAutotest()" title="Autotest Suite" style="font-size:13px;padding:6px 12px;border-radius:6px;background:#6366f1;color:#fff;">Autotest</button>
          <button onclick="clearCurrentChat()" title="Clear Chat">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
          </button>
          <button onclick="toggleChatFullscreen('chat-layout')" title="Fullscreen" class="fullscreen-toggle-btn">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Detection meta (subtle bar under header) -->
      <div id="chat-meta" class="cs-meta-bar">
        <!-- Detection: Fuzzy | Intent: ... | Routed to: ... (populated after AI responses) -->
      </div>

      <!-- Chat Messages Container (WhatsApp-style) -->
      <div id="chat-messages" class="lc-messages" style="flex-direction: column-reverse;">
        <!-- Welcome message -->
        <div class="text-center py-8" style="color:#667781;">
          <div style="font-size:14px;font-weight:500;margin-bottom:4px;">Welcome to AI Agent Preview</div>
          <div style="font-size:12px;">Type a message to test how the AI responds</div>
        </div>
      </div>

      <!-- Chat Input (WhatsApp-style bottom bar) -->
      <div class="lc-input-area">
        <form onsubmit="sendChatMessage(event)" style="display:flex;align-items:flex-end;gap:8px;width:100%;">
          <input type="text" id="chat-input" placeholder="Type a guest message..."
            class="lc-input-box" style="min-height:42px;border-radius:8px;padding:10px 14px;border:none;outline:none;"
            autocomplete="off" />
          <button type="submit" id="send-btn" class="lc-send-btn" title="Send">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Quick Test History Modal -->
  <div id="qt-history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-neutral-800">Quick Test History</h3>
        <div class="flex items-center gap-2">
          <button onclick="clearQuickTestHistory()" class="text-xs text-red-500 hover:text-red-600 transition">Clear All</button>
          <button onclick="closeQuickTestHistory()" class="text-neutral-500 hover:text-neutral-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div id="qt-history-list" class="flex-1 overflow-y-auto space-y-2">
        <div class="text-center text-neutral-400 text-sm py-12">
          <p>No quick test history yet</p>
          <p class="text-xs mt-1">Send messages in Quick Test to build history</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tab 2: Live Simulation (WhatsApp-style) -->
<div id="live-simulation-content" class="simulator-tab-content hidden">
  <!-- WhatsApp connection status (Floating) -->
  <div id="rc-wa-status-bar" class="wa-floating-status" onclick="this.classList.toggle('expanded')" role="status"
    aria-live="polite" title="WhatsApp Connection Status">
    <span class="wa-icon">ğŸ“±</span>
    <span class="wa-connection-text wa-text">Checkingâ€¦</span>
  </div>
  <div class="rc-container">
    <!-- Sidebar: Conversation List -->
    <div class="rc-sidebar" id="rc-sidebar">
      <div class="rc-sidebar-header">
        <select class="rc-instance-filter" id="rc-instance-filter" onchange="filterConversations()">
          <option value="">All Instances</option>
        </select>
        <input type="text" class="rc-search" id="rc-search" placeholder="Search conversations..."
          oninput="filterConversations()">
      </div>
      <div class="rc-chat-list" id="rc-chat-list">
        <div class="rc-sidebar-empty" id="rc-sidebar-empty">
          <p>No conversations yet.</p>
          <p style="margin-top:4px;font-size:12px;">Real WhatsApp chats will appear here once guests message your AI
            bot.</p>
        </div>
      </div>
    </div>

    <!-- Main: Chat View -->
    <div class="rc-main" id="rc-main">
      <div class="rc-empty-state" id="rc-empty-state">
        <svg viewBox="0 0 303 172" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M229.565 160.229C262.212 149.245 286.931 118.241 283.39 73.4194C278.009 5.31929 210.79 -13.3636 152.068 7.57783C93.347 28.5765 44.1521 24.4094 20.1704 45.7478C-3.81149 67.0862 -4.63543 121.735 37.3013 148.288C79.2381 174.841 191.585 173.17 229.565 160.229Z"
            fill="#DAF7E3" />
          <rect x="54" y="28" width="195" height="130" rx="10" fill="white" stroke="#E0E0E0" stroke-width="2" />
          <rect x="54" y="28" width="65" height="130" rx="10" fill="#F7F8FC" />
          <circle cx="86" cy="56" r="8" fill="#CBD5E1" />
          <rect x="66" y="70" width="40" height="4" rx="2" fill="#CBD5E1" />
          <circle cx="86" cy="88" r="8" fill="#CBD5E1" />
          <rect x="66" y="102" width="40" height="4" rx="2" fill="#CBD5E1" />
          <rect x="135" y="50" width="90" height="16" rx="6" fill="#E8F5E9" />
          <rect x="145" y="76" width="80" height="16" rx="6" fill="#F3F4F6" />
          <rect x="135" y="102" width="90" height="16" rx="6" fill="#E8F5E9" />
        </svg>
        <h3>Real Chat Monitor</h3>
        <p>Select a conversation from the sidebar to view the chat between your AI assistant and guests.</p>
      </div>

      <!-- Active chat view (hidden until conversation selected) -->
      <div id="rc-active-chat" style="display:none;flex-direction:column;height:100%;">
        <div class="rc-main-header">
          <div class="rc-avatar" id="rc-active-avatar">?</div>
          <div class="rc-header-info">
            <div class="rc-header-name" id="rc-active-name">Guest</div>
            <div class="rc-header-phone" id="rc-active-phone">+60... <span id="rc-active-instance"
                class="rc-instance-badge" style="margin-left:4px;"></span></div>
          </div>
          <div class="rc-header-actions" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
            <!-- Refresh indicator -->
            <span id="rc-refresh-indicator" class="rc-refresh-indicator" title="Auto-refreshes every 3 seconds">
              <span class="rc-spin-icon">âŸ³</span>
              <span id="rc-last-refresh">Updated just now</span>
            </span>
            <button class="rc-dev-toggle" id="rc-dev-toggle" onclick="toggleDevMode()" title="Toggle Developer Mode">
              ğŸ”§ Dev
            </button>
            <!-- Message search toggle (visible in dev mode) -->
            <button id="rc-search-toggle" class="rc-dev-toggle" onclick="toggleRcSearch()" title="Search messages"
              style="display:none;">
              ğŸ” Search
            </button>
            <button class="rc-translate-toggle" id="rc-translate-toggle" onclick="toggleTranslateMode()"
              title="Toggle Translation Mode">
              ğŸŒ Translate
            </button>
            <select class="rc-lang-selector" id="rc-lang-selector" title="Target Language" style="display:none;"
              onchange="handleLangChange()">
              <option value="en">English</option>
              <option value="ms">Malay</option>
              <option value="zh">Chinese</option>
              <option value="id">Indonesian</option>
              <option value="th">Thai</option>
              <option value="vi">Vietnamese</option>
            </select>
            <button onclick="refreshActiveChat()" title="Refresh">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 2v6h-6M3 12a9 9 0 0115-6.7L21 8M3 22v-6h6M21 12a9 9 0 01-15 6.7L3 16" />
              </svg>
            </button>
            <button onclick="deleteActiveChat()" title="Delete conversation">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" />
              </svg>
            </button>
            <button onclick="toggleChatFullscreen('rc-active-chat')" title="Fullscreen" class="fullscreen-toggle-btn">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
              </svg>
            </button>
          </div>
        </div>
        <!-- Message Search Bar (shown via Dev mode) -->
        <div id="rc-search-container" class="rc-msg-search-bar" style="display:none;">
          <input type="text" class="rc-msg-search-input" placeholder="Search messagesâ€¦"
            oninput="SearchPanel.handleInput(this.value)"
            onkeydown="if(event.key==='Enter'){event.preventDefault();SearchPanel.navigate(event.shiftKey?-1:1);}if(event.key==='Escape'){toggleRcSearch();}">
          <span class="rc-msg-search-count"></span>
          <button class="rc-msg-search-btn" onclick="SearchPanel.navigate(-1)" title="Previous match">â†‘</button>
          <button class="rc-msg-search-btn" onclick="SearchPanel.navigate(1)" title="Next match">â†“</button>
          <button class="rc-msg-search-btn" onclick="toggleRcSearch()" title="Close search">âœ•</button>
        </div>
        <div class="rc-messages" id="rc-messages"></div>
        <!-- File preview bar (shown when file selected) -->
        <div class="rc-file-preview" id="rc-file-preview" style="display:none;">
          <div class="rc-file-preview-inner">
            <div class="rc-file-preview-thumb" id="rc-file-preview-thumb"></div>
            <div class="rc-file-preview-info">
              <div class="rc-file-preview-name" id="rc-file-preview-name"></div>
              <div class="rc-file-preview-size" id="rc-file-preview-size"></div>
            </div>
            <button class="rc-file-preview-remove" onclick="clearRcFile()" title="Remove file">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
          <input type="text" class="rc-file-caption" id="rc-file-caption" placeholder="Add a caption...">
        </div>

        <div class="rc-input-area">
          <!-- Attachment button + popup -->
          <div class="rc-attach-wrap">
            <button class="rc-attach-btn" id="rc-attach-btn" onclick="toggleRcAttachMenu()" title="Attach">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path
                  d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" />
              </svg>
            </button>
            <div class="rc-attach-menu" id="rc-attach-menu" style="display:none;">
              <button class="rc-attach-option" onclick="pickRcFile('photo')">
                <span class="rc-attach-icon rc-attach-photo">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path
                      d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                  </svg>
                </span>
                <span>Photos & videos</span>
              </button>
              <button class="rc-attach-option" onclick="pickRcFile('document')">
                <span class="rc-attach-icon rc-attach-doc">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z" />
                  </svg>
                </span>
                <span>Document</span>
              </button>
            </div>
          </div>
          <!-- Hidden file inputs -->
          <input type="file" id="rc-file-photo" accept="image/*,video/*" style="display:none;"
            onchange="rcFileSelected(this, 'photo')">
          <input type="file" id="rc-file-doc" accept="*/*" style="display:none;"
            onchange="rcFileSelected(this, 'document')">

          <textarea class="rc-input-box" id="rc-input-box" placeholder="Type a manual reply..." rows="1"
            oninput="autoResizeInput(this)" onkeydown="handleInputKeydown(event)"></textarea>
          <button class="rc-send-btn" id="rc-send-btn" onclick="sendManualReply()" title="Send message">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
        <!-- Translation preview: shown below typing box when translate mode + target language selected -->
        <div class="rc-translate-preview" id="rc-translate-preview" style="display:none;">
          <div class="rc-translate-preview-label"><span id="rc-translate-preview-lang"></span>:</div>
          <div class="rc-translate-preview-text" id="rc-translate-preview-text"></div>
          <div class="rc-translate-preview-hint"><kbd>Enter</kbd> send translation Â· <kbd>Ctrl</kbd>+<kbd>Enter</kbd> send original</div>
        </div>
        <div class="rc-stats-bar" id="rc-stats-bar">
          <span id="rc-stat-total">0 messages</span>
          <span id="rc-stat-started">Started: â€”</span>
          <span id="rc-stat-last">Last active: â€”</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Translation Confirmation Modal -->
  <div id="rc-translate-modal" class="rc-translate-modal" style="display:none;"
    onclick="if(event.target===this) closeTranslateModal()">
    <div class="rc-translate-content">
      <div class="rc-translate-title">ğŸŒ Confirm Translation</div>
      <div style="margin-bottom:12px;">
        <strong style="color:#6b7280;font-size:12px;">Original:</strong>
        <div class="rc-translate-text" id="rc-translate-original"></div>
      </div>
      <div style="margin-bottom:16px;">
        <strong style="color:#6b7280;font-size:12px;">Translated (<span id="rc-translate-lang-name"></span>):</strong>
        <div class="rc-translate-text" id="rc-translate-translated"></div>
      </div>
      <div class="rc-translate-buttons">
        <button class="rc-translate-btn cancel" onclick="closeTranslateModal()">Cancel</button>
        <button class="rc-translate-btn send" onclick="confirmTranslation()">Send Translation</button>
      </div>
    </div>
  </div>

  <!-- Edit Response Modal (Live Simulation: save to Responses / workflow) -->
  <div id="rc-edit-modal" class="rc-translate-modal" style="display:none;"
    onclick="if(event.target===this) closeRcEditModal()">
    <div class="rc-translate-content" style="max-width:520px;" onclick="event.stopPropagation()">
      <div class="rc-translate-title">âœï¸ Edit response (saves to Train â†’ Responses)</div>
      <p class="text-xs text-neutral-500 mb-3">The message already sent to the customer cannot be changed. Saving
        updates the template for future replies.</p>
      <div id="rc-edit-form"></div>
      <div class="rc-translate-buttons mt-3">
        <button type="button" class="rc-translate-btn cancel" onclick="closeRcEditModal()">Cancel</button>
        <span id="rc-edit-save-buttons"></span>
      </div>
    </div>
  </div>

  <!-- Add to Training Example Modal (Live Simulation â†’ Understanding) -->
  <div id="rc-add-example-modal" class="rc-translate-modal" style="display:none;"
    onclick="if(event.target===this) closeAddToTrainingExampleModal()">
    <div class="rc-translate-content" style="max-width:480px;" onclick="event.stopPropagation()">
      <div class="rc-translate-title">ğŸ“š Add to Training Example</div>
      <p class="text-xs text-neutral-500 mb-3">Add this guest message as a Learning Example in
        <strong>Understanding</strong>. Choose the intent it belongs to. Server restart required to reload semantic
        matcher after saving.
      </p>
      <div class="mb-3">
        <label class="block text-xs font-medium text-neutral-600 mb-1">Message</label>
        <div id="rc-add-example-text" class="bg-neutral-50 rounded-lg p-2 text-sm border min-h-[2.5rem]"></div>
      </div>
      <div class="mb-3">
        <label class="block text-xs font-medium text-neutral-600 mb-1">Intent</label>
        <select id="rc-add-example-intent" class="w-full border rounded-lg px-3 py-2 text-sm"></select>
      </div>
      <div class="rc-translate-buttons mt-3">
        <button type="button" class="rc-translate-btn cancel" onclick="closeAddToTrainingExampleModal()">Cancel</button>
        <button type="button" class="rc-translate-btn send" id="rc-add-example-btn"
          onclick="confirmAddToTrainingExample()">Add to Training Examples</button>
      </div>
    </div>
  </div>
</div>