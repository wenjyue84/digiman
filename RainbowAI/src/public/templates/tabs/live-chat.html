<div class="lc-container">
  <!-- Sidebar: Conversation List -->
  <div class="lc-sidebar" id="lc-sidebar">
    <div class="lc-sidebar-header">
      <!-- Top bar: Chats title + status dot + action icons (WhatsApp Web style) -->
      <div class="lc-sidebar-topbar">
        <div class="lc-sidebar-title-wrap">
          <h2 class="lc-sidebar-title">Chats</h2>
          <!-- WhatsApp status dot (US-077) -->
          <div class="lc-wa-dot lc-wa-checking" id="lc-wa-dot" onclick="lcShowWaStatusTooltip(event)" title="Checking WhatsApp status...">
            <span class="lc-wa-dot-inner"></span>
            <div class="lc-wa-tooltip" id="lc-wa-tooltip" style="display:none;">
              <div class="lc-wa-tooltip-status" id="lc-wa-tooltip-status">Checking...</div>
              <div class="lc-wa-tooltip-phone" id="lc-wa-tooltip-phone">Checking connection status</div>
            </div>
          </div>
        </div>
        <!-- Payment reminder bell (US-022) -->
        <button type="button" class="lc-reminder-bell" id="lc-reminder-bell" onclick="lcShowOverdueReminders()" title="Payment reminders" style="display:none;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 01-3.46 0"/>
          </svg>
          <span class="lc-reminder-bell-count" id="lc-reminder-bell-count">0</span>
        </button>
        <div class="lc-sidebar-actions">
          <button type="button" class="lc-sidebar-action-btn" onclick="lcNewChat()" title="New chat">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#54656f" stroke-width="2">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
              <line x1="12" y1="8" x2="12" y2="14" />
              <line x1="9" y1="11" x2="15" y2="11" />
            </svg>
          </button>
          <div class="lc-sidebar-menu-wrap">
            <button type="button" class="lc-sidebar-menu-btn" onclick="lcToggleSidebarMenu()" title="Menu">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#54656f" stroke-width="2">
                <circle cx="12" cy="6" r="1.5" />
                <circle cx="12" cy="12" r="1.5" />
                <circle cx="12" cy="18" r="1.5" />
              </svg>
            </button>
            <div class="lc-sidebar-dropdown" id="lc-sidebar-dropdown" style="display:none;">
              <!-- Staff name (US-012) ‚Äî moved from header into menu -->
              <button type="button" class="lc-sidebar-dropdown-item" onclick="lcEditStaffName()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Staff: <span id="lc-staff-name">Staff</span></span>
              </button>
              <div class="lc-sidebar-dropdown-item lc-instance-select-wrap">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="5" y="2" width="14" height="20" rx="2" ry="2" />
                  <line x1="12" y1="18" x2="12" y2="18" />
                </svg>
                <select class="lc-instance-filter" id="lc-instance-filter" onchange="lcFilterConversations()">
                  <option value="">All Instances</option>
                </select>
              </div>
              <button type="button" class="lc-sidebar-dropdown-item" onclick="lcToggleDateFilterPanel()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                  <line x1="16" y1="2" x2="16" y2="6" />
                  <line x1="8" y1="2" x2="8" y2="6" />
                  <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
                <span>Date Range Filter</span>
                <span class="lc-date-filter-badge" id="lc-date-filter-badge" style="display:none;"></span>
              </button>
              <button type="button" class="lc-sidebar-dropdown-item" onclick="lcShowStarredMessages()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                </svg>
                <span>Starred messages</span>
              </button>
              <button type="button" class="lc-sidebar-dropdown-item" onclick="lcMarkAllAsRead()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                <span>Mark all as read</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Search bar -->
      <div class="lc-search-wrap">
        <svg class="lc-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input type="text" class="lc-search" id="lc-search" placeholder="Search or start new chat"
          oninput="lcDebouncedSearch()">
      </div>
    </div>
    <div class="lc-date-filter-panel" id="lc-date-filter-panel" style="display:none;">
      <div class="lc-date-filter-wrap">
        <div class="lc-date-filter-label">Date Range:</div>
        <input type="date" class="lc-date-filter" id="lc-date-from" onchange="lcFilterConversations()" title="From date">
        <span class="lc-date-filter-separator">to</span>
        <input type="date" class="lc-date-filter" id="lc-date-to" onchange="lcFilterConversations()" title="To date">
        <button type="button" class="lc-date-filter-reset" onclick="lcResetDateFilter()" title="Clear date filter">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
    <div class="lc-filter-chips" id="lc-filter-chips">
      <button class="lc-chip active" data-filter="all" onclick="lcSetFilter('all')">All</button>
      <button class="lc-chip" data-filter="unread" onclick="lcSetFilter('unread')">Unread</button>
      <!-- Hidden tag dropdown (still used by panel tag select) -->
      <div class="lc-tag-filter-wrap" id="lc-tag-filter-wrap" style="display:none">
        <div class="lc-tag-filter-dropdown" id="lc-tag-filter-dropdown" style="display:none;"></div>
      </div>
      <!-- Unified Filter Panel (All filters consolidated) -->
      <div class="lc-filter-panel-wrap" id="lc-filter-panel-wrap">
        <button class="lc-chip lc-filter-panel-btn" id="lc-filter-panel-btn" onclick="lcToggleFilterPanel()" title="Filter conversations">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:2px"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/></svg>
          <span>Filters</span>
          <span class="lc-filter-badge" id="lc-filter-badge" style="display:none">0</span>
        </button>
        <div class="lc-filter-panel" id="lc-filter-panel" style="display:none"></div>
      </div>
    </div>
    <div class="lc-chat-list" id="lc-chat-list">
      <!-- Skeleton loading (US-145) ‚Äî shown until real data arrives -->
      <div class="lc-skeleton-wrap" id="lc-skeleton-wrap">
        <div class="lc-skeleton-item"><div class="lc-skeleton-avatar"></div><div class="lc-skeleton-lines"><div class="lc-skeleton-line lc-skeleton-line-name"></div><div class="lc-skeleton-line lc-skeleton-line-msg"></div></div></div>
        <div class="lc-skeleton-item"><div class="lc-skeleton-avatar"></div><div class="lc-skeleton-lines"><div class="lc-skeleton-line lc-skeleton-line-name"></div><div class="lc-skeleton-line lc-skeleton-line-msg"></div></div></div>
        <div class="lc-skeleton-item"><div class="lc-skeleton-avatar"></div><div class="lc-skeleton-lines"><div class="lc-skeleton-line lc-skeleton-line-name"></div><div class="lc-skeleton-line lc-skeleton-line-msg"></div></div></div>
        <div class="lc-skeleton-item"><div class="lc-skeleton-avatar"></div><div class="lc-skeleton-lines"><div class="lc-skeleton-line lc-skeleton-line-name"></div><div class="lc-skeleton-line lc-skeleton-line-msg"></div></div></div>
        <div class="lc-skeleton-item"><div class="lc-skeleton-avatar"></div><div class="lc-skeleton-lines"><div class="lc-skeleton-line lc-skeleton-line-name"></div><div class="lc-skeleton-line lc-skeleton-line-msg"></div></div></div>
      </div>
      <div class="lc-sidebar-empty" id="lc-sidebar-empty" style="display:none">
        <p>No conversations yet</p>
        <p class="lc-sidebar-hint">Chats will appear here when guests message your WhatsApp.</p>
      </div>
    </div>
  </div>

  <!-- Resizable Divider (US-072) -->
  <div class="lc-divider" id="lc-divider" title="Drag to resize"></div>

  <!-- Main: Chat View -->
  <div class="lc-main" id="lc-main">
    <!-- Empty state -->
    <div class="lc-empty-state" id="lc-empty-state">
      <div class="lc-empty-icon">
        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="50" cy="50" r="45" fill="#00a884" opacity="0.08" />
          <path
            d="M50 20C33.4 20 20 32.5 20 47.8c0 5.3 1.6 10.2 4.3 14.4L20 80l18.4-4.8C42.2 77 46 78 50 78c16.6 0 30-12.5 30-27.8S66.6 20 50 20z"
            fill="#00a884" opacity="0.15" />
          <path
            d="M65 45H45c-1.1 0-2 .9-2 2s.9 2 2 2h20c1.1 0 2-.9 2-2s-.9-2-2-2zm-5 8H45c-1.1 0-2 .9-2 2s.9 2 2 2h15c1.1 0 2-.9 2-2s-.9-2-2-2zm5-16H45c-1.1 0-2 .9-2 2s.9 2 2 2h20c1.1 0 2-.9 2-2s-.9-2-2-2z"
            fill="#00a884" opacity="0.4" />
        </svg>
      </div>
      <h3>Guest Support Chat</h3>
      <p>Select a conversation from the sidebar to start chatting with guests.</p>
    </div>

    <!-- Active chat view (hidden until conversation selected) -->
    <div id="lc-active-chat" style="display:none;flex-direction:column;height:100%;">
      <!-- Green WhatsApp header -->
      <div class="lc-chat-header">
        <!-- Mobile back button (US-092) -->
        <button type="button" class="lc-back-btn" onclick="lcMobileBack()" title="Back to chats">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
        </button>
        <div class="lc-header-avatar" id="lc-header-avatar" onclick="lcToggleContactPanel()" style="cursor:pointer" title="View contact details">?</div>
        <div class="lc-header-info" onclick="lcToggleContactPanel()" style="cursor:pointer" title="View contact details">
          <div class="lc-header-name" id="lc-header-name">Guest</div>
          <div class="lc-header-phone" id="lc-header-phone">+60...</div>
        </div>
        <div class="lc-header-actions">
          <!-- Flag-icon language selector (US-096) -->
          <div class="lc-flag-selector-wrap" id="lc-flag-selector-wrap" style="display:none;">
            <button class="lc-flag-btn" id="lc-flag-btn" onclick="lcToggleFlagMenu()" title="Target Language">
              <span id="lc-flag-icon">&#127468;&#127463;</span>
            </button>
            <div class="lc-flag-dropdown" id="lc-flag-dropdown" style="display:none;">
              <button class="lc-flag-option" data-lang="en" onclick="lcSelectLang('en')">&#127468;&#127463; English</button>
              <button class="lc-flag-option" data-lang="ms" onclick="lcSelectLang('ms')">&#127474;&#127486; Malay</button>
              <button class="lc-flag-option" data-lang="zh" onclick="lcSelectLang('zh')">&#127464;&#127475; Chinese</button>
              <button class="lc-flag-option" data-lang="id" onclick="lcSelectLang('id')">&#127470;&#127465; Indonesian</button>
              <button class="lc-flag-option" data-lang="th" onclick="lcSelectLang('th')">&#127481;&#127469; Thai</button>
              <button class="lc-flag-option" data-lang="vi" onclick="lcSelectLang('vi')">&#127483;&#127475; Vietnamese</button>
            </div>
          </div>
          <!-- Hidden select for backward compat -->
          <select id="lc-lang-selector" style="display:none!important;">
            <option value="en">English</option>
            <option value="ms">Malay</option>
            <option value="zh">Chinese</option>
            <option value="id">Indonesian</option>
            <option value="th">Thai</option>
            <option value="vi">Vietnamese</option>
          </select>
          <!-- Mode icon (small, icon-only) -->
          <div class="lc-mode-selector-wrap">
            <button class="lc-mode-btn" id="lc-mode-btn" onclick="lcToggleModeMenu()" title="Copilot ‚Äî AI suggests, you approve">
              <span id="lc-mode-icon" class="lc-mode-icon-only">&#129309;</span>
            </button>
            <div class="lc-mode-dropdown" id="lc-mode-dropdown" style="display:none;">
              <button class="lc-mode-option" data-mode="autopilot" onclick="lcSetMode('autopilot')">
                <div class="lc-mode-option-icon">&#9992;&#65039;</div>
                <div class="lc-mode-option-text">
                  <div class="lc-mode-option-title">Autopilot</div>
                  <div class="lc-mode-option-desc">AI responds automatically</div>
                </div>
              </button>
              <button class="lc-mode-option" data-mode="copilot" onclick="lcSetMode('copilot')">
                <div class="lc-mode-option-icon">&#129309;</div>
                <div class="lc-mode-option-text">
                  <div class="lc-mode-option-title">Copilot</div>
                  <div class="lc-mode-option-desc">AI suggests, you approve</div>
                </div>
              </button>
              <button class="lc-mode-option" data-mode="manual" onclick="lcSetMode('manual')">
                <div class="lc-mode-option-icon">&#9997;&#65039;</div>
                <div class="lc-mode-option-text">
                  <div class="lc-mode-option-title">Manual</div>
                  <div class="lc-mode-option-desc">You write, AI helps on request</div>
                </div>
              </button>
              <div class="lc-mode-dropdown-footer">
                <label class="lc-mode-default-checkbox">
                  <input type="checkbox" id="lc-mode-set-default">
                  <span>Set as default for all chats</span>
                </label>
              </div>
            </div>
          </div>
          <!-- Search icon -->
          <button onclick="lcToggleSearch()" title="Search messages" class="lc-header-action-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
          </button>
          <!-- 3-dot menu -->
          <div class="lc-header-menu-wrap">
            <button type="button" onclick="lcToggleHeaderMenu()" title="More" id="lc-header-menu-btn"
              aria-haspopup="true" aria-expanded="false" class="lc-header-action-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="6" r="1.5" />
                <circle cx="12" cy="12" r="1.5" />
                <circle cx="12" cy="18" r="1.5" />
              </svg>
            </button>
            <div class="lc-header-dropdown" id="lc-header-dropdown" role="menu">
              <!-- US-009: Ask AI ‚Äî Prisma entry -->
              <button type="button" class="lc-header-dropdown-item lc-prisma-menu-item" role="menuitem" onclick="lcOpenPrismaWindow()">
                <span style="font-size:16px;line-height:1;color:#6346ff;">‚ú¶</span>
                <span>Ask AI ‚Äî Prisma</span>
              </button>
              <div class="lc-header-dropdown-divider"></div>
              <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcOnMenuContactInfo()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
                <span>Contact Details</span>
              </button>
              <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcOnMenuSearch()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8" />
                  <path d="m21 21-4.35-4.35" />
                </svg>
                <span>Search messages</span>
              </button>
              <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcOnMenuTranslate()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z" />
                </svg>
                <span>Translate</span>
                <span class="lc-menu-toggle-indicator" id="lc-menu-translate-indicator"></span>
              </button>
              <div class="lc-header-dropdown-submenu-wrap">
                <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcOnMenuMode(event)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" />
                    <circle cx="12" cy="12" r="3" />
                  </svg>
                  <span>Mode</span>
                  <span class="lc-menu-mode-current" id="lc-menu-mode-current">Copilot</span>
                  <svg class="lc-submenu-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                </button>
                <div class="lc-header-submenu" id="lc-mode-submenu" style="display:none;">
                  <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcOnMenuSetMode('autopilot')">
                    <span class="lc-submenu-icon">&#9992;&#65039;</span>
                    <span>Autopilot</span>
                  </button>
                  <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcOnMenuSetMode('copilot')">
                    <span class="lc-submenu-icon">&#129309;</span>
                    <span>Copilot</span>
                  </button>
                  <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcOnMenuSetMode('manual')">
                    <span class="lc-submenu-icon">&#9997;&#65039;</span>
                    <span>Manual</span>
                  </button>
                </div>
              </div>
              <div class="lc-header-dropdown-divider"></div>
              <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcToggleMaximize()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3" />
                </svg>
                <span>Focus mode</span>
              </button>
              <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcShowScheduledPanel()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 6v6l4 2" />
                </svg>
                <span>Scheduled messages</span>
                <span class="lc-sched-badge" id="lc-sched-badge" style="display:none;">0</span>
              </button>
              <button type="button" class="lc-header-dropdown-item" role="menuitem" onclick="lcRefreshChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 2v6h-6M3 12a9 9 0 0115-6.7L21 8M3 22v-6h6M21 12a9 9 0 01-15 6.7L3 16" />
                </svg>
                <span>Refresh</span>
              </button>
              <div class="lc-header-dropdown-divider"></div>
              <button type="button" class="lc-header-dropdown-item lc-menu-danger" role="menuitem" onclick="lcOnMenuClearChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                </svg>
                <span>Clear chat</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Message search bar (hidden until toggled) -->
      <div class="lc-msg-search-bar" id="lc-msg-search-bar" style="display:none;">
        <div class="lc-msg-search-input-wrap">
          <svg class="lc-msg-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <input type="text" class="lc-msg-search-input" id="lc-msg-search-input" placeholder="Search messages"
            oninput="lcMsgSearchInput()" onkeydown="lcMsgSearchKeydown(event)">
        </div>
        <span class="lc-msg-search-count" id="lc-msg-search-count"></span>
        <button class="lc-msg-search-nav" onclick="lcMsgSearchNav(-1)" title="Previous match">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 15l-6-6-6 6" />
          </svg>
        </button>
        <button class="lc-msg-search-nav" onclick="lcMsgSearchNav(1)" title="Next match">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6" />
          </svg>
        </button>
        <!-- US-014: Calendar date-jump button -->
        <div class="lc-msg-search-date-wrap">
          <button class="lc-msg-search-nav" id="lc-date-jump-btn" onclick="lcToggleDateJump()" title="Jump to date">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </button>
          <div id="lc-date-jump-popover" class="lc-date-jump-popover" style="display:none;">
            <input type="date" id="lc-date-jump-input" onchange="lcJumpToDate(this.value)">
          </div>
        </div>
        <button class="lc-msg-search-close" onclick="lcToggleSearch()" title="Close search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Messages area -->
      <div class="lc-messages" id="lc-messages"></div>

      <!-- Message context menu: vertical pop-up (opened by chevron on message) -->
      <div id="lc-msg-context-menu" class="lc-msg-context-menu" style="display:none;">
        <div class="lc-msg-menu-list">
          <button type="button" class="lc-msg-action" data-action="emoji" data-emoji="üëç"><span
              class="lc-msg-action-emoji">üëç</span><span>Like</span></button>
          <button type="button" class="lc-msg-action" data-action="emoji" data-emoji="‚ù§Ô∏è"><span
              class="lc-msg-action-emoji">‚ù§Ô∏è</span><span>Love</span></button>
          <button type="button" class="lc-msg-action" data-action="emoji" data-emoji="üòÇ"><span
              class="lc-msg-action-emoji">üòÇ</span><span>Haha</span></button>
          <button type="button" class="lc-msg-action" data-action="emoji" data-emoji="üòÆ"><span
              class="lc-msg-action-emoji">üòÆ</span><span>Wow</span></button>
          <button type="button" class="lc-msg-action" data-action="emoji" data-emoji="üò¢"><span
              class="lc-msg-action-emoji">üò¢</span><span>Sad</span></button>
          <button type="button" class="lc-msg-action" data-action="emoji" data-emoji="üôè"><span
              class="lc-msg-action-emoji">üôè</span><span>Thanks</span></button>
          <button type="button" class="lc-msg-action" data-action="reply">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 10h10a8 8 0 018 8v2M3 10l6 6M3 10l6-6" />
            </svg>
            <span>Reply</span>
          </button>
          <button type="button" class="lc-msg-action" data-action="copy">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" />
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" />
            </svg>
            <span>Copy</span>
          </button>
          <button type="button" class="lc-msg-action" data-action="forward">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 11l-6-6M21 11l-6 6M21 11H9a5 5 0 000 10h3" />
            </svg>
            <span>Forward</span>
          </button>
          <button type="button" class="lc-msg-action" data-action="pin">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 4v6l-2 4h10l-2-4V4" />
              <line x1="12" y1="14" x2="12" y2="21" />
              <line x1="8" y1="4" x2="16" y2="4" />
            </svg>
            <span>Pin</span>
          </button>
          <button type="button" class="lc-msg-action" data-action="star">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
            </svg>
            <span>Star</span>
          </button>
        </div>
      </div>

      <!-- Reply preview bar (shown when replying to a message) -->
      <div class="lc-reply-preview" id="lc-reply-preview" style="display:none;">
        <div class="lc-reply-preview-content">
          <span class="lc-reply-preview-label">Replying to:</span>
          <span class="lc-reply-preview-text" id="lc-reply-preview-text"></span>
        </div>
        <button type="button" class="lc-reply-preview-close" onclick="lcCancelReply()" title="Cancel reply">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- File preview bar (shown when file selected) -->
      <div class="lc-file-preview" id="lc-file-preview" style="display:none;">
        <div class="lc-file-preview-inner">
          <div class="lc-file-preview-thumb" id="lc-file-preview-thumb"></div>
          <div class="lc-file-preview-info">
            <div class="lc-file-preview-name" id="lc-file-preview-name"></div>
            <div class="lc-file-preview-size" id="lc-file-preview-size"></div>
          </div>
          <button class="lc-file-preview-remove" onclick="lcClearFile()" title="Remove file">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
        <input type="text" class="lc-file-caption" id="lc-file-caption" placeholder="Add a caption...">
      </div>

      <!-- Copilot Approval Panel (slim: more space for guest message) ¬∑ Ctrl+Enter=Send, Esc=Reject -->
      <div id="lc-approval-panel" class="lc-approval-panel" style="display:none;">
        <div class="lc-approval-row">
          <div class="lc-approval-head">
            <span class="lc-approval-icon">ü§ñ</span>
            <span class="lc-approval-title">AI Suggestion</span>
            <span class="lc-approval-meta" id="lc-approval-intent">Intent: <strong>wifi</strong></span>
            <span class="lc-approval-meta" id="lc-approval-confidence">Confidence: <strong>0.87</strong></span>
          </div>
          <div class="lc-approval-actions">
            <button type="button" class="lc-approval-btn reject" onclick="lcRejectApproval()" title="Reject (Esc)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
              Reject
            </button>
            <button type="button" class="lc-approval-btn approve" onclick="lcApproveResponse()"
              title="Send (Ctrl+Enter)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5" />
              </svg>
              Send
            </button>
            <button type="button" class="lc-approval-close" onclick="lcDismissApproval()" title="Dismiss">√ó</button>
          </div>
        </div>
        <div class="lc-approval-message">
          <textarea id="lc-approval-text" class="lc-approval-textarea" rows="2"
            placeholder="Suggested reply‚Ä¶"></textarea>
        </div>
      </div>

      <!-- Input area -->
      <div class="lc-input-area">
        <!-- Command palette dropdown (US-015) ‚Äî positioned above input -->
        <div class="lc-cmd-palette" id="lc-cmd-palette" style="display:none;"></div>
        <!-- Workflow palette dropdown (US-016) ‚Äî positioned above input -->
        <div class="lc-wf-palette" id="lc-wf-palette" style="display:none;"></div>
        <!-- Attachment button + popup (US-073: WhatsApp-style '+' menu) -->
        <div class="lc-attach-wrap">
          <button class="lc-attach-btn lc-attach-plus" id="lc-attach-btn" onclick="lcToggleAttachMenu()" title="Attach">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
          </button>
          <div class="lc-attach-menu" id="lc-attach-menu" style="display:none;">
            <button class="lc-attach-option" onclick="lcPickFile('document')">
              <span class="lc-attach-icon lc-attach-doc-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z" />
                </svg>
              </span>
              <span>Document</span>
            </button>
            <button class="lc-attach-option" onclick="lcPickFile('photo')">
              <span class="lc-attach-icon lc-attach-photo-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                </svg>
              </span>
              <span>Photos & videos</span>
            </button>
            <button class="lc-attach-option" onclick="lcPickFile('camera')">
              <span class="lc-attach-icon lc-attach-camera-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z" />
                  <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
                </svg>
              </span>
              <span>Camera</span>
            </button>
            <button class="lc-attach-option" onclick="lcPickFile('audio')">
              <span class="lc-attach-icon lc-attach-audio-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                </svg>
              </span>
              <span>Audio</span>
            </button>
            <button class="lc-attach-option" onclick="lcPickFile('contact')">
              <span class="lc-attach-icon lc-attach-contact-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg>
              </span>
              <span>Contact</span>
            </button>
          </div>
        </div>
        <!-- Hidden file inputs -->
        <input type="file" id="lc-file-photo" accept="image/*,video/*" style="display:none;"
          onchange="lcFileSelected(this, 'photo')">
        <input type="file" id="lc-file-doc" accept="*/*" style="display:none;"
          onchange="lcFileSelected(this, 'document')">
        <input type="file" id="lc-file-camera" accept="image/*" capture="camera" style="display:none;"
          onchange="lcFileSelected(this, 'photo')">
        <input type="file" id="lc-file-audio" accept="audio/*" style="display:none;"
          onchange="lcFileSelected(this, 'audio')">

        <textarea class="lc-input-box" id="lc-input-box" placeholder="Type a message, / for templates, // for workflows" rows="1"
          oninput="lcAutoResize(this); lcOnInputTranslate(); lcOnInputCmd(this)" onkeydown="lcHandleKeydown(event)"></textarea>
        <!-- Help Me button (only visible in manual mode) -->
        <button id="lc-help-me-btn" class="lc-help-me-btn" onclick="lcGetAIHelp()" style="display:none;"
          title="Get AI suggestion">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path
              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
          </svg>
          Help me
        </button>
        <!-- Voice recording indicator (US-074) ‚Äî shown during recording -->
        <div class="lc-voice-recording" id="lc-voice-recording" style="display:none;">
          <button class="lc-voice-cancel" id="lc-voice-cancel" onclick="lcCancelVoiceRecording()" title="Cancel recording">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
          <span class="lc-voice-pulse"></span>
          <span class="lc-voice-timer" id="lc-voice-timer">0:00</span>
        </div>
        <!-- Mic button (US-074) ‚Äî toggle voice recording -->
        <button class="lc-mic-btn" id="lc-mic-btn" onclick="lcToggleVoiceRecording()" title="Voice message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z" />
          </svg>
        </button>
        <!-- Schedule button (US-020) -->
        <button class="lc-schedule-btn" id="lc-schedule-btn" onclick="lcToggleSchedulePopover()" title="Schedule message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 6v6l4 2" />
          </svg>
        </button>
        <!-- Schedule popover (US-020/US-008) -->
        <div class="lc-schedule-popover" id="lc-schedule-popover" style="display:none;">
          <div class="lc-schedule-popover-header">Schedule Message</div>
          <label class="lc-schedule-label">Send at:</label>
          <!-- US-008: Separate date + HH/MM/SS fields -->
          <input type="date" id="lc-schedule-date" class="lc-schedule-datetime" style="margin-bottom:6px;" oninput="lcUpdateSchedulePreview()">
          <div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;">
            <input type="number" id="lc-schedule-hh" min="0" max="23" placeholder="HH" style="width:52px;padding:4px 6px;border:1px solid #e0e0e0;border-radius:6px;font-size:13px;" oninput="lcUpdateSchedulePreview()">
            <span style="font-size:16px;font-weight:600;color:#667781;">:</span>
            <input type="number" id="lc-schedule-mm" min="0" max="59" placeholder="MM" style="width:52px;padding:4px 6px;border:1px solid #e0e0e0;border-radius:6px;font-size:13px;" oninput="lcUpdateSchedulePreview()">
            <span style="font-size:16px;font-weight:600;color:#667781;">:</span>
            <input type="number" id="lc-schedule-ss" min="0" max="59" placeholder="SS" style="width:52px;padding:4px 6px;border:1px solid #e0e0e0;border-radius:6px;font-size:13px;" oninput="lcUpdateSchedulePreview()">
          </div>
          <div id="lc-schedule-preview" style="font-size:12px;color:#25d366;min-height:16px;margin-bottom:4px;"></div>
          <label class="lc-schedule-label" style="margin-top:8px;">Repeat:</label>
          <select class="lc-schedule-repeat" id="lc-schedule-repeat" onchange="lcToggleRepeatEndDate()">
            <option value="none">None</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
          <div class="lc-schedule-end-wrap" id="lc-schedule-end-wrap" style="display:none;">
            <label class="lc-schedule-label" style="margin-top:6px;">End date (optional):</label>
            <input type="date" class="lc-schedule-datetime" id="lc-schedule-end-date">
          </div>
          <div class="lc-schedule-actions">
            <button class="lc-schedule-cancel" onclick="lcHideSchedulePopover()">Cancel</button>
            <button class="lc-schedule-confirm" onclick="lcConfirmSchedule()">Schedule</button>
          </div>
        </div>
        <!-- Internal note mode toggle -->
        <button class="lc-note-btn" id="lc-note-btn" onclick="lcToggleNoteMode()" title="Internal note (staff only)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0110 0v4"></path>
          </svg>
        </button>
        <button class="lc-send-btn" id="lc-send-btn" onclick="lcSendReply()" title="Send">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
          </svg>
        </button>
      </div>
      <!-- Translation preview: shown below typing box when translate mode + target language selected -->
      <div class="lc-translate-preview" id="lc-translate-preview" style="display:none;">
        <div class="lc-translate-preview-label"><span id="lc-translate-preview-lang"></span>:</div>
        <div class="lc-translate-preview-text" id="lc-translate-preview-text"></div>
        <div class="lc-translate-preview-hint"><kbd>Enter</kbd> send translation ¬∑ <kbd>Ctrl</kbd>+<kbd>Enter</kbd> send
          original</div>
      </div>
    </div>
  </div>

  <!-- Contact Details Panel (slides from right) -->
  <div class="lc-contact-panel" id="lc-contact-panel" style="display:none;">
    <div class="lc-contact-header">
      <span class="lc-contact-title">Contact Details</span>
      <button class="lc-contact-close" onclick="lcToggleContactPanel()" title="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="lc-contact-body">
      <!-- Profile section -->
      <div class="lc-contact-profile">
        <div class="lc-contact-avatar" id="lc-contact-avatar">?</div>
        <div class="lc-contact-phone" id="lc-contact-phone-display">+60...</div>
      </div>

      <div class="lc-field-divider"></div>

      <!-- Fields -->
      <div class="lc-field">
        <label class="lc-field-label">Name</label>
        <input type="text" class="lc-field-input" id="lc-cd-name" placeholder="Guest name"
          oninput="lcContactFieldChanged()">
      </div>

      <div class="lc-field">
        <label class="lc-field-label">Email</label>
        <input type="email" class="lc-field-input" id="lc-cd-email" placeholder="guest@email.com"
          oninput="lcContactFieldChanged()">
      </div>

      <div class="lc-field-row">
        <div class="lc-field">
          <label class="lc-field-label">Country</label>
          <select class="lc-field-select" id="lc-cd-country" onchange="lcContactFieldChanged()">
            <option value="">--</option>
            <option value="MY">MY</option>
            <option value="SG">SG</option>
            <option value="ID">ID</option>
            <option value="CN">CN</option>
            <option value="TW">TW</option>
            <option value="HK">HK</option>
            <option value="JP">JP</option>
            <option value="KR">KR</option>
            <option value="TH">TH</option>
            <option value="VN">VN</option>
            <option value="PH">PH</option>
            <option value="IN">IN</option>
            <option value="AU">AU</option>
            <option value="GB">GB</option>
            <option value="US">US</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        <div class="lc-field">
          <label class="lc-field-label">Language
            <button type="button" class="lc-lang-lock-btn" id="lc-cd-language-lock" onclick="lcToggleLanguageLock()" title="Language unlocked">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 019.9-1"/></svg>
            </button>
          </label>
          <select class="lc-field-select" id="lc-cd-language" onchange="lcContactFieldChanged()">
            <option value="">--</option>
            <option value="en">English</option>
            <option value="ms">Malay</option>
            <option value="zh">Chinese</option>
            <option value="id">Indonesian</option>
            <option value="th">Thai</option>
            <option value="vi">Vietnamese</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
          </select>
        </div>
      </div>

      <div class="lc-field-divider"></div>

      <div class="lc-field-row">
        <div class="lc-field">
          <label class="lc-field-label">Check-in</label>
          <input type="date" class="lc-field-input" id="lc-cd-checkin" onchange="lcContactFieldChanged()">
        </div>
        <div class="lc-field">
          <label class="lc-field-label">Check-out</label>
          <input type="date" class="lc-field-input" id="lc-cd-checkout" onchange="lcContactFieldChanged()">
        </div>
      </div>

      <div class="lc-field" style="position: relative;">
        <label class="lc-field-label">Unit / Capsule</label>
        <input type="text" class="lc-field-input" id="lc-cd-unit" placeholder="e.g. C1, C2..."
          oninput="lcContactFieldChanged(); lcUnitInput()" onfocus="lcUnitInput()"
          onkeydown="lcUnitKeydown(event)"
          onblur="lcUnitBlur()"
          autocomplete="off">
        <div class="lc-tag-dropdown" id="lc-unit-dropdown" style="display:none;"></div>
      </div>

      <div class="lc-field-divider"></div>

      <div class="lc-field-row">
        <div class="lc-field">
          <label class="lc-field-label">Contact Status</label>
          <select class="lc-field-select" id="lc-cd-contact-status" onchange="lcContactFieldChanged()">
            <option value="">--</option>
            <option value="new_lead">New Lead</option>
            <option value="Inquiring">Inquiring</option>
            <option value="Booked">Booked</option>
            <option value="active">Active</option>
            <option value="Checked In">Checked In</option>
            <option value="Checked Out">Checked Out</option>
            <option value="refunded">Refunded</option>
            <option value="blocked">Blocked</option>
          </select>
        </div>
        <div class="lc-field">
          <label class="lc-field-label">Payment</label>
          <select class="lc-field-select" id="lc-cd-payment-status" onchange="lcContactFieldChanged()">
            <option value="">--</option>
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="partial">Partial</option>
            <option value="refunded">Refunded</option>
          </select>
        </div>
      </div>

      <!-- Payment Reminder (US-022) -->
      <div class="lc-field lc-payment-reminder-section" id="lc-payment-reminder-section">
        <label class="lc-field-label">Payment Reminder</label>
        <div class="lc-payment-reminder-active" id="lc-payment-reminder-active" style="display:none;">
          <div class="lc-payment-reminder-info">
            <span class="lc-payment-reminder-due" id="lc-payment-reminder-due">Due: --</span>
            <span class="lc-payment-reminder-auto" id="lc-payment-reminder-auto"></span>
          </div>
          <div class="lc-payment-reminder-actions">
            <button type="button" class="lc-sched-edit-btn" onclick="lcSnoozeReminder()" title="Snooze 3 days">Snooze</button>
            <button type="button" class="lc-sched-cancel-btn" onclick="lcDismissReminder()" title="Dismiss">Dismiss</button>
          </div>
        </div>
        <div class="lc-payment-reminder-new" id="lc-payment-reminder-new">
          <div class="lc-field-row" style="align-items:flex-end;gap:6px;">
            <div style="flex:1;">
              <input type="date" class="lc-field-input" id="lc-payment-due-date" title="Reminder due date">
            </div>
            <label class="lc-payment-autosend-label" title="Auto-send chase message on due date">
              <input type="checkbox" id="lc-payment-autosend"> Auto
            </label>
            <button type="button" class="lc-schedule-confirm" style="padding:5px 10px;font-size:12px;" onclick="lcSetPaymentReminder()" title="Set reminder">Set</button>
          </div>
        </div>
      </div>

      <div class="lc-field-divider"></div>

      <!-- Tags (US-008: with global tag autocomplete) -->
      <div class="lc-field" style="position: relative;">
        <label class="lc-field-label">Tags</label>
        <div class="lc-tag-container" id="lc-cd-tags"></div>
        <input type="text" class="lc-field-input lc-tag-input" id="lc-cd-tag-input" placeholder="Add tag + Enter"
          onkeydown="lcTagKeydown(event)" oninput="lcTagInput()" onfocus="lcTagInput()"
          autocomplete="off">
        <div class="lc-tag-dropdown" id="lc-tag-dropdown" style="display:none;"></div>
      </div>

      <!-- Custom Fields (dynamic, from contact_field_definitions) -->
      <div class="lc-field" id="lc-custom-fields-section" style="display:none;">
        <label class="lc-field-label" style="display:flex;align-items:center;gap:6px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83"/><circle cx="12" cy="12" r="3"/></svg>
          Custom Fields
        </label>
        <div id="lc-custom-fields-container"></div>
      </div>

      <div class="lc-field-divider" id="lc-custom-fields-divider" style="display:none;"></div>

      <!-- Notes (US-090) -->
      <div class="lc-field">
        <label class="lc-field-label">Notes
          <button type="button" class="lc-ai-gen-btn" id="lc-cd-generate-notes" onclick="lcGenerateAINotes()" title="Generate notes from conversation using AI">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/><circle cx="12" cy="12" r="3"/></svg>
            <span>Generate by AI</span>
          </button>
        </label>
        <textarea class="lc-field-textarea" id="lc-cd-notes" placeholder="Internal notes about this guest..." rows="5"
          oninput="lcContactFieldChanged()"></textarea>
      </div>

      <div class="lc-field-divider"></div>

      <!-- Add to Context (US-091) -->
      <div class="lc-field">
        <button type="button" class="lc-context-btn" onclick="lcOpenGuestContext()" title="Add/edit guest context file for AI reference">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/><path d="M14 2v6h6"/><path d="M12 18v-6"/><path d="M9 15h6"/></svg>
          <span>Add to Context</span>
        </button>
        <p class="lc-context-filepath" id="lc-context-filepath" style="display:none;" onclick="lcOpenGuestContext()" title="Click to edit context file"></p>
      </div>
    </div>

    <!-- Save indicator -->
    <div class="lc-contact-footer">
      <span class="lc-contact-save-indicator" id="lc-contact-save-indicator"></span>
    </div>
  </div>
</div>

<!-- Guest Context Editor Modal (US-091) -->
<div id="lc-context-modal" class="lc-modal-overlay" style="display:none;"
  onclick="if(event.target===this) lcCloseContextModal()">
  <div class="lc-modal-content lc-context-modal">
    <div class="lc-modal-title">Guest Context File</div>
    <p class="lc-modal-subtitle" id="lc-context-filename"></p>
    <textarea id="lc-context-editor" class="lc-context-editor" rows="12" placeholder="Loading..."></textarea>
    <div class="lc-modal-buttons">
      <button class="lc-modal-btn lc-modal-btn-cancel" onclick="lcCloseContextModal()">Cancel</button>
      <button class="lc-modal-btn lc-modal-btn-send" onclick="lcSaveGuestContext()">Save Context</button>
    </div>
  </div>
</div>

<!-- Forward message modal: pick conversation -->
<div id="lc-forward-modal" class="lc-modal-overlay" style="display:none;"
  onclick="if(event.target===this) lcCloseForwardModal()">
  <div class="lc-modal-content lc-forward-modal">
    <div class="lc-modal-title">Forward to</div>
    <div class="lc-forward-list" id="lc-forward-list"></div>
    <div class="lc-modal-buttons">
      <button class="lc-modal-btn lc-modal-btn-cancel" onclick="lcCloseForwardModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Scheduled Messages Panel (US-020) -->
<div id="lc-scheduled-panel" class="lc-modal-overlay" style="display:none;"
  onclick="if(event.target===this) lcCloseScheduledPanel()">
  <div class="lc-modal-content lc-scheduled-modal">
    <div class="lc-modal-title">Scheduled Messages</div>
    <div class="lc-scheduled-list" id="lc-scheduled-list">
      <div class="lc-scheduled-empty">No scheduled messages</div>
    </div>
    <div class="lc-modal-buttons">
      <button class="lc-modal-btn lc-modal-btn-cancel" onclick="lcCloseScheduledPanel()">Close</button>
    </div>
  </div>
</div>

<!-- Translation Confirmation Modal -->
<div id="lc-translate-modal" class="lc-modal-overlay" style="display:none;"
  onclick="if(event.target===this) lcCloseTranslateModal()">
  <div class="lc-modal-content">
    <div class="lc-modal-title">Confirm Translation</div>
    <div style="margin-bottom:12px;">
      <div class="text-xs text-neutral-500 font-medium mb-1">Original:</div>
      <div class="lc-modal-text" id="lc-translate-original"></div>
    </div>
    <div style="margin-bottom:16px;">
      <div class="text-xs text-neutral-500 font-medium mb-1">Translated (<span id="lc-translate-lang-label"></span>):
      </div>
      <div class="lc-modal-text" id="lc-translate-translated"></div>
    </div>
    <div class="lc-modal-buttons">
      <button class="lc-modal-btn lc-modal-btn-cancel" onclick="lcCloseTranslateModal()">Cancel</button>
      <button class="lc-modal-btn lc-modal-btn-send" onclick="lcConfirmTranslation()">Send Translation</button>
    </div>
  </div>
</div>

<!-- US-009/010: Prisma AI Floating Panel -->
<div id="prisma-panel" class="prisma-panel" style="display:none;">
  <div class="prisma-header" id="prisma-header">
    <div class="prisma-title">‚ú¶ Prisma AI</div>
    <div class="prisma-header-actions">
      <button class="prisma-btn-icon" onclick="lcMinimisePrisma()" title="Minimise">‚Äî</button>
      <button class="prisma-btn-icon" onclick="lcClosePrismaWindow()" title="Close">‚úï</button>
    </div>
  </div>
  <div class="prisma-sources">
    <button class="prisma-source-chip active" data-source="knowledge_base" onclick="lcPrismaSetSource('knowledge_base')">Knowledge Base</button>
    <button class="prisma-source-chip" data-source="mcp_server" onclick="lcPrismaSetSource('mcp_server')">MCP Server</button>
    <button class="prisma-source-chip" data-source="all_history" onclick="lcPrismaSetSource('all_history')">All History</button>
    <button class="prisma-source-chip" data-source="internet" onclick="lcPrismaSetSource('internet')">Internet</button>
  </div>
  <div class="prisma-messages" id="prisma-messages">
    <div class="prisma-welcome">Ask me anything about the hostel, guests, or bookings.</div>
  </div>
  <div class="prisma-input-area">
    <textarea class="prisma-input" id="prisma-input" rows="1" placeholder="Ask Prisma..." onkeydown="lcPrismaKeydown(event)" oninput="lcPrismaAutoResize(this)"></textarea>
    <button class="prisma-send-btn" onclick="lcPrismaSend()" title="Send">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>
<button id="prisma-fab" class="prisma-fab" onclick="lcOpenPrismaWindow()" style="display:none;" title="Ask Prisma AI">
  ‚ú¶ Prisma
</button>