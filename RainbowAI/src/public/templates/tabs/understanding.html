<div class="mb-4">
  <h2 class="text-xl font-bold text-neutral-800">Understanding</h2>
  <p class="text-sm text-neutral-500 mt-1">Configure how Rainbow understands guest messages using 4 layers of
    intelligence.</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
  <div class="bg-white border rounded-2xl p-4">
    <div class="text-sm text-neutral-500 mb-1">Total Intents</div>
    <div id="im-stat-intents" class="text-2xl font-bold text-neutral-800">-</div>
  </div>
  <div class="bg-white border rounded-2xl p-4">
    <div class="text-sm text-neutral-500 mb-1">Total Keywords</div>
    <div id="im-stat-keywords" class="text-2xl font-bold text-primary-600">-</div>
  </div>
  <div class="bg-white border rounded-2xl p-4">
    <div class="text-sm text-neutral-500 mb-1">Total Examples</div>
    <div id="im-stat-examples" class="text-2xl font-bold text-success-600">-</div>
  </div>
  <div class="bg-white border rounded-2xl p-4">
    <div class="text-sm text-neutral-500 mb-1">System</div>
    <div class="text-xs font-mono text-neutral-600">Fuzzy + Semantic + LLM</div>
  </div>
</div>

<!-- Quick Setup (Configuration Templates) -->
<div class="dashboard-template-card">
  <div class="dashboard-template-header">
    <div>
      <h3 class="dashboard-template-title">‚ö° Quick Setup</h3>
      <p class="dashboard-template-subtitle">Pre-optimized configurations for different use cases. Based on industry
        research.</p>
    </div>
    <button type="button" onclick="toggleTemplateHelp()"
      class="dashboard-template-guide inline-flex items-center gap-1">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Template Guide
    </button>
  </div>

  <!-- Template Help (Hidden by default) -->
  <div id="template-help" class="hidden bg-neutral-50 rounded-xl p-4 mb-4 text-sm">
    <div class="font-semibold text-neutral-700 mb-2">üìñ Template Selection Guide</div>
    <p class="text-neutral-600 text-xs mb-2">Each template sets <strong>tier thresholds</strong>, <strong>conversation
        context</strong>, and the <strong>T4 LLM model</strong> (AI Fallback). Applying a template updates Understanding
      tiers and the default intent-classification model in one click.</p>
    <div class="space-y-1 text-neutral-600 text-xs">
      <div><strong>T1 Maximum Quality:</strong> Best accuracy (95-98%), slowest (2-5s), highest cost. Uses Groq Llama
        70B. For premium service.</div>
      <div><strong>T2 High Performance:</strong> Fastest (0.5-1s), lowest cost, good accuracy (88-92%). Uses Groq Llama
        8B Instant. For high volume.</div>
      <div><strong>T3 Balanced:</strong> Default. Good balance (92-95%), moderate speed (1-2s). Uses Groq Llama 8B.
        Recommended.</div>
      <div><strong>T4 Smart-Fast:</strong> Optimized for WhatsApp real-time chat (90-93%), fast (0.8-1.5s). Uses Groq
        Llama 8B.</div>
      <div><strong>T5 Tiered-Hybrid:</strong> Research-backed optimal (91-94%), cascading tiers, 95%+ early exit. Uses
        Groq Llama 8B.</div>
      <div><strong>T6 Emergency-Optimized:</strong> For 24/7 operations, security-critical. Uses Groq Llama 70B for
        reliability.</div>
      <div><strong>T7 Multi-Language:</strong> Chinese/Malay/English code-mixing (89-93%). Uses Ollama Gemini 3 Flash
        (CJK/slang).</div>
    </div>
  </div>

  <div class="dashboard-template-buttons" id="intent-template-buttons">
    <button type="button" onclick="applyIntentTemplate('t1-quality', event)" class="dashboard-template-btn"
      data-template-id="t1-quality">
      <span class="dashboard-template-btn-content"><span>T1 Maximum Quality</span><span
          class="text-neutral-500 font-normal text-xs">95-98% ¬∑ 2-5s ¬∑ Highest cost</span></span>
    </button>
    <button type="button" onclick="applyIntentTemplate('t2-performance', event)" class="dashboard-template-btn"
      data-template-id="t2-performance">
      <span class="dashboard-template-btn-content"><span>T2 High Performance</span><span
          class="text-neutral-500 font-normal text-xs">88-92% ¬∑ 0.5-1s ¬∑ Lowest cost</span></span>
    </button>
    <button type="button" onclick="applyIntentTemplate('t3-balanced', event)" class="dashboard-template-btn active"
      data-template-id="t3-balanced">
      <span class="dashboard-template-btn-content"><span>T3 Balanced ‚≠ê</span><span
          class="text-neutral-500 font-normal text-xs">92-95% ¬∑ 1-2s ¬∑ Default</span></span>
      <span class="btn-check">‚úì</span>
    </button>
    <button type="button" onclick="applyIntentTemplate('t4-smart-fast', event)" class="dashboard-template-btn"
      data-template-id="t4-smart-fast">
      <span class="dashboard-template-btn-content"><span>T4 Smart-Fast</span><span
          class="text-neutral-500 font-normal text-xs">90-93% ¬∑ 0.8-1.5s ¬∑ Optimized</span></span>
    </button>
    <button type="button" onclick="applyIntentTemplate('t5-tiered-hybrid', event)" class="dashboard-template-btn"
      data-template-id="t5-tiered-hybrid">
      <span class="dashboard-template-btn-content"><span>T5 Tiered-Hybrid üèÜ</span><span
          class="text-neutral-500 font-normal text-xs">91-94% ¬∑ 0.5-1.2s ¬∑ Research-backed</span></span>
    </button>
    <button type="button" onclick="applyIntentTemplate('t6-emergency', event)" class="dashboard-template-btn"
      data-template-id="t6-emergency">
      <span class="dashboard-template-btn-content"><span>T6 Emergency</span><span
          class="text-neutral-500 font-normal text-xs">90-95% ¬∑ 1.5-3s ¬∑ 24/7 ops</span></span>
    </button>
    <button type="button" onclick="applyIntentTemplate('t7-multilang', event)" class="dashboard-template-btn"
      data-template-id="t7-multilang">
      <span class="dashboard-template-btn-content"><span>T7 Multi-Language</span><span
          class="text-neutral-500 font-normal text-xs">89-93% ¬∑ 1.5-2.5s ¬∑ CJK focus</span></span>
    </button>
  </div>

  <div class="dashboard-template-footer">
    <span class="current-label">Current:</span>
    <span id="current-template-label" class="current-value">T3 Balanced</span>
    <span class="text-neutral-300">¬∑</span>
    <button type="button" onclick="saveCurrentAsCustom()" class="save-custom">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
      </svg>
      Save as Custom
    </button>
  </div>
</div>

<!-- Test Console -->
<div class="bg-white border rounded-2xl p-5 mb-4">
  <h3 class="font-semibold text-neutral-700 mb-3">üß™ Test Console</h3>
  <p class="text-sm text-neutral-500 mb-3">Test intent classification with instant results. Shows which source matched:
    <span class="font-mono text-xs">üö® Priority Keywords</span> (~0.1ms), <span class="font-mono text-xs">‚ö° Smart
      Matching</span> (~1ms), <span class="font-mono text-xs">üìö Learning Examples</span> (~50ms), or <span
      class="font-mono text-xs">ü§ñ AI Fallback</span> (fallback).
  </p>
  <div class="flex gap-2 mb-3">
    <input id="im-test-input" class="flex-1 border rounded-2xl px-3 py-2 text-sm"
      placeholder="e.g., 'wifi password', 'tq', 'how much is it'"
      onkeydown="if(event.key==='Enter')testIntentManager()" />
    <button onclick="testIntentManager()"
      class="text-sm bg-success-500 hover:bg-success-600 text-white px-4 py-2 rounded-2xl transition">Test</button>
  </div>
  <div id="im-test-result" class="hidden">
    <div class="bg-neutral-50 rounded-2xl p-4 text-sm space-y-2">
      <div class="flex gap-4">
        <span class="text-neutral-500 w-32">Intent:</span>
        <span id="im-test-intent" class="font-medium"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-32">Confidence:</span>
        <span id="im-test-confidence" class="font-medium"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-32">Source:</span>
        <span id="im-test-source" class="font-medium"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-32">Language:</span>
        <span id="im-test-language" class="font-medium"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-32">Matched:</span>
        <span id="im-test-matched" class="text-neutral-600"></span>
      </div>
    </div>
  </div>
</div>

<!-- T1: Priority Keywords (Emergency Patterns) -->
<div class="bg-white border rounded-2xl p-5 mb-4">
  <div class="flex items-center justify-between mb-3">
    <h3 role="button" tabindex="0"
      class="font-semibold text-neutral-700 group relative cursor-pointer hover:text-primary-600"
      onclick="toggleTier('t1')"
      onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleTier('t1'); }"
      aria-expanded="false" aria-controls="t1-content" aria-label="Expand or collapse Priority Keywords section">
      üö® Priority Keywords
      <span class="ml-1 text-xs text-neutral-400 cursor-help" onclick="event.stopPropagation()">‚ìò</span>
      <span
        class="invisible group-hover:visible absolute left-0 top-full mt-2 w-80 bg-neutral-800 text-white text-xs rounded-2xl p-3 z-50 shadow-strong">
        <strong>Priority Keywords:</strong> Lightning-fast pattern matching (~0.1ms) for critical emergency situations.
        <br><br>
        <strong>Perfect for:</strong> Emergency detection (fire, ambulance, theft), urgent issues that need immediate
        attention, and strict patterns that must trigger instantly without any delay.
        <br><br>
        <strong>Examples:</strong> "fire", "kebakaran", "ÁùÄÁÅ´" (fire), "theft", "ambulance", "emergency"
      </span>
    </h3>
    <div class="flex items-center gap-3">
      <button type="button" onclick="toggleTier('t1')" id="t1-toggle-btn"
        class="tier-disclosure-btn inline-flex items-center justify-center w-9 h-9 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-primary-50 transition-colors"
        aria-expanded="false" aria-controls="t1-content" aria-label="Expand section">
        <svg class="tier-chevron w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor"
          viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <label class="flex items-center gap-2 cursor-pointer">
        <span class="text-sm text-neutral-500">Enable</span>
        <input type="checkbox" id="tier1-enabled"
          class="tier-toggle w-10 h-6 bg-neutral-200 rounded-full relative appearance-none cursor-pointer checked:bg-primary-500 transition"
          checked />
      </label>
    </div>
  </div>

  <div id="t1-content" class="hidden space-y-3">
    <div class="text-sm text-neutral-500 mb-3">
      Add regex patterns for emergency detection. These patterns are checked first before any other tier.
    </div>

    <div class="border rounded-2xl p-4">
      <div class="text-xs font-semibold text-neutral-500 mb-2">EMERGENCY PATTERNS (by language)</div>
      <div id="im-regex-list" class="space-y-4 mb-3">
        <!-- Regex patterns grouped by language (en, ms, zh) -->
      </div>
      <div class="flex flex-wrap gap-2 items-end">
        <input id="im-regex-pattern" class="flex-1 min-w-0 border rounded-2xl px-3 py-2 text-sm font-mono"
          placeholder="/pattern/i (e.g., /\\b(fire)\\b/i)" />
        <input id="im-regex-description" class="flex-1 min-w-0 border rounded-2xl px-3 py-2 text-sm"
          placeholder="Description (e.g., Fire emergency)" />
        <select id="im-regex-language" class="border rounded-2xl px-3 py-2 text-sm bg-white w-28">
          <option value="en">English</option>
          <option value="ms">Malay</option>
          <option value="zh">Chinese</option>
        </select>
        <button onclick="addRegexPattern()"
          class="text-sm bg-danger-500 hover:bg-danger-600 text-white px-3 py-1.5 rounded-2xl">Add</button>
      </div>
      <div class="text-xs text-neutral-500 mt-2">
        ‚ö†Ô∏è Use regex syntax: <code class="bg-neutral-100 px-1">/pattern/flags</code>. Add one pattern per language (EN /
        MS / ZH).
      </div>

      <div class="mt-4 pt-4 border-t">
        <button onclick="saveRegexPatterns()"
          class="bg-danger-500 hover:bg-danger-600 text-white px-4 py-2 rounded-2xl text-sm">Save Patterns</button>
      </div>
    </div>
  </div>
</div>

<!-- T2: Smart Matching (Keywords Editor) -->
<div class="bg-white border rounded-2xl p-5 mb-4">
  <div class="flex items-center justify-between mb-3">
    <h3 role="button" tabindex="0"
      class="font-semibold text-neutral-700 group relative cursor-pointer hover:text-primary-600"
      onclick="toggleTier('t2')"
      onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleTier('t2'); }"
      aria-expanded="false" aria-controls="t2-content" aria-label="Expand or collapse Smart Matching section">
      üîç Smart Matching
      <span class="ml-1 text-xs text-neutral-400 cursor-help" onclick="event.stopPropagation()">‚ìò</span>
      <span
        class="invisible group-hover:visible absolute left-0 top-full mt-2 w-80 bg-neutral-800 text-white text-xs rounded-2xl p-3 z-50 shadow-strong">
        <strong>Smart Matching:</strong> Blazing-fast keyword matching with automatic typo tolerance (~1ms).
        Intelligently matches "wifi", "wfi", "WiFi", "wiifi" as the same word.
        <br><br>
        <strong>Perfect for:</strong> Direct keywords, common abbreviations (e.g., "tq" for thank you), and
        automatically handling spelling mistakes without manual effort.
        <br><br>
        <strong>Examples:</strong> "wifi", "password", "tq", "checkout", "refund"
      </span>
    </h3>
    <div class="flex items-center gap-3">
      <button type="button" onclick="toggleTier('t2')" id="t2-toggle-btn"
        class="tier-disclosure-btn inline-flex items-center justify-center w-9 h-9 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-primary-50 transition-colors"
        aria-expanded="false" aria-controls="t2-content" aria-label="Expand section">
        <svg class="tier-chevron w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor"
          viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <label class="flex items-center gap-2 cursor-pointer">
        <span class="text-sm text-neutral-500">Enable</span>
        <input type="checkbox" id="tier2-enabled"
          class="tier-toggle w-10 h-6 bg-neutral-200 rounded-full relative appearance-none cursor-pointer checked:bg-primary-500 transition"
          checked />
      </label>
      <div class="flex gap-2">
        <button onclick="exportIntentData('json')"
          class="text-xs bg-neutral-500 hover:bg-neutral-600 text-white px-3 py-1.5 rounded-2xl transition">Export
          JSON</button>
        <button onclick="exportIntentData('csv')"
          class="text-xs bg-neutral-500 hover:bg-neutral-600 text-white px-3 py-1.5 rounded-2xl transition">Export
          CSV</button>
      </div>
    </div>
  </div>

  <div id="t2-content" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4">
    <!-- Intent List -->
    <div class="border rounded-2xl p-3 overflow-y-auto max-h-96">
      <div class="text-xs font-semibold text-neutral-500 mb-2">SELECT INTENT</div>
      <div id="im-intent-list" class="space-y-1">Loading...</div>
    </div>

    <!-- Keyword Editor -->
    <div class="md:col-span-3 border rounded-2xl p-4">
      <div id="im-keyword-editor" class="hidden">
        <div class="mb-3">
          <div class="text-sm font-semibold text-neutral-700 mb-2">Editing: <span id="im-current-intent"
              class="text-primary-600"></span></div>

          <!-- T2 Threshold Override -->
          <div class="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-4">
            <div class="flex items-center justify-between mb-2">
              <label class="text-xs font-medium text-neutral-700">T2 Fuzzy Threshold Override (Optional)</label>
              <button id="im-t2-reset-btn" onclick="resetTierThreshold('t2')"
                class="text-xs text-primary-600 hover:text-primary-700 font-medium hidden">Reset to Default</button>
            </div>
            <div class="flex items-center gap-3">
              <input id="im-t2-threshold" type="number" step="0.05" min="0" max="1" placeholder="Use default (0.80)"
                class="flex-1 border rounded-lg px-3 py-1.5 text-sm"
                onchange="handleTierThresholdChange('t2', this.value)" />
              <span class="text-xs text-neutral-500" id="im-t2-status">Using default: 0.80</span>
            </div>
            <div class="text-xs text-neutral-500 mt-2">
              Leave empty to use global T2 Fuzzy threshold (0.80). Override only if this intent needs stricter/looser
              fuzzy matching.
            </div>
          </div>

          <!-- Keywords Grid (En, Ms, Zh side-by-side) -->
          <div class="grid grid-cols-3 gap-4">
            <div id="im-keywords-en" class="im-keywords-lang">
              <div class="text-xs text-neutral-500 mb-2">EN Keywords (<span id="im-count-en">0</span>)</div>
              <div id="im-keyword-list-en" class="flex flex-wrap gap-2 mb-3"><!-- keywords here --></div>
              <div class="flex gap-2">
                <input id="im-keyword-input-en" class="flex-1 border rounded-2xl px-3 py-2 text-sm"
                  placeholder="Add keyword..." onkeydown="if(event.key==='Enter')addKeyword('en')" />
                <button onclick="addKeyword('en')"
                  class="text-sm bg-primary-500 hover:bg-primary-600 text-white px-3 py-1.5 rounded-2xl">Add</button>
              </div>
            </div>

            <div id="im-keywords-ms" class="im-keywords-lang">
              <div class="text-xs text-neutral-500 mb-2">MS Keywords (<span id="im-count-ms">0</span>)</div>
              <div id="im-keyword-list-ms" class="flex flex-wrap gap-2 mb-3"><!-- keywords here --></div>
              <div class="flex gap-2">
                <input id="im-keyword-input-ms" class="flex-1 border rounded-2xl px-3 py-2 text-sm"
                  placeholder="Add keyword..." onkeydown="if(event.key==='Enter')addKeyword('ms')" />
                <button onclick="addKeyword('ms')"
                  class="text-sm bg-primary-500 hover:bg-primary-600 text-white px-3 py-1.5 rounded-2xl">Add</button>
              </div>
            </div>

            <div id="im-keywords-zh" class="im-keywords-lang">
              <div class="text-xs text-neutral-500 mb-2">ZH Keywords (<span id="im-count-zh">0</span>)</div>
              <div id="im-keyword-list-zh" class="flex flex-wrap gap-2 mb-3"><!-- keywords here --></div>
              <div class="flex gap-2">
                <input id="im-keyword-input-zh" class="flex-1 border rounded-2xl px-3 py-2 text-sm"
                  placeholder="Add keyword..." onkeydown="if(event.key==='Enter')addKeyword('zh')" />
                <button onclick="addKeyword('zh')"
                  class="text-sm bg-primary-500 hover:bg-primary-600 text-white px-3 py-1.5 rounded-2xl">Add</button>
              </div>
            </div>
          </div>

          <div class="mt-4 pt-4 border-t">
            <button onclick="saveKeywords()"
              class="bg-success-500 hover:bg-success-600 text-white px-4 py-2 rounded-2xl text-sm">Save
              Keywords</button>
          </div>
        </div>
      </div>
      <div id="im-keyword-empty" class="text-center text-neutral-400 py-8">
        ‚Üê Select an intent to edit keywords
      </div>
    </div>
  </div>
</div>

<!-- T3: Learning Examples (Training Examples Editor) -->
<div class="bg-white border rounded-2xl p-5 mb-4">
  <div class="flex items-center justify-between mb-3">
    <h3 role="button" tabindex="0"
      class="font-semibold text-neutral-700 group relative cursor-pointer hover:text-primary-600"
      onclick="toggleTier('t3')"
      onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleTier('t3'); }"
      aria-expanded="false" aria-controls="t3-content" aria-label="Expand or collapse Learning Examples section">
      üìö Learning Examples
      <span class="ml-1 text-xs text-neutral-400 cursor-help" onclick="event.stopPropagation()">‚ìò</span>
      <span
        class="invisible group-hover:visible absolute left-0 top-full mt-2 w-80 bg-neutral-800 text-white text-xs rounded-2xl p-3 z-50 shadow-strong">
        <strong>Learning Examples:</strong> AI-powered understanding that grasps meaning, not just words (~50ms).
        Intelligently recognizes that "what's the cost", "how much", and "tell me the price" all mean the same thing.
        <br><br>
        <strong>Perfect for:</strong> Multiple ways of asking the same question, understanding synonyms and paraphrases,
        and handling natural conversational language variations.
        <br><br>
        <strong>Examples:</strong> "How much is a bed?" ‚âà "What's the price?" ‚âà "Cost per night?"
      </span>
    </h3>
    <div class="flex items-center gap-3">
      <button type="button" onclick="toggleTier('t3')" id="t3-toggle-btn"
        class="tier-disclosure-btn inline-flex items-center justify-center w-9 h-9 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-primary-50 transition-colors"
        aria-expanded="false" aria-controls="t3-content" aria-label="Expand section">
        <svg class="tier-chevron w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor"
          viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <label class="flex items-center gap-2 cursor-pointer">
        <span class="text-sm text-neutral-500">Enable</span>
        <input type="checkbox" id="tier3-enabled"
          class="tier-toggle w-10 h-6 bg-neutral-200 rounded-full relative appearance-none cursor-pointer checked:bg-primary-500 transition"
          checked />
      </label>
    </div>
  </div>

  <div id="t3-content" class="hidden">
    <p class="text-sm text-neutral-500 mb-3">Add example phrases for semantic similarity matching. Server restart
      required after changes.</p>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Intent List -->
      <div class="border rounded-2xl p-3 overflow-y-auto max-h-96">
        <div class="text-xs font-semibold text-neutral-500 mb-2">SELECT INTENT</div>
        <div id="im-example-intent-list" class="space-y-1">Loading...</div>
      </div>

      <!-- Examples Editor -->
      <div class="md:col-span-3 border rounded-2xl p-4">
        <div id="im-examples-editor" class="hidden">
          <div class="mb-3">
            <div class="text-sm font-semibold text-neutral-700 mb-3">Training Examples for: <span
                id="im-current-example-intent" class="text-success-600"></span></div>

            <!-- T3 Threshold Override -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 mb-4">
              <div class="flex items-center justify-between mb-2">
                <label class="text-xs font-medium text-neutral-700">T3 Semantic Threshold Override (Optional)</label>
                <button id="im-t3-reset-btn" onclick="resetTierThreshold('t3')"
                  class="text-xs text-primary-600 hover:text-primary-700 font-medium hidden">Reset to Default</button>
              </div>
              <div class="flex items-center gap-3">
                <input id="im-t3-threshold" type="number" step="0.05" min="0" max="1" placeholder="Use default (0.70)"
                  class="flex-1 border rounded-lg px-3 py-1.5 text-sm"
                  onchange="handleTierThresholdChange('t3', this.value)" />
                <span class="text-xs text-neutral-500" id="im-t3-status">Using default: 0.70</span>
              </div>
              <div class="text-xs text-neutral-500 mt-2">
                Leave empty to use global T3 Semantic threshold (0.70). Override only if this intent needs
                stricter/looser semantic matching.
              </div>
            </div>

            <div class="text-xs text-neutral-500 mb-2">Examples (<span id="im-example-count">0</span>)</div>
            <div id="im-example-list" class="flex flex-wrap gap-2 mb-3"><!-- examples here --></div>
            <div class="flex gap-2">
              <input id="im-example-input" class="flex-1 border rounded-2xl px-3 py-2 text-sm"
                placeholder="Add training example..." onkeydown="if(event.key==='Enter')addExample()" />
              <button onclick="addExample()"
                class="text-sm bg-success-500 hover:bg-success-600 text-white px-3 py-1.5 rounded-2xl">Add</button>
            </div>

            <div class="mt-4 pt-4 border-t">
              <button onclick="saveExamples()"
                class="bg-success-500 hover:bg-success-600 text-white px-4 py-2 rounded-2xl text-sm">Save
                Examples</button>
              <p class="text-xs text-warning-600 mt-2">‚ö†Ô∏è Server restart required to reload semantic matcher</p>
            </div>
          </div>
        </div>
        <div id="im-examples-empty" class="text-center text-neutral-400 py-8">
          ‚Üê Select an intent to edit examples
        </div>
      </div>
    </div>
  </div>
</div>

<!-- T4: AI Fallback (LLM Settings) -->
<div class="bg-white border rounded-2xl p-5">
  <div class="flex items-center justify-between mb-3">
    <h3 role="button" tabindex="0"
      class="font-semibold text-neutral-700 group relative cursor-pointer hover:text-primary-600"
      onclick="toggleTier('t4')"
      onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleTier('t4'); }"
      aria-expanded="false" aria-controls="t4-content" aria-label="Expand or collapse AI Fallback section">
      ü§ñ AI Fallback
      <span class="ml-1 text-xs text-neutral-400 cursor-help" onclick="event.stopPropagation()"
        title="Click for details">‚ìò</span>
      <span
        class="invisible group-hover:visible absolute left-0 top-full mt-2 w-96 bg-neutral-800 text-white text-xs rounded-2xl p-3 z-50 shadow-strong">
        <strong>AI Fallback:</strong> Full AI-powered classification for complex and unusual queries (~100-500ms).
        Activated automatically when simpler methods don't find a match.
        <br><br>
        <strong>Perfect for:</strong> Complex conversational questions, ambiguous or unusual intents, and intelligently
        handling unexpected edge cases that weren't anticipated in training.
        <br><br>
        <strong>Examples:</strong> "I think maybe there's water leaking from somewhere upstairs?", "Not sure if this is
        a problem but..."
        <br><br>
        <strong class="text-amber-300">‚ö†Ô∏è If you disable AI Fallback:</strong> All messages that don't match T1‚ÄìT3 will
        be classified as <strong>Others</strong> (system fallback intent). Others is in GENERAL_SUPPORT and
        <strong>cannot be deleted or turned off</strong>. Only disable if you understand this.
      </span>
    </h3>
    <div class="flex items-center gap-3">
      <button type="button" onclick="toggleTier('t4')" id="t4-toggle-btn"
        class="tier-disclosure-btn inline-flex items-center justify-center w-9 h-9 rounded-lg text-neutral-500 hover:text-primary-600 hover:bg-primary-50 transition-colors"
        aria-expanded="false" aria-controls="t4-content" aria-label="Expand section">
        <svg class="tier-chevron w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor"
          viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <label class="flex items-center gap-2 cursor-pointer">
        <span id="tier4-status-label" class="text-sm text-neutral-500">Enabled</span>
        <input type="checkbox" id="tier4-enabled"
          class="tier-toggle w-10 h-6 bg-neutral-200 rounded-full relative appearance-none cursor-pointer checked:bg-primary-500 transition"
          checked />
      </label>
    </div>
  </div>

  <div id="t4-content" class="hidden">
    <!-- US-011: Link to consolidated AI model settings -->
    <div class="mb-4 bg-blue-50 border border-blue-200 rounded-xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2 text-sm text-blue-700">
        <span>ü§ñ</span>
        <span>AI model provider list &amp; OCR model settings are managed in <strong>Settings ‚Üí AI Models</strong></span>
      </div>
      <a href="#" onclick="switchTab('settings');return false"
        class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition flex-shrink-0">
        Open Settings ‚Üí
      </a>
    </div>
    <p class="text-sm text-neutral-500 mb-4">Configure LLM behavior when regex, fuzzy, and semantic tiers don't match.
    </p>
    <div class="space-y-4">
      <!-- Confidence Thresholds -->
      <div class="border rounded-2xl p-4">
        <h4 class="text-sm font-semibold text-neutral-700 mb-3">Confidence Thresholds</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-xs text-neutral-500 mb-1">T2 Fuzzy Threshold</label>
            <input id="llm-threshold-fuzzy" type="number" step="0.05" min="0" max="1" value="0.80"
              class="w-full border rounded-2xl px-3 py-2 text-sm" />
            <div class="text-xs text-neutral-400 mt-1">Default: 0.80 (80%)</div>
          </div>
          <div>
            <label class="block text-xs text-neutral-500 mb-1">T3 Semantic Threshold</label>
            <input id="llm-threshold-semantic" type="number" step="0.05" min="0" max="1" value="0.70"
              class="w-full border rounded-2xl px-3 py-2 text-sm" />
            <div class="text-xs text-neutral-400 mt-1">Default: 0.70 (70%)</div>
          </div>
          <div>
            <label class="block text-xs text-neutral-500 mb-1">T4 LLM Threshold</label>
            <input id="llm-threshold-llm" type="number" step="0.05" min="0" max="1" value="0.60"
              class="w-full border rounded-2xl px-3 py-2 text-sm" />
            <div class="text-xs text-neutral-400 mt-1">Default: 0.60 (60%)</div>
          </div>
          <div>
            <label class="block text-xs text-neutral-500 mb-1">Layer 2 Response Quality Threshold</label>
            <input id="llm-threshold-layer2" type="number" step="0.05" min="0" max="1" value="0.80"
              class="w-full border rounded-2xl px-3 py-2 text-sm" />
            <div class="text-xs text-neutral-400 mt-1">Default: 0.80 - Triggers smartest LLM + 2x context if below</div>
          </div>
        </div>
      </div>

      <!-- T4 Provider Selection -->
      <div class="border rounded-2xl p-4">
        <!-- Header with Breadcrumb -->
        <div class="flex items-center justify-between mb-3">
          <div class="flex-1">
            <h4 class="text-sm font-semibold text-neutral-700 mb-1 flex items-center gap-2">
              T4 LLM Models (Fallback Order)
            </h4>
            <div class="flex items-center gap-1 text-xs text-neutral-400">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>Models configured in</span>
              <a href="#" onclick="switchTab('settings');scrollToProviders();return false"
                class="text-primary-500 hover:text-primary-600 underline font-medium">
                Settings ‚Üí AI Models
              </a>
            </div>
          </div>
          <button onclick="switchTab('settings');scrollToProviders();return false"
            class="text-xs bg-neutral-100 hover:bg-neutral-200 text-neutral-700 px-3 py-1.5 rounded-lg transition flex items-center gap-1">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
              </path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Manage Models
          </button>
        </div>

        <!-- Default model (single choice, like Settings) -->
        <div class="mb-4">
          <label class="block text-xs text-neutral-500 mb-1">Default model for intent detection</label>
          <select id="t4-default-provider" class="w-full border rounded-2xl px-3 py-2 text-sm bg-white"
            onchange="saveLLMSettings()" title="Save happens automatically when you change this">
            <option value="">Use master (Settings ‚Üí AI Models)</option>
            <!-- Options filled by JS from available providers -->
          </select>
          <p class="text-xs text-neutral-400 mt-1">Pick one model for T4 classification. Same style as Settings ‚Äî one
            default; optional fallback list below.</p>
        </div>

        <!-- Provider Status Summary -->
        <div id="t4-provider-status"
          class="bg-neutral-50 rounded-lg px-3 py-2 mb-3 text-xs text-neutral-600 flex items-center gap-2">
          <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span id="t4-provider-status-text">Loading model status...</span>
        </div>

        <p class="text-xs text-neutral-400 mb-3">Optional: add more models below as <strong>fallback order</strong>
          (used only when no default model is set above).</p>
        <div id="t4-providers-list" class="space-y-2 mb-4">
          <p class="text-sm text-neutral-400 italic">Loading models...</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-neutral-500 mb-1">Max Tokens</label>
            <input id="llm-max-tokens" type="number" value="500" class="w-full border rounded-2xl px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="block text-xs text-neutral-500 mb-1">Temperature</label>
            <input id="llm-temperature" type="number" step="0.1" min="0" max="2" value="0.3"
              class="w-full border rounded-2xl px-3 py-2 text-sm" />
            <div class="text-xs text-neutral-400 mt-1">Lower = more focused, Higher = more creative</div>
          </div>
        </div>
      </div>

      <!-- System Prompt -->
      <div class="border rounded-2xl p-4">
        <h4 class="text-sm font-semibold text-neutral-700 mb-3">Intent Classification System Prompt</h4>
        <textarea id="llm-system-prompt" rows="6" class="w-full border rounded-2xl px-3 py-2 text-sm"
          placeholder="Enter system prompt for intent classification..."></textarea>
        <div class="text-xs text-neutral-400 mt-1">
          This prompt guides the LLM on how to classify intents. Include available intent categories and classification
          rules.
        </div>
      </div>

      <!-- Fallback Behavior -->
      <div class="border rounded-2xl p-4">
        <h4 class="text-sm font-semibold text-neutral-700 mb-3 group relative inline-flex items-center">
          Fallback Behavior
          <span class="ml-1 text-xs text-neutral-400 cursor-help">‚ìò</span>
          <span
            class="invisible group-hover:visible absolute left-0 top-full mt-2 w-80 bg-neutral-800 text-white text-xs rounded-2xl p-3 z-50 shadow-strong">
            <strong>Fallback Behavior:</strong> Rules and actions Rainbow takes when intent classification doesn‚Äôt meet
            the confidence threshold or hits an error. Ensures safety nets so guests don‚Äôt get wrong or unhelpful
            replies.
          </span>
        </h4>
        <div class="space-y-3">
          <div>
            <label class="flex items-center gap-2">
              <input id="llm-fallback-unknown" type="checkbox" checked class="rounded" />
              <span class="text-sm"
                title="When intent confidence is below the system threshold, Rainbow classifies the message as &quot;unknown&quot; and triggers the response for unclassified queries, avoiding misinterpretation.">Return
                "unknown" intent if confidence is below threshold</span>
            </label>
          </div>
          <div>
            <label class="flex items-center gap-2">
              <input id="llm-log-failures" type="checkbox" checked class="rounded" />
              <span class="text-sm"
                title="Records when Rainbow fails to classify intent or confidence is too low. Use these logs to improve intent models and training data.">Log
                classification failures for analysis</span>
            </label>
          </div>
          <div>
            <label class="flex items-center gap-2">
              <input id="llm-enable-context" type="checkbox" checked class="rounded" />
              <span class="text-sm"
                title="When enabled, the LLM classification tier (T4/T5) uses the full conversation history, not just the last message, so it can handle follow-ups and multi-turn questions better.">Include
                conversation context in LLM classification</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Response Confidence Scoring -->
      <div class="border rounded-2xl p-4">
        <h4 class="text-sm font-semibold text-neutral-700 mb-3 flex items-center gap-2 group relative">
          üéØ Response Confidence Scoring
          <span class="text-xs font-normal text-neutral-400 cursor-help"
            title="Evaluates how confident the AI is in its generated reply (not just intent). Low confidence can trigger a disclaimer or escalation to staff.">(Hallucination
            Prevention)</span>
          <span class="ml-1 text-xs text-neutral-400 cursor-help">‚ìò</span>
          <span
            class="invisible group-hover:visible absolute left-0 top-full mt-2 w-80 bg-neutral-800 text-white text-xs rounded-2xl p-3 z-50 shadow-strong">
            <strong>Response Confidence Scoring:</strong> Checks how sure the AI is about its reply before sending. If
            confidence is low, Rainbow can add a disclaimer or hand the conversation to staff. This reduces
            &quot;hallucinations&quot; (plausible but wrong answers).
          </span>
        </h4>
        <p class="text-xs text-neutral-500 mb-4">
          When <span class="cursor-help border-b border-dotted border-neutral-400"
            title="The AI‚Äôs own estimate of how accurate and correct its reply is. High = more certain; low = uncertain.">LLM
            confidence</span> is low, automatically add <span
            class="cursor-help border-b border-dotted border-neutral-400"
            title="Short phrases added to the reply when confidence is low, e.g. ‚ÄúPlease confirm with staff if unsure.‚Äù">disclaimers</span>
          or <span class="cursor-help border-b border-dotted border-neutral-400"
            title="Forward the conversation to a human staff member when the AI is too uncertain or the query is sensitive.">escalate
            to staff</span>. Helps prevent sending wrong information to guests.
        </p>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-xs text-neutral-500 mb-1 cursor-help"
              title="If response confidence is below this number (e.g. 0.5), Rainbow will escalate to staff and add a disclaimer.">
              Very Low Confidence Threshold
              <span class="text-neutral-400">(&lt; value = escalate)</span>
            </label>
            <input id="llm-threshold-low-confidence" type="number" step="0.05" min="0" max="1" value="0.5"
              class="w-full border rounded-2xl px-3 py-2 text-sm" />
            <div class="text-xs text-neutral-400 mt-1 cursor-help"
              title="When confidence is below the very low threshold: hand off to staff and append a warning to the message.">
              Below this: escalate + add disclaimer</div>
          </div>
          <div>
            <label class="block text-xs text-neutral-500 mb-1 cursor-help"
              title="If response confidence is below this value but above the very low threshold, Rainbow adds a disclaimer only (no escalation).">
              Low Confidence Threshold
              <span class="text-neutral-400">(&lt; value = disclaimer)</span>
            </label>
            <input id="llm-threshold-medium-confidence" type="number" step="0.05" min="0" max="1" value="0.7"
              class="w-full border rounded-2xl px-3 py-2 text-sm" />
            <div class="text-xs text-neutral-400 mt-1 cursor-help"
              title="When confidence is below this threshold but not below 0.5: only add a disclaimer, no staff escalation.">
              Below this: add disclaimer only</div>
          </div>
        </div>

        <div class="bg-neutral-50 rounded-lg p-3">
          <p class="text-xs font-medium text-neutral-600 mb-2 cursor-help"
            title="The exact text shown to guests when confidence is low. Edit these in Static Replies (knowledge.json).">
            üìù Disclaimer Messages</p>
          <p class="text-xs text-neutral-500">
            Edit disclaimer messages in <button
              onclick="switchTab('static-replies');setTimeout(() => scrollToElement('static-warnings'), 300);"
              class="text-primary-500 hover:text-primary-600 underline font-medium"
              title="Pre-written responses in knowledge.json; disclaimer text is stored under keys confidence_very_low and confidence_low.">Static
              Replies</button> ‚Üí Search for:
          </p>
          <ul class="text-xs text-neutral-600 mt-1 ml-4 space-y-0.5">
            <li class="cursor-help" title="Static reply key for when confidence is below 0.5 (escalate + disclaimer).">‚Ä¢
              <code class="bg-white px-1 py-0.5 rounded text-xs">confidence_very_low</code> - For very low confidence
              (&lt;0.5)
            </li>
            <li class="cursor-help"
              title="Static reply key for when confidence is between 0.5 and 0.7 (disclaimer only).">‚Ä¢ <code
                class="bg-white px-1 py-0.5 rounded text-xs">confidence_low</code> - For low confidence (0.5-0.7)</li>
          </ul>
        </div>
      </div>

      <div class="pt-4 border-t">
        <button onclick="saveLLMSettings()"
          class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-2xl text-sm"
          title="Save Fallback Behavior and Response Confidence settings to llm-settings.json (atomic write).">Save LLM
          Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê HELP SECTION ‚Äî Intent Manager Guide (lazy-loaded from partial) ‚ïê‚ïê‚ïê -->
<div class="bg-gradient-to-br from-purple-50 to-blue-50 border-2 border-purple-200 rounded-2xl p-6 mt-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <span class="text-3xl">‚ùì</span>
      <div>
        <h2 class="text-xl font-bold text-neutral-800">Intent Manager - Quick Guide</h2>
        <p class="text-sm text-neutral-600">Master the 4-tier intent classification system</p>
      </div>
    </div>
    <button onclick="toggleHelp()" class="text-sm text-purple-600 hover:text-purple-700 font-medium flex items-center gap-1">
      <span id="help-toggle-icon">‚ñ∂</span>
      <span id="help-toggle-text">Expand Guide</span>
    </button>
  </div>
  <div id="intent-help-content" class="hidden space-y-6">
    <div class="text-center py-8 text-neutral-400">Loading guide...</div>
  </div>
</div>

<!-- Reset Configuration Button -->
<div class="mt-8 mb-8 text-center border-t border-neutral-200 pt-8">
  <button onclick="resetToDefaults()" class="text-sm text-neutral-500 hover:text-danger-600 transition underline">
    Reset to Defaults
  </button>
  <p class="text-xs text-neutral-400 mt-2">Restores the recommended configuration: only AI Fallback enabled.</p>
</div>