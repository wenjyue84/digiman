<div class="mb-4">
  <h2 class="text-xl font-bold text-neutral-800">Intents & Routing</h2>
  <p class="text-sm text-neutral-500 mt-1">Define intents the LLM classifies into, and control how each one is handled.
  </p>
</div>

<div class="bg-white border rounded-2xl p-5 mb-4">
  <h3 class="font-semibold text-neutral-700 mb-3">Architecture</h3>
  <div class="text-sm text-neutral-600 space-y-1">
    <p>1. <span class="font-mono text-danger-600">Emergency regex</span> â€” fire, stolen, assault â†’ instant staff
      escalation</p>
    <p>2. <span class="font-mono text-primary-600">LLM classifies intent</span> from the defined list below</p>
    <p>3. <span class="font-mono text-success-600">Routing rule</span> determines handling: static reply, LLM response,
      or workflow (booking, escalation, payment, etc.)</p>
  </div>
</div>

<!-- Test Classifier -->
<div class="bg-white border rounded-2xl p-5 mb-4">
  <h3 class="font-semibold text-neutral-700 mb-3">Test Classifier</h3>
  <p class="text-sm text-neutral-500 mb-3">Send a test message to see how Rainbow classifies it and which routing rule
    applies.</p>
  <div class="flex gap-2 mb-3">
    <input id="test-input" class="flex-1 border rounded-2xl px-3 py-2 text-sm"
      placeholder="Type a guest message, e.g. 'what's the wifi password?'"
      onkeydown="if(event.key==='Enter')testClassifier()" />
    <button onclick="testClassifier()"
      class="text-sm bg-success-500 hover:bg-success-600 text-white px-4 py-2 rounded-2xl transition">Test</button>
  </div>
  <div id="test-result" class="hidden">
    <div class="bg-neutral-50 rounded-2xl p-4 text-sm space-y-2">
      <div class="flex gap-4">
        <span class="text-neutral-500 w-24">Intent:</span>
        <span id="test-intent" class="font-medium"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-24">Language:</span>
        <span id="test-language" class="font-medium"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-24">Detection:</span>
        <span id="test-source" class="font-medium"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-24">Action:</span>
        <span id="test-action" class="font-mono text-primary-600"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-24">Routed To:</span>
        <span id="test-routed" class="font-mono text-success-700 font-medium"></span>
      </div>
      <div class="flex gap-4">
        <span class="text-neutral-500 w-24">Confidence:</span>
        <span id="test-confidence" class="font-medium"></span>
      </div>
      <div class="mt-2 pt-2 border-t">
        <span class="text-neutral-500 block mb-1">Response:</span>
        <div id="test-response" class="whitespace-pre-wrap text-neutral-800"></div>
      </div>
    </div>
  </div>
</div>

<!-- Routing Templates -->
<div class="dashboard-template-card">
  <div class="dashboard-template-header">
    <div>
      <h3 class="dashboard-template-title">Routing Templates</h3>
      <p class="dashboard-template-subtitle">Quickly switch all intent routing at once. One-click presets for Static,
        Workflow, and LLM mix.</p>
    </div>
    <div class="flex items-center gap-2 flex-shrink-0">
      <button type="button" onclick="showIntentsTemplateHelp()"
        class="dashboard-template-guide inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Template Guide
      </button>
      <button type="button" onclick="showSaveTemplateModal()"
        class="text-xs bg-success-500 hover:bg-success-600 text-white px-3 py-1.5 rounded-2xl transition">+ Save New
        Template</button>
    </div>
  </div>
  <div id="intents-template-help" class="hidden bg-neutral-50 rounded-xl p-4 mb-4 text-sm">
    <div class="font-semibold text-neutral-700 mb-2">ðŸ“– Routing Template Guide</div>
    <div class="space-y-1 text-neutral-600 text-xs">
      <div><strong>T1 Smartest:</strong> Maximum quality â€” Workflow for structured processes, LLM for everything else.
        Slowest, highest cost.</div>
      <div><strong>T2 Performance:</strong> Maximum speed â€” Static + Workflow + minimal LLM. Lowest cost.</div>
      <div><strong>T3 Balanced:</strong> Research-optimal mix of Static, Workflow, and LLM.</div>
      <div><strong>T4 Smart-Fast:</strong> Split-model: fast 8B classifies, 70B replies for LLM intents only.</div>
      <div><strong>T5 Tiered-Hybrid:</strong> Zero-LLM classification cascade (Regex â†’ Fuzzy â†’ Semantic â†’ LLM fallback).
        Best cost efficiency.</div>
    </div>
  </div>
  <div id="template-buttons-container" class="dashboard-template-buttons">
    <!-- Templates will be rendered here dynamically -->
  </div>
  <div class="dashboard-template-footer">
    <span class="current-label">Active:</span>
    <span id="intents-current-label" class="current-value font-semibold text-primary-600">Loading...</span>
    <span id="template-indicator" class="hidden text-xs text-neutral-500 ml-2"></span>
  </div>
</div>

<!-- Intent Table -->
<div class="bg-white border rounded-2xl p-5 mb-4">
  <div class="flex items-center justify-between mb-3">
    <h3 class="font-semibold text-neutral-700">Message Router</h3>
    <button onclick="showAddIntent()"
      class="text-xs bg-success-500 hover:bg-success-600 text-white px-3 py-1.5 rounded-2xl transition">+ Add
      Intent</button>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b text-left text-neutral-500">
          <th class="py-2 pr-3 font-medium" title="Intent: The category the AI assigns to a guest message (e.g. greeting, booking, late_checkout). Shown with its display name from intents.json.">
            <span class="intent-th-tooltip-trigger">
              Intent
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0; opacity:0.7"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="intent-th-tooltip"><strong>Intent.</strong> The category the AI assigns to a guest message (e.g. greeting, booking, complaint, late_checkout, check_in_arrival). Listed by phase; the second line is the display name from intents.json.</span>
            </span>
          </th>
          <th class="py-2 pr-3 font-medium" title="Enabled: Turn this intent on or off. Disabled intents are not matched, so messages may fall back to another intent or unknown.">
            <span class="intent-th-tooltip-trigger">
              Enabled
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0; opacity:0.7"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="intent-th-tooltip"><strong>Enabled.</strong> Whether this intent is active. Off = the classifier will not match messages to this intent; they may match another intent or fall back to &quot;unknown&quot;.</span>
            </span>
          </th>
          <th class="py-2 pr-3 font-medium" title="Routing: What happens when this intent is detected â€” Static Reply, LLM Reply, or a Workflow (e.g. booking, complaint).">
            <span class="intent-th-tooltip-trigger">
              Routing
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0; opacity:0.7"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="intent-th-tooltip"><strong>Routing.</strong> What happens when this intent is detected: <strong>Static Reply</strong> = pre-written text from the knowledge base; <strong>LLM Reply</strong> = AI-generated response; <strong>Workflow</strong> = multi-step process (e.g. booking, complaint, escalation).</span>
            </span>
          </th>
          <th class="py-2 pr-3 font-medium" title="Min Confidence: Minimum score (0â€“1) to accept this intent. Lower = easier to trigger; higher = stricter. Use lower for critical intents like theft.">
            <span class="intent-th-tooltip-trigger">
              Min Confidence
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0; opacity:0.7"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="intent-th-tooltip"><strong>Min Confidence.</strong> Minimum score (0â€“1) required to accept this intent. Lower = easier to trigger (good for safety-critical intents like theft). Higher = stricter matching (good for ambiguous intents). Editable in this cell.</span>
            </span>
          </th>
          <th class="py-2 pr-3 font-medium" title="Static Reply?: Whether a pre-written reply exists in the knowledge base. Warnings show if routing and availability don't match.">
            <span class="intent-th-tooltip-trigger">
              Static Reply?
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0; opacity:0.7"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="intent-th-tooltip"><strong>Static Reply?</strong> Whether a pre-written reply exists in the knowledge base for this intent. &quot;Yes&quot; = one is defined; warnings appear if routing is Static but no reply exists, or if a reply exists but routing is not Static.</span>
            </span>
          </th>
          <th class="py-2 pr-3 font-medium" title="Time-sensitive: When on, current date and time (Malaysia) are added to the LLM context for replies. Use for check-in/check-out related intents.">
            <span class="intent-th-tooltip-trigger">
              Time-sensitive
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0; opacity:0.7"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="intent-th-tooltip"><strong>Time-sensitive.</strong> When on, the current date and time (Malaysia) are injected into the LLM context when replying to this intent. Use for check-in/check-out related intents (e.g. early arrival, late checkout) so the AI can answer with accurate &quot;today&quot; or &quot;now&quot;.</span>
            </span>
          </th>
          <th class="py-2 font-medium" title="Actions: Delete removes this intent and its routing. Other settings (Enabled, Routing, Min Confidence, Time-sensitive) are edited in their columns.">
            <span class="intent-th-tooltip-trigger">
              Actions
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0; opacity:0.7"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="intent-th-tooltip"><strong>Actions.</strong> Delete removes this intent and its routing rule. Other settings (Enabled, Routing, Min Confidence, Time-sensitive) are edited directly in their columns.</span>
            </span>
          </th>
        </tr>
      </thead>
      <tbody id="intents-table-body"></tbody>
    </table>
  </div>
</div>

<!-- Add Intent Modal -->
<div id="add-intent-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
  <div class="bg-white rounded-2xl shadow-strong p-6 w-full max-w-lg mx-4">
    <h3 class="text-lg font-semibold mb-4">Add Intent</h3>
    <form onsubmit="submitAddIntent(event)">
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Category (snake_case)</label>
        <input id="add-i-category" class="w-full border rounded-2xl px-3 py-2 text-sm" required
          placeholder="e.g. breakfast_info" />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Routing Action</label>
        <select id="add-i-routing" class="w-full border rounded-2xl px-3 py-2 text-sm"
          onchange="onAddIntentRoutingChange(this.value)">
          <option value="llm_reply">LLM Reply</option>
          <option value="static_reply">Static Reply</option>
          <option value="workflow">Workflow</option>
        </select>
      </div>
      <div class="mb-3 hidden" id="add-i-workflow-picker">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Workflow</label>
        <select id="add-i-workflow-id" class="w-full border rounded-2xl px-3 py-2 text-sm"></select>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Regex Patterns (one per line, optional)</label>
        <textarea id="add-i-patterns" rows="3" class="w-full border rounded-2xl px-3 py-2 text-sm"
          placeholder="\\b(keyword)\\b"></textarea>
      </div>
      <div class="mb-3 flex items-center gap-2">
        <input type="checkbox" id="add-i-enabled" checked />
        <label for="add-i-enabled" class="text-sm text-neutral-700">Enabled</label>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeModal('add-intent-modal')"
          class="px-3 py-1.5 text-sm text-neutral-600 border rounded-2xl hover:bg-neutral-50">Cancel</button>
        <button type="submit"
          class="px-3 py-1.5 text-sm bg-primary-500 text-white rounded-2xl hover:bg-primary-600">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Save Template Modal -->
<div id="save-template-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
  <div class="bg-white rounded-2xl shadow-strong p-6 w-full max-w-lg mx-4">
    <h3 class="text-lg font-semibold mb-4">Save New Template</h3>
    <form onsubmit="submitSaveTemplate(event)">
      <div class="mb-3">
        <label class="block text-sm font-medium text-neutral-700 mb-1">Template Name</label>
        <input id="save-template-name" class="w-full border rounded-2xl px-3 py-2 text-sm" required
          placeholder="e.g., My Booking Setup" />
        <p class="text-xs text-neutral-400 mt-1">Give your template a descriptive name</p>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeModal('save-template-modal')"
          class="px-3 py-1.5 text-sm text-neutral-600 border rounded-2xl hover:bg-neutral-50">Cancel</button>
        <button type="submit"
          class="px-3 py-1.5 text-sm bg-success-500 text-white rounded-2xl hover:bg-success-600">Save Template</button>
      </div>
    </form>
  </div>
</div>