{
  "productName": "Rainbow AI â€” Test Failure Fixes (133-Scenario Suite)",
  "branchName": "feature/rainbow-test-fixes",
  "overview": "Fix all 15 failed tests discovered in the full 133-scenario autotest suite (restored from autotest-scenarios-single.js + autotest-scenarios-workflow.js). Failures span 5 categories: intent/KB misclassification (5), response keyword fragility (3), multi-turn workflow context loss (4), long conversation memory (1), and sentiment escalation (2). Run validation with: node RainbowAI/scripts/test-all-133.js --concurrency=2",
  "goals": [
    "Reduce failed tests from 15 to 0 on the full 133-scenario run",
    "Bring pass rate from 88.0% to >= 95%",
    "Fix root causes (not just widen keywords) where AI behaviour is broken",
    "Restore and maintain the complete 133-scenario suite as the canonical autotest file"
  ],
  "userStories": [
    {
      "id": "US-006",
      "title": "Fix billing dispute test keyword: 'investigation' vs 'investigate'",
      "priority": 1,
      "description": "As a developer, I want the billing dispute overcharge test keywords to match the actual AI response vocabulary, so that the test does not falsely fail due to noun/verb substring mismatch. The test expects 'investigation' but the response uses 'investigate'. String includes() check means 'investigation' is NOT found in 'investigate'.",
      "acceptanceCriteria": [
        "Test postcheckout-billing-dispute validation values updated to: ['investigate', 'investigation', 'refund', 'review', 'billing', 'overcharge']",
        "Same fix applied in RainbowAI/src/public/js/modules/autotest-scenarios-single.js",
        "Same fix applied in RainbowAI/src/public/js/data/autotest-scenarios.js (if present)",
        "Test passes 3 consecutive times in test-all-133.js",
        "TypeScript compiles with zero errors (cd RainbowAI && npx tsc --noEmit)"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/public/js/modules/autotest-scenarios-single.js â€” search for 'postcheckout-billing-dispute', update values array",
        "File: RainbowAI/src/public/js/data/autotest-scenarios.js â€” same fix if this scenario exists there",
        "The bug: 'investigation'.includes('investigate') = false (needle longer than haystack match point)",
        "No backend code changes needed â€” test-only fix"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Fix Extra Amenity Towel test â€” widen keywords for LLM fallback resilience",
      "priority": 2,
      "description": "As a developer, I want the towel amenity test to pass even when the LLM fallback returns a slightly different phrasing, so the test does not flake due to provider timeouts. The test expects 'deliver' or 'housekeeping' but a fallback LLM may say 'arrange' or 'bring' instead. The 10.3s response time in the failing run indicates a primary provider timeout triggered fallback.",
      "acceptanceCriteria": [
        "Test duringstay-extra-towel validation values widened to: ['deliver', 'housekeeping', 'arrange', 'bring', 'send', 'towel']",
        "Same fix in RainbowAI/src/public/js/modules/autotest-scenarios-single.js",
        "Same fix in RainbowAI/src/public/js/data/autotest-scenarios.js (if exists)",
        "Static reply KB entry for extra_amenity_request intent verified to contain 'housekeeping' AND 'deliver' in the English template",
        "Test duringstay-extra-towel passes in test-all-133.js",
        "Related test typo-towl ('can i have extra towl') still passes",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/public/js/modules/autotest-scenarios-single.js â€” update duringstay-extra-towel and typo-towl keyword arrays",
        "File: RainbowAI/src/assistant/data/knowledge.json â€” check extra_amenity_request static reply to ensure it includes housekeeping/deliver",
        "The 10.3s latency in the original run = primary AI provider timeout; the fallback gave valid but differently-worded response"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-001",
      "title": "Fix Noise Complaint intent â€” 'baby crying' misclassified as contact_staff",
      "priority": 3,
      "description": "As a guest reporting noise (crying baby), I want Rainbow AI to respond with empathy and offer help (relocate / send staff), so I feel heard and get practical assistance. Currently 'A baby has been crying all night' is classified as contact_staff and routed to the escalation workflow, which responds with boilerplate mentioning 'billing disputes' â€” no empathy keywords present.",
      "acceptanceCriteria": [
        "Message 'A baby has been crying all night' responds with at least one of: understand, sorry, relocate, room, quiet, staff",
        "Response does NOT mention 'billing disputes' for a noise complaint",
        "Intent classification for baby crying message is noise_complaint or complaint (not contact_staff)",
        "Test duringstay-noise-baby passes in test-all-133.js",
        "Multi-language: ms and zh variants contain equivalent empathy keywords",
        "Run node RainbowAI/scripts/test-all-133.js â€” overall pass rate >= 95%",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/data/intent-keywords.json â€” add 'baby crying', 'crying all night', 'baby', 'noise complaint' to noise_complaint or complaint intent keywords",
        "File: RainbowAI/src/assistant/data/routing.json â€” verify noise_complaint routes to llm_reply or static empathy response (NOT escalate workflow)",
        "File: RainbowAI/src/assistant/data/knowledge.json â€” check if noise_complaint static reply exists; it must contain 'sorry'/'understand' and NOT 'billing disputes'",
        "Optionally: update test validation keywords as safety net: add ['staff', 'assist', 'connect', 'contact', 'sorry'] as additional acceptable keywords"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Fix Malay slang pricing â€” 'nk tny harga' not recognized",
      "priority": 4,
      "description": "As a Malay-speaking guest using WhatsApp slang, I want Rainbow AI to understand 'nk tny harga capsule' (want to ask price of capsule) and respond with pricing information. Currently no RM/price/harga keyword is present in the response.",
      "acceptanceCriteria": [
        "Message 'nk tny harga capsule' returns a response containing at least one of: RM, harga, malam, price, night, rate",
        "T2 fuzzy matcher or intent keywords cover 'nk tny', 'tny', 'harga' as pricing signals",
        "Test slang-nk-tny-harga passes in test-all-133.js",
        "Related slang test slang-brp-harga ('brp harga satu mlm') still passes",
        "Test slang-bole-checkin ('bole check in skrg?') still passes",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/data/intent-keywords.json â€” add Malay slang under pricing_inquiry intent: 'nk tny harga', 'nk tanya harga', 'brp harga', 'berapa harga', 'harga capsule', 'harga bilik'",
        "File: RainbowAI/src/assistant/fuzzy-matcher.ts â€” check if Malay abbreviation normalisation exists (nk=nak, tny=tanya, brp=berapa); add if missing",
        "Alternative: add 'nk tny' directly to T2 keyword list without needing normalisation"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Fix Tourist Guide response â€” missing attraction names (LEGOLAND, Desaru)",
      "priority": 5,
      "description": "As a guest asking about tourist attractions, I want Rainbow AI to recommend specific local attractions like LEGOLAND and Desaru, so I get useful local travel guidance. Currently the response is missing all expected attraction references.",
      "acceptanceCriteria": [
        "Message 'Can you recommend some tourist spots nearby?' returns response containing at least one of: LEGOLAND, Desaru, Sultan, attractions, tourist",
        "KB file for tourist attractions is loaded and contains LEGOLAND and Desaru content",
        "guessTopicFiles() in knowledge-base.ts correctly maps tourist-intent messages to the tourist KB file",
        "Test duringstay-tourist passes in test-all-133.js",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/.rainbow-kb/ â€” list files to find the tourist attractions KB file. Verify it exists and contains 'LEGOLAND', 'Desaru', 'Sultan Ibrahim'",
        "File: RainbowAI/src/assistant/knowledge-base.ts â€” find guessTopicFiles() function, verify it has a regex/keyword that maps 'tourist', 'attraction', 'nearby', 'visit', 'sightseeing' to the tourist KB file",
        "If KB file is missing LEGOLAND/Desaru content, add them",
        "If guessTopicFiles() doesn't match tourist queries, add the mapping"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Fix Capsule Layout responses â€” lower deck queries missing even/odd info",
      "priority": 6,
      "description": "As a guest asking which capsules are lower deck, I want Rainbow AI to state the specific capsule numbers (even-numbered C2, C4, C6 = lower; odd C1, C3, C5 = upper), so I can choose my preferred bunk. Two tests fail: general capsule layout query and special-needs lower bunk request.",
      "acceptanceCriteria": [
        "Message 'Which capsule numbers are the lower deck?' returns response containing even OR lower OR C2 OR C4 OR C6",
        "Message 'I have a bad back, I need a lower deck capsule' returns response containing lower OR deck OR arrange OR staff",
        "Tests capsule-which-lower and ci-suite-special-needs both pass in test-all-133.js",
        "KB content explicitly states: even-numbered capsules (C2, C4, C6) are lower deck; odd-numbered (C1, C3, C5) are upper deck",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/.rainbow-kb/ â€” find capsule layout or facilities KB file. Update to explicitly state 'Even-numbered capsules (C2, C4, C6) are lower deck. Odd-numbered capsules (C1, C3, C5) are upper deck.'",
        "File: RainbowAI/src/assistant/knowledge-base.ts â€” verify guessTopicFiles() maps 'lower deck', 'capsule number', 'upper deck', 'bunk' queries to the capsule layout KB file",
        "File: RainbowAI/src/assistant/data/knowledge.json â€” check lower_deck_preference static reply; ensure it mentions even/C2/C4/C6"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-007",
      "title": "Fix Post-Checkout Complaint Service response â€” missing apology keywords",
      "priority": 7,
      "description": "As a guest who had a poor service experience, I want Rainbow AI to respond with a sincere apology and mention compensatory action (voucher or follow-up), so my complaint is taken seriously. Currently the response contains none of: sorry, apology, voucher.",
      "acceptanceCriteria": [
        "Message 'After checking out, I want to complain about poor service' returns response containing at least one of: sorry, apology, apologies, voucher, compensate, management, feedback",
        "Test postcheckout-service-complaint passes in test-all-133.js",
        "Multi-language: ms and zh variants contain equivalent apology/compensation language",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/data/routing.json â€” check what action post-checkout complaints route to",
        "File: RainbowAI/src/assistant/data/knowledge.json â€” find post-checkout complaint static reply; ensure it contains 'sorry', 'apologize', or 'apologies'",
        "File: RainbowAI/.rainbow-kb/ â€” if a separate post-checkout KB file exists, verify apology language is present",
        "This may need a new static reply entry if post-checkout complaint intent is missing from knowledge.json"
      ],
      "dependencies": [],
      "estimatedComplexity": "small",
      "passes": true
    },
    {
      "id": "US-015",
      "title": "Restore full 133-scenario suite as default autotest file",
      "priority": 8,
      "description": "As a developer, I want the canonical autotest-scenarios.js to contain all 133 scenarios (not just 56), so the 'Run All' button in the Chat Simulator covers the complete test suite. Currently the browser default file has only 56 scenarios; the other 77 exist only in separate module files.",
      "acceptanceCriteria": [
        "RainbowAI/src/public/js/data/autotest-scenarios.js contains all 133 scenarios as const AUTOTEST_SCENARIOS = [...]",
        "File uses browser-compatible format (no ES module export syntax)",
        "All 20 category comment blocks are present and correctly labelled",
        "node RainbowAI/scripts/test-autotest-optimized.js picks up and runs all 133 scenarios",
        "Run All button in Chat Simulator at http://localhost:3002/#chat-simulator runs all 133 scenarios",
        "RainbowAI/dist/public/js/data/autotest-scenarios.js also updated (copy to dist)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "Source 1: RainbowAI/src/public/js/modules/autotest-scenarios-single.js â€” exports SINGLE_TURN_SCENARIOS (112 scenarios)",
        "Source 2: RainbowAI/src/public/js/modules/autotest-scenarios-workflow.js â€” exports WORKFLOW_SCENARIOS (21 scenarios)",
        "Target: RainbowAI/src/public/js/data/autotest-scenarios.js â€” must use: const AUTOTEST_SCENARIOS = [...singleTurnScenarios, ...workflowScenarios]; (browser-compatible, no export)",
        "The test-all-133.js runner uses the module files directly (that is fine, keep it); the autotest-optimized.js uses autotest-scenarios.js",
        "After merging: verify file size is roughly 3000+ lines",
        "Also update RainbowAI/dist/public/js/data/autotest-scenarios.js to match (copy the file)"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-013",
      "title": "Fix long conversation memory â€” remember guest name after 11+ turns",
      "priority": 9,
      "description": "As a guest who provided my name early in a long conversation, I want Rainbow AI to remember my name even after 11+ messages trigger conversation summarisation, so I feel acknowledged throughout the stay. Currently the summarisation discards named entities like the guest's name.",
      "acceptanceCriteria": [
        "After 'My name is John' at turn 1, then 9 more messages on various topics, turn 10 response to 'Do you remember my name?' contains 'John'",
        "Test conv-context-preservation passes in test-all-133.js",
        "Summarisation prompt explicitly instructs the model to retain: guest name, booking dates, capsule number, complaint status",
        "Tests conv-long-conversation, conv-coherent-responses, conv-performance-check still pass after the change",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/conversation.ts â€” find the summarisation function; update the summarisation system prompt to include: 'CRITICAL: Preserve all named entities from the conversation: guest name, booking reference, capsule number, complaint details, dates mentioned.'",
        "File: RainbowAI/src/assistant/ai-client.ts â€” verify summarisation is triggered at the correct turn threshold and the summary is included in subsequent context",
        "The fix is a prompt engineering change to the summarisation call, not an architectural change"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-014",
      "title": "Fix sentiment escalation â€” 3 consecutive negative messages should escalate to staff",
      "priority": 10,
      "description": "As a guest who has sent 3 consecutive negative/frustrated messages, I want Rainbow AI to escalate to staff contact automatically, so my distress is handled by a human. Two tests fail: both involve 3 consecutive frustrated/angry messages where turn 2 response is missing escalation keywords (staff, manager, contact, sorry).",
      "acceptanceCriteria": [
        "After 3 consecutive messages with negative sentiment, response contains at least one of: staff, manager, contact, sorry, apologize, escalat",
        "Tests sentiment-frustrated-guest AND sentiment-angry-complaint both pass in test-all-133.js",
        "Escalation does NOT trigger on a single negative message (no false positives) â€” test sentiment-cooldown-period still passes",
        "Test sentiment-consecutive-negative (4-message frustration arc) also passes",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/conversation.ts â€” find consecutiveNegativeCount tracking; ensure it increments per turn when sentiment is negative and triggers escalation at >= 3",
        "File: RainbowAI/src/assistant/message-router.ts â€” check sentiment-triggered escalation routing; ensure it overrides intent routing when consecutive negative threshold hit",
        "File: RainbowAI/src/assistant/data/routing.json â€” verify escalation action is defined for sentiment threshold trigger",
        "The preview/chat endpoint receives history â€” the sentiment tracker must analyse history array to count consecutive negative turns, not just the current message"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-010",
      "title": "Fix multi-turn complaint escalation â€” follow-up message not acknowledged",
      "priority": 11,
      "description": "As a guest whose initial complaint was not resolved, I want Rainbow AI to escalate with increasing urgency on follow-up messages. After 'My room is not clean' + 'Nobody came to fix it', the second response must acknowledge the unresolved complaint with sorry/apologize/staff.",
      "acceptanceCriteria": [
        "After 'My room is not clean' then 'Nobody came to fix it after I reported it', second response contains sorry OR apologize OR staff",
        "After a third escalating message 'I want to speak to a manager!', response mentions manager OR staff OR contact OR escalat",
        "Test mt-complaint-escalation passes all validated turns in test-all-133.js",
        "Sentiment tracker registers increasing negativity across turns and routes appropriately",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/conversation.ts â€” conversation sentiment/intent history tracking; ensure repeat complaint context is passed to message-router",
        "File: RainbowAI/src/assistant/message-router.ts â€” repeat-complaint escalation trigger logic; check if there is a repeat_intent counter that escalates after N same-intent messages",
        "The preview/chat endpoint at RainbowAI/src/routes/admin/testing-preview.ts receives history â€” verify it's passed to the pipeline context",
        "This may be related to US-014 (sentiment escalation) â€” the same mechanism likely covers both"
      ],
      "dependencies": [
        "US-014"
      ],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-011",
      "title": "Fix multi-turn billing dispute â€” resolution path context lost at turn 2",
      "priority": 12,
      "description": "As a guest disputing a billing charge across multiple messages, I want Rainbow AI to maintain the dispute context and confirm refund investigation at each step. After 3 messages (check bill â†’ RM50 extra â†’ want refund), turn 2 response must contain refund/investigate/review/management.",
      "acceptanceCriteria": [
        "Turn 2 response after 'I want to check my bill' + 'There is an extra charge of RM50' + 'I was overcharged and I want a refund' contains at least one of: refund, investigate, review, management, staff",
        "Test mt-billing-dispute passes all validated turns in test-all-133.js",
        "Billing dispute intent is maintained across turns (not reset to different intent at turn 2)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/conversation.ts â€” intent persistence across turns; check if intent from turn 0 is available in context for turn 2",
        "File: RainbowAI/src/assistant/data/routing.json â€” billing_dispute routing for multi-turn context",
        "The preview/chat endpoint receives history â€” verify billing_dispute intent context is carried in history and re-used when turn 2 message is processed",
        "The test sends history = [turn0, turn1] when making turn 2 API call"
      ],
      "dependencies": [],
      "estimatedComplexity": "medium",
      "passes": true
    },
    {
      "id": "US-012",
      "title": "Fix multi-turn check-in info flow â€” topic switching loses lower deck and WiFi answers",
      "priority": 13,
      "description": "As a guest asking multiple check-in questions in sequence, I want correct answers for lower deck preference (turn 2) and WiFi password (turn 3) even within an ongoing check-in conversation. Currently the prior conversation context causes KB loading to miss these topics.",
      "acceptanceCriteria": [
        "In a multi-turn check-in conversation, turn 2 message 'Can I get a lower deck capsule?' returns response with lower OR deck OR even OR C2 OR C4",
        "Turn 3 message 'What is the WiFi password?' returns response with WiFi OR password OR network regardless of prior context",
        "Test mt-checkin-flow passes all validated turns in test-all-133.js",
        "KB loading for capsule layout and WiFi uses the CURRENT message for topic detection, not the session-level intent",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/message-router.ts â€” per-turn intent classification must not be over-anchored to session intent; each message must be independently classified",
        "File: RainbowAI/src/assistant/knowledge-base.ts â€” KB topic loading (guessTopicFiles) should use the current message text, not the session-level intent from previous turns",
        "This may be a simple fix: ensure guessTopicFiles() receives the current message, not the session topic"
      ],
      "dependencies": [
        "US-004"
      ],
      "estimatedComplexity": "medium",
      "passes": false
    },
    {
      "id": "US-008",
      "title": "Fix multi-turn booking workflow â€” context lost after turn 0",
      "priority": 14,
      "description": "As a guest making a booking across multiple messages, I want Rainbow AI to maintain the workflow context (booking â†’ guest count â†’ dates â†’ payment) so I don't repeat myself. Currently after 'I want to make a booking', follow-up messages 'X guests' and 'Check-in date' are not processed within the booking workflow context.",
      "acceptanceCriteria": [
        "After 'I want to make a booking', Rainbow AI asks about guest count or dates",
        "After '2 guests', response asks for check-in/check-out dates (contains date, check-in, or check-out)",
        "After 'Check-in 15 Feb, check-out 17 Feb', response references payment (contains payment, receipt, or paid)",
        "Test workflow-booking-payment-full passes all validated turns in test-all-133.js",
        "Verify full booking workflow end-to-end in Chat Simulator (Live Simulation tab)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/workflow-executor.ts â€” verify that conversation history is passed into workflow step evaluation; workflow must know which step it's on based on history",
        "File: RainbowAI/src/routes/admin/testing-preview.ts â€” verify the history array from the request body is forwarded into the pipeline context and workflow executor",
        "File: RainbowAI/src/assistant/conversation.ts â€” check if workflow state is persisted in conversation context between API calls",
        "The preview/chat endpoint is stateless per request â€” the workflow step state must be inferred from the history array, not from server-side session"
      ],
      "dependencies": [],
      "estimatedComplexity": "large",
      "passes": false
    },
    {
      "id": "US-009",
      "title": "Fix multi-turn check-in workflow â€” step context lost mid-workflow",
      "priority": 15,
      "description": "As a guest going through the check-in process across multiple messages, I want Rainbow AI to guide me step-by-step (name â†’ passport â†’ dates â†’ capsule assignment) without losing track of earlier steps. Currently turns 1, 2, 3, 5 all fail because the workflow loses step context after turn 0.",
      "acceptanceCriteria": [
        "After 'I want to check in', response asks for name or documents (contains name, passport, or IC)",
        "After 'My name is John Smith', response asks to upload photo/passport (contains photo, upload, or passport)",
        "After '[Passport photo uploaded]', response asks for check-in date (contains check-in or date)",
        "After all required info is provided, response confirms capsule or forwards to admin (contains available, capsule, admin, or forward)",
        "Test workflow-checkin-full passes all validated turns in test-all-133.js",
        "Verify full check-in workflow end-to-end in Chat Simulator (Live Simulation tab)",
        "TypeScript compiles with zero errors"
      ],
      "technicalNotes": [
        "File: RainbowAI/src/assistant/workflow-executor.ts â€” check-in workflow step definitions; each step must advance based on history analysis",
        "File: RainbowAI/src/assistant/conversation.ts â€” conversation history management between workflow steps",
        "This is related to US-008 (same root cause: workflow state not inferred from history); implement US-008 first and this fix may be partially covered",
        "The check-in workflow has more steps than booking â€” verify each step's trigger condition in workflows.json"
      ],
      "dependencies": [
        "US-008"
      ],
      "estimatedComplexity": "large",
      "passes": false
    }
  ]
}